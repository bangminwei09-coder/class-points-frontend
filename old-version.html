<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
  <!-- SheetJSåº“ ç”¨äºExcelå¯¼å‡º -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    /* ==================== è®¾è®¡ç³»ç»Ÿ ==================== */
    :root {
      /* é¢œè‰²ç³»ç»Ÿ */
      --gold: #d4af37;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --muted: #667085;
      --text: #1f2937;
      --primary: #2563eb;
      --primary-2: #7c3aed;
      --ring: #c7d2fe;
      --success: #16a34a;
      --danger: #e11d48;
      --warning: #f59e0b;
      
      /* å¸ƒå±€ */
      --radius: 14px;
      --shadow: 0 6px 24px rgba(16,24,40,.08), 0 2px 8px rgba(16,24,40,.06);
      --border: #e5e7eb;
      --soft: #f8fafc;
    }

    /* ==================== åŸºç¡€é‡ç½® ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* ==================== å¸ƒå±€ ==================== */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
      color: white;
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 120;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .grid {
      display: grid;
      grid-template-columns: 280px 1fr 360px;
      gap: 16px;
      margin-top: 16px;
    }

    @media(max-width: 1100px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      #rankPane {
        max-height: 500px !important;
      }
    }

    /* ==================== ç»„ä»¶æ ·å¼ ==================== */
    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: .15s box-shadow, .15s transform;
      box-shadow: 0 1px 2px rgba(16,24,40,.06);
      font-size: 14px;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(16,24,40,.1);
    }

    .btn.primary {
      background: linear-gradient(90deg, #2563eb, #7c3aed);
      border: none;
      color: #fff;
    }

    .btn.warn {
      background: linear-gradient(90deg, #e11d48, #fb7185);
      border: none;
      color: #fff;
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
    }

    .btn.ghost:hover {
      background: rgba(255,255,255,0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn.active {
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: white;
      border-color: var(--primary);
    }

    /* æ–°å¢ï¼šåŠ åˆ†å‡åˆ†æŒ‰é’®æ ·å¼ */
    .btn-add {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-subtract {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-text {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-text:hover {
      color: var(--primary);
      transform: none;
      box-shadow: none;
    }

    input, select, textarea {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
    }

    /* ==================== ä¸‹æ‹‰é€‰æ‹©å™¨ä¼˜åŒ– ==================== */
    select {
      background: white;
      cursor: pointer;
      font-weight: 500;
    }

    select option {
      padding: 10px;
      background: #f8fafc;
      color: #1e293b;
      font-weight: 500;
      border-bottom: 1px solid #e2e8f0;
    }

    select option:checked,
    select option:hover {
      background: linear-gradient(90deg, #ddd6fe, #e0e7ff);
      color: #5b21b6;
      font-weight: 600;
    }

    /* ä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ */
    select#themeSel {
      background: rgba(255,255,255,0.2);
      color: white;
      border-color: rgba(255,255,255,0.3);
      font-weight: 600;
    }

    select#themeSel option {
      background: #f8fafc;
      color: #1e293b;
      padding: 12px 16px;
      font-weight: 600;
    }

    select#themeSel option[value="default"] {
      background: #dbeafe;
      color: #1e40af;
    }

    select#themeSel option[value="dark"] {
      background: #334155;
      color: white;
    }

    select#themeSel option[value="green"] {
      background: #d1fae5;
      color: #065f46;
    }

    select#themeSel option[value="purple"] {
      background: #e9d5ff;
      color: #6b21a8;
    }

    select#themeSel option[value="orange"] {
      background: #fed7aa;
      color: #9a3412;
    }

    select#themeSel option[value="pink"] {
      background: #fce7f3;
      color: #9f1239;
    }

    select#themeSel option[value="blue"] {
      background: #e0f2fe;
      color: #075985;
    }

    select#themeSel option[value="brown"] {
      background: #fef3c7;
      color: #78350f;
    }

    /* ç­çº§é€‰æ‹©å™¨æ ·å¼ */
    select#classSel {
      background: white;
      border: 2px solid #3b82f6;
      font-weight: 600;
      color: #1e40af;
    }

    select#classSel option {
      background: #eff6ff;
      color: #1e40af;
      padding: 12px 16px;
      border-bottom: 1px solid #bfdbfe;
      font-weight: 600;
    }

    select#classSel option:checked {
      background: #1e40af;
      color: white;
      font-weight: 700;
    }
    
    select#classSel option:hover {
      background: #bfdbfe;
      color: #1e3a8a;
    }

    /* æ’è¡Œæ¦œç±»å‹é€‰æ‹©å™¨æ ·å¼ */
    select#rankTypeSel option {
      background: #f8fafc;
      color: #1e293b;
      padding: 10px 16px;
      font-weight: 600;
    }

    select#rankTypeSel option[value="total"] {
      background: #fef3c7;
      color: #92400e;
      font-weight: 700;
    }

    select#rankTypeSel option[value="day"] {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 700;
    }

    select#rankTypeSel option[value="week"] {
      background: #dcfce7;
      color: #166534;
      font-weight: 700;
    }

    select#rankTypeSel option[value="month"] {
      background: #fae8ff;
      color: #86198f;
      font-weight: 700;
    }

    select#rankTypeSel option[value="year"] {
      background: #ffe4e6;
      color: #be123c;
      font-weight: 700;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(16,24,40,.06);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      position: relative;
      transition: transform .12s ease, box-shadow .12s ease;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(2,6,23,.10);
    }

    .panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .panel h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    /* ==================== å­¦ç”Ÿå¡ç‰‡ ==================== */
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      padding: 3px;
      box-sizing: content-box;
      border: 3px solid transparent;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    
    .avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .avatar img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 50%;
      display: block;
      background: #f5f5f5;
    }

    .name {
      font-size: 15px;
      font-weight: 600;
      text-align: center;
      color: var(--text);
      margin: 8px 0 4px 0;
    }

    .pts {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin: 4px 0;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      width: 100%;
      justify-content: center;
      margin: 12px 0 8px 0;
    }

    .card-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin: 8px 0;
      padding: 8px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .card-bottom {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 8px;
    }

    .card-stats {
      font-size: 12px;
      color: var(--muted);
      text-align: left;
      width: 100%;
      padding: 8px 12px;
      background: var(--soft);
      border-radius: 8px;
      margin-top: 8px;
    }

    .card-stats div {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }

    .check {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* ==================== æ®µä½ç³»ç»Ÿæ ·å¼ ==================== */
    .rank-tier {
      font-size: 13px;
      margin: 4px 0;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .rank-progress {
      width: 100%;
      margin: 8px 0;
      font-size: 11px;
    }

    .progress-bar-container {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .progress-bar {
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
      box-shadow: 0 0 8px rgba(255,255,255,0.5);
    }

    .progress-text {
      text-align: center;
      color: var(--muted);
      font-size: 10px;
    }

    .rank-tier-small {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ==================== è§„åˆ™ç­›é€‰æŒ‰é’®æ ·å¼ ==================== */
    .rule-filter-btn {
      position: relative;
      overflow: hidden;
    }
    
    .rule-filter-btn:hover {
      border-color: var(--primary) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .rule-filter-btn.active {
      background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
      color: white !important;
      border-color: #2563eb !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ==================== è§„åˆ™é€‰æ‹©å¡ç‰‡æ ·å¼ ==================== */
    .rule-select-card:hover {
      border-color: var(--primary) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15) !important;
    }

    .rule-select-card:has(.rule-check:checked) {
      border-color: var(--primary) !important;
      background: linear-gradient(135deg, #eff6ff, #dbeafe) !important;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25) !important;
    }

    /* ==================== æ’è¡Œæ¦œ ==================== */
    #rankPane {
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 80px - 12px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #rankPane .panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 0;
      overflow: hidden;
    }

    #rankPane .panel h2 {
      margin: 0;
      padding: 16px 20px;
      background: linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #f59e0b 100%);
      color: white;
      border-radius: var(--radius) var(--radius) 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
    }

    .rank-tabs {
      display: none; /* æš‚æ—¶éšè—å¤šä¸ªtabæŒ‰é’®ï¼Œåªä¿ç•™æ€»æ¦œ/æ—¥æ¦œç­‰åˆ‡æ¢ */
    }

    #rankList {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px 12px 12px;
      background: white;
    }

    .rank-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 8px;
      margin-bottom: 4px;
      background: white;
      border-radius: 10px;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .rank-item:hover {
      background: #faf5ff;
      border-color: #e9d5ff;
      transform: translateX(2px);
    }

    .rank-item .num {
      font-size: 14px;
      font-weight: 700;
      min-width: 28px;
      text-align: left;
      color: #a855f7;
    }

    .rank-item:nth-child(1) .num {
      color: #f59e0b;
      font-size: 15px;
    }

    .rank-item:nth-child(2) .num {
      color: #ec4899;
      font-size: 15px;
    }

    .rank-item:nth-child(3) .num {
      color: #8b5cf6;
      font-size: 15px;
    }

    .rank-item .avatar {
      width: 36px;
      height: 36px;
      padding: 2px;
      flex-shrink: 0;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .rank-item .avatar img {
      width: 36px;
      height: 36px;
    }

    .rank-item .name {
      flex: 1;
      text-align: left;
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rank-item .pts {
      font-size: 15px;
      font-weight: 700;
      color: #f59e0b;
      flex-shrink: 0;
    }

    .rank-item .delta {
      min-width: 18px;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .delta.up { color: #10b981; }
    .delta.down { color: #ef4444; }
    .delta.same { color: #9ca3af; }

    .delta.up::before { content: 'â†‘'; }
    .delta.down::before { content: 'â†“'; }
    .delta.same::before { content: 'âˆ’'; font-size: 12px; }

    /* æ’è¡Œæ¦œæ¨¡å¼åˆ‡æ¢æŒ‰é’® */
    .rank-mode-btn:hover {
      background: var(--soft);
      border-color: var(--primary);
    }

    .rank-mode-btn.active {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
      border-color: #a855f7;
    }

    /* ==================== å¯¼èˆªé¢æ¿ ==================== */
    .nav-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .nav-btn:hover {
      background: var(--soft);
      border-color: var(--primary);
    }

    .nav-btn.active {
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: white;
      border-color: var(--primary);
    }

    /* ==================== å¼¹çª— ==================== */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2,6,23,.45);
      z-index: 200;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-card {
      width: 860px;
      max-width: 100%;
      max-height: 90vh;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 24px 80px rgba(2,6,23,.35);
      padding: 24px;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ==================== Toast ==================== */
    #toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 300;
      display: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    /* ==================== å·¥å…·æ ·å¼ ==================== */
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .subtle {
      color: var(--muted);
      font-size: 13px;
    }

    .mt8 { margin-top: 8px; }
    .mt16 { margin-top: 16px; }
    .mb8 { margin-bottom: 8px; }
    .mb16 { margin-bottom: 16px; }

    .text-center { text-align: center; }

    /* ==================== ç©ºçŠ¶æ€ ==================== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 20px;
    }

    /* ==================== å­—æ¯é”®ç›˜ ==================== */
    .key-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .key-btn:hover {
      background: var(--soft);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .key-btn.active {
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: white;
      border-color: var(--primary);
    }

    .key-btn.clear-btn {
      width: auto;
      padding: 0 16px;
      background: linear-gradient(90deg, var(--danger), #fb7185);
      color: white;
      border: none;
    }

    /* ==================== ä¸»é¢˜ç³»ç»Ÿ ==================== */
    /* æš—é»‘ä¸»é¢˜ */
    body.theme-dark {
      --bg: #1a1a2e;
      --surface: #16213e;
      --text: #e4e4e7;
      --muted: #94a3b8;
      --border: #334155;
      --soft: #1e293b;
      --primary: #3b82f6;
      --primary-2: #a855f7;
    }

    body.theme-dark .header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    body.theme-dark .card {
      background: var(--surface);
      border-color: var(--border);
    }

    body.theme-dark .panel {
      background: var(--surface);
      border-color: var(--border);
    }

    body.theme-dark input, 
    body.theme-dark select, 
    body.theme-dark textarea {
      background: var(--soft);
      border-color: var(--border);
      color: var(--text);
    }

    body.theme-dark .btn {
      background: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }

    /* æ¸…æ–°ç»¿ä¸»é¢˜ */
    body.theme-green {
      --bg: #ecfdf5;
      --surface: #ffffff;
      --primary: #34d399;
      --primary-2: #10b981;
      --text: #064e3b;
      --border: #a7f3d0;
    }

    body.theme-green .header {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    /* ä¼˜é›…ç´«ä¸»é¢˜ */
    body.theme-purple {
      --bg: #faf5ff;
      --surface: #ffffff;
      --primary: #a855f7;
      --primary-2: #9333ea;
      --text: #581c87;
      --border: #e9d5ff;
    }

    body.theme-purple .header {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
    }

    /* æ´»åŠ›æ©™ä¸»é¢˜ */
    body.theme-orange {
      --bg: #fff7ed;
      --surface: #ffffff;
      --primary: #f97316;
      --primary-2: #ea580c;
      --text: #7c2d12;
      --border: #fed7aa;
    }

    body.theme-orange .header {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }

    /* ç”œç¾ç²‰ä¸»é¢˜ */
    body.theme-pink {
      --bg: #fdf2f8;
      --surface: #ffffff;
      --primary: #ec4899;
      --primary-2: #db2777;
      --text: #831843;
      --border: #fbcfe8;
    }

    body.theme-pink .header {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }

    /* å¤©ç©ºè“ä¸»é¢˜ */
    body.theme-blue {
      --bg: #f0f9ff;
      --surface: #ffffff;
      --primary: #0ea5e9;
      --primary-2: #0284c7;
      --text: #075985;
      --border: #bae6fd;
    }

    body.theme-blue .header {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }

    /* å’–å•¡æ£•ä¸»é¢˜ */
    body.theme-brown {
      --bg: #fef3c7;
      --surface: #ffffff;
      --primary: #92400e;
      --primary-2: #78350f;
      --text: #451a03;
      --border: #fde68a;
    }

    body.theme-brown .header {
      background: linear-gradient(135deg, #92400e 0%, #78350f 100%);
    }

    /* ==================== å“åº”å¼è®¾è®¡ ==================== */
    @media(max-width: 900px) {
      #ruleList {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      /* æ¨¡æ€æ¡†å†…çš„è§„åˆ™é€‰æ‹©ç½‘æ ¼ */
      .modal-body div[style*="grid-template-columns: repeat(3, 1fr)"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    
    @media(max-width: 600px) {
      #ruleList {
        grid-template-columns: 1fr !important;
      }
      
      /* æ¨¡æ€æ¡†å†…çš„è§„åˆ™é€‰æ‹©ç½‘æ ¼ */
      .modal-body div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="header">
    <div class="container">
      <div class="header-content">
        <h1>ğŸ“ ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="header-actions">
          <select id="classSel" class="btn ghost">
            <option value="">é€‰æ‹©ç­çº§</option>
          </select>
          <button id="addClassBtn" class="btn ghost">+ æ–°å¢ç­çº§</button>
          <button id="deleteClassBtn" class="btn ghost">åˆ é™¤ç­çº§</button>
          <button id="exportDataBtn" class="btn ghost">ğŸ“¤ å¯¼å‡ºJSON</button>
          <button id="exportExcelBtn" class="btn ghost">ğŸ“Š å¯¼å‡ºExcel</button>
          <button id="exportDetailBtn" class="btn ghost">ğŸ“‘ å¯¼å‡ºç§¯åˆ†æ˜ç»†</button>
          <button id="importDataBtn" class="btn ghost">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
          <div style="display: flex; align-items: center; gap: 6px;">
            <button id="backupSettingsBtn" class="btn ghost" title="è®¾ç½®è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶å¤¹">ğŸ’¾ å¤‡ä»½è®¾ç½®</button>
            <span id="backupInlineWarning" style="display: none; color: #ef4444; font-size: 12px; font-weight: 600;">æœªè®¾ç½®è‡ªåŠ¨å¤‡ä»½</span>
          </div>
          <select id="themeSel" class="btn ghost">
            <option value="default">é»˜è®¤ä¸»é¢˜</option>
            <option value="dark">æš—é»‘ä¸»é¢˜</option>
            <option value="green">æ¸…æ–°ç»¿</option>
            <option value="purple">ä¼˜é›…ç´«</option>
            <option value="orange">æ´»åŠ›æ©™</option>
            <option value="pink">ç”œç¾ç²‰</option>
            <option value="blue">å¤©ç©ºè“</option>
            <option value="brown">å’–å•¡æ£•</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="container">
    <div class="grid">
      <!-- å·¦ä¾§å¯¼èˆª -->
      <div>
        <div class="panel">
          <h2>ğŸ“‹ å¯¼èˆªèœå•</h2>
          <div class="nav-panel">
            <button class="nav-btn active" data-view="students">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç®¡ç†</button>
            <button class="nav-btn" data-view="groups">ğŸ‘¥ å°ç»„ç®¡ç†</button>
            <button class="nav-btn" data-view="rules">ğŸ“ ç§¯åˆ†è§„åˆ™</button>
            <button class="nav-btn" data-view="mall">ğŸ›’ ç§¯åˆ†å•†åŸ</button>
            <button class="nav-btn" data-view="randomcall">ğŸ² éšæœºç‚¹å</button>
            <button class="nav-btn" data-view="timer">â±ï¸ è®¡æ—¶å™¨</button>
            <button class="nav-btn" data-view="history">ğŸ“Š å†å²è®°å½•</button>
            <button class="nav-btn" data-view="settings">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
          </div>
        </div>

        <div class="panel mt16">
          <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
          <div class="row">
            <button id="fastPlus1" class="btn primary">æ‰¹é‡åŠ åˆ†</button>
            <button id="fastMinus1" class="btn warn">æ‰¹é‡å‡åˆ†</button>
          </div>
          <div class="row mt8">
            <button id="allClassPlus" class="btn" style="background: var(--success); color: white;">â• å…¨ç­åŠ åˆ†</button>
            <button id="allClassMinus" class="btn" style="background: var(--danger); color: white;">â– å…¨ç­å‡åˆ†</button>
          </div>
          <button id="customAdjust" class="btn mt8" style="width:100%">è‡ªå®šä¹‰è°ƒæ•´</button>
        </div>
      </div>

      <!-- ä¸­é—´å†…å®¹åŒº -->
      <div>
        <div class="panel">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h2 id="contentTitle">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç®¡ç†</h2>
            <div class="row">
              <button id="addStudentBtn" class="btn primary">+ æ·»åŠ å­¦ç”Ÿ</button>
              <button id="batchAddBtn" class="btn">æ‰¹é‡æ·»åŠ </button>
              <button id="importStudentsTxt" class="btn" title="TXTæ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªå­¦ç”Ÿï¼Œæ ¼å¼ä¸º å§“å å°ç»„å">ğŸ“„ å¯¼å…¥TXT</button>
              <button id="importStudentsExcel" class="btn" title="Excelæ ¼å¼ï¼šç¬¬1åˆ—å§“åï¼Œç¬¬2åˆ—å°ç»„ï¼Œç¬¬3åˆ—ç§¯åˆ†">ğŸ“Š å¯¼å…¥Excel</button>
            </div>
          </div>
          <div class="subtle" style="margin-bottom: 12px; font-size: 12px;">
            ğŸ’¡ å¯¼å…¥æ ¼å¼ï¼šTXTæ ¼å¼æ¯è¡Œ"å§“å å°ç»„"ï¼ŒExcelæ ¼å¼åˆ—ä¸º"å§“å|å°ç»„|ç§¯åˆ†"ï¼ˆé¦–è¡Œè·³è¿‡ï¼‰
          </div>
          
          <div id="mainContent">
            <!-- å­¦ç”Ÿè§†å›¾ -->
            <div id="studentsView">
              <!-- å­¦ç”Ÿäººæ•°ç»Ÿè®¡ -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 12px; border: 2px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 24px;">ğŸ‘¥</div>
                  <div>
                    <div style="font-size: 13px; color: #1e40af; font-weight: 600;">å½“å‰å­¦ç”Ÿæ€»æ•°</div>
                    <div style="font-size: 28px; font-weight: 700; color: #1e40af; line-height: 1;" id="studentCountDisplay">0</div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                <button id="selectAllBtn" class="btn" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #bfdbfe; background: white; color: #1e40af; font-weight: 600;" onclick="toggleSelectAll()">å…¨é€‰</button>
                  <div style="text-align: center; padding: 8px 16px; background: white; border-radius: 8px; border: 1px solid #bfdbfe;">
                    <div style="font-size: 11px; color: #64748b;">é€‰ä¸­å­¦ç”Ÿ</div>
                    <div style="font-size: 18px; font-weight: 700; color: #3b82f6;" id="selectedCountDisplay">0</div>
                  </div>
                </div>
              </div>
              
              <div style="margin-bottom: 16px;">
                <input type="text" id="studentSearch" placeholder="æœç´¢å­¦ç”Ÿï¼ˆæ”¯æŒå§“åã€æ‹¼éŸ³ã€é¦–å­—æ¯ï¼‰..." style="width: 100%; margin-bottom: 12px;">
                <div id="alphabetKeyboard" style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">
                  <!-- å­—æ¯é”®ç›˜å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
              <div class="student-grid" id="studentGrid">
                <!-- å­¦ç”Ÿå¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>

            <!-- å°ç»„è§†å›¾ -->
            <div id="groupsView" style="display: none;">
              <div style="margin-bottom: 16px;">
                <input type="text" id="newGroupName" placeholder="è¾“å…¥å°ç»„åç§°" style="width: auto; display: inline-block; margin-right: 8px;">
                <button onclick="createGroup()" class="btn primary">åˆ›å»ºå°ç»„</button>
                <button id="importGroupsBtn" class="btn" title="ä»Excelå¯¼å…¥å°ç»„æ•°æ®">ğŸ“¥ å¯¼å…¥å°ç»„</button>
                <button id="exportGroupsBtn" class="btn" title="å¯¼å‡ºæ‰€æœ‰å°ç»„æ•°æ®åˆ°Excel">ğŸ“¤ å¯¼å‡ºå°ç»„</button>
              </div>
              <div class="subtle" style="margin-bottom: 12px; font-size: 12px;">
                ğŸ’¡ å¯¼å…¥æ ¼å¼ï¼šExcelæ ¼å¼åˆ—ä¸º"å°ç»„åç§°|æˆå‘˜å§“å1,æˆå‘˜å§“å2,æˆå‘˜å§“å3"ï¼ˆé¦–è¡Œè·³è¿‡ï¼Œå¤šä¸ªæˆå‘˜ç”¨é€—å·åˆ†éš”ï¼‰
              </div>
              <div id="groupList"></div>
            </div>

            <!-- è§„åˆ™è§†å›¾ -->
            <div id="rulesView" style="display: none;">
              <div style="margin-bottom: 16px;">
                <input type="text" id="newRuleName" placeholder="è§„åˆ™åç§°" style="width: 200px; margin-right: 8px;">
                <input type="number" id="newRulePoints" placeholder="åˆ†å€¼" style="width: 100px; margin-right: 8px;">
                <button onclick="createRule()" class="btn primary">æ·»åŠ è§„åˆ™</button>
                <button id="importRulesTxt" class="btn" title="TXTæ ¼å¼ï¼šæ¯è¡Œä¸€æ¡è§„åˆ™ï¼Œæ ¼å¼ä¸º è§„åˆ™åç§° åˆ†å€¼">ğŸ“„ å¯¼å…¥TXT</button>
                <button id="importRulesExcel" class="btn" title="Excelæ ¼å¼ï¼šç¬¬1åˆ—è§„åˆ™åç§°ï¼Œç¬¬2åˆ—åˆ†å€¼ï¼Œç¬¬3åˆ—æè¿°">ğŸ“Š å¯¼å…¥Excel</button>
                <button id="exportRulesBtn" class="btn" title="å¯¼å‡ºæ‰€æœ‰ç§¯åˆ†è§„åˆ™åˆ°Excel">ğŸ“¤ å¯¼å‡ºè§„åˆ™</button>
              </div>
              <div class="subtle" style="margin-bottom: 12px; font-size: 12px;">
                ğŸ’¡ å¯¼å…¥æ ¼å¼ï¼šTXTæ ¼å¼æ¯è¡Œ"è§„åˆ™å åˆ†å€¼"ï¼ˆæ­£æ•°åŠ åˆ†ï¼Œè´Ÿæ•°å‡åˆ†ï¼‰ï¼ŒExcelæ ¼å¼åˆ—ä¸º"è§„åˆ™å|åˆ†å€¼|æè¿°"ï¼ˆé¦–è¡Œè·³è¿‡ï¼‰
              </div>
              
              <!-- è§„åˆ™ç­›é€‰æŒ‰é’® -->
              <div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 12px; background: var(--soft); border-radius: 12px;">
                <button class="rule-filter-btn active" data-filter="all" onclick="filterRules('all')" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                  ğŸ“‹ å…¨éƒ¨è§„åˆ™
                </button>
                <button class="rule-filter-btn" data-filter="add" onclick="filterRules('add')" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                  â• åŠ åˆ†è§„åˆ™
                </button>
                <button class="rule-filter-btn" data-filter="subtract" onclick="filterRules('subtract')" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                  â– å‡åˆ†è§„åˆ™
                </button>
              </div>
              
              <div id="ruleList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;"></div>
            </div>

            <!-- å†å²è§†å›¾ -->
            <div id="historyView" style="display: none;">
              <div id="historyList"></div>
            </div>

            <!-- å•†åŸè§†å›¾ -->
            <div id="mallView" style="display: none;">
              <div style="margin-bottom: 16px;">
                <button onclick="openAddMallItem()" class="btn primary">+ æ·»åŠ å•†å“</button>
                <button id="importMallBtn" class="btn" title="ä»Excelå¯¼å…¥å•†åŸå•†å“">ğŸ“¥ å¯¼å…¥å•†å“</button>
                <button id="exportMallBtn" class="btn" title="å¯¼å‡ºæ‰€æœ‰å•†åŸå•†å“åˆ°Excel">ğŸ“¤ å¯¼å‡ºå•†å“</button>
              </div>
              <div class="subtle" style="margin-bottom: 12px; font-size: 12px;">
                ğŸ’¡ å¯¼å…¥æ ¼å¼ï¼šExcelæ ¼å¼åˆ—ä¸º"å•†å“åç§°|ä»·æ ¼|åº“å­˜|æè¿°"ï¼ˆé¦–è¡Œè·³è¿‡ï¼Œåº“å­˜ä¸º-1è¡¨ç¤ºæ— é™ï¼‰
              </div>
              <div id="mallGrid" class="student-grid"></div>
            </div>

            <!-- éšæœºç‚¹åè§†å›¾ -->
            <div id="randomcallView" style="display: none;">
              <div style="margin-bottom: 24px;">
                <div class="row" style="flex-wrap: wrap; gap: 12px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <span>æŠ½å–äººæ•°ï¼š</span>
                    <input type="number" id="rcCount" value="1" min="1" max="50" style="width: 80px; padding: 8px; border: 2px solid var(--border); border-radius: 8px;">
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="rcExclude" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>æ’é™¤å·²æŠ½</span>
                  </label>
                  <button id="rcStartBtn" onclick="startRandomCall()" class="btn primary" style="margin-left: auto; padding: 12px 32px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                    ğŸš€ å¼€å§‹æŠ½å–
                  </button>
                  <button onclick="clearRcCalled()" class="btn" style="padding: 12px 24px;">æ¸…é™¤è®°å½•</button>
                </div>
              </div>
              
              <!-- 3Dæ—‹è½¬æ˜Ÿçƒå®¹å™¨ -->
              <div id="rc3DContainer" style="position: relative; width: 100%; min-height: 600px; display: flex; align-items: center; justify-content: center; perspective: 2000px; overflow: hidden; background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 20, 0.9) 100%); border-radius: 24px; margin-bottom: 24px;">
                <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
                <canvas id="rcStarCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.8;"></canvas>
                
                <!-- 3Dæ˜Ÿçƒå®¹å™¨ -->
                <div id="rcPlanetContainer" style="position: relative; width: 600px; height: 600px; transform-style: preserve-3d;">
                  <!-- æ˜Ÿçƒçƒä½“ -->
                  <div id="rcPlanetSphere" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transform: rotateX(-20deg);">
                    <!-- å­¦ç”Ÿåå­—å°†åŠ¨æ€åˆ†å¸ƒåœ¨è¿™é‡Œ -->
                    <div id="rcPlanetNames" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d;"></div>
                    
                    <!-- æ˜Ÿçƒç½‘æ ¼çº¿ -->
                    <div class="rc-planet-grid" style="position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(102, 126, 234, 0.3); box-shadow: 0 0 60px rgba(102, 126, 234, 0.5), inset 0 0 60px rgba(102, 126, 234, 0.2);"></div>
                    
                    <!-- é€‰ä¸­é«˜äº®åŒºåŸŸ -->
                    <div id="rcSelectedHighlight" style="position: absolute; width: 120px; height: 60px; top: 50%; left: 50%; transform: translate(-50%, -50%) translateZ(300px); background: radial-gradient(ellipse, rgba(255, 255, 255, 0.3) 0%, transparent 70%); border-radius: 50%; opacity: 0; transition: opacity 0.3s; pointer-events: none; box-shadow: 0 0 40px rgba(255, 255, 255, 0.5);"></div>
              </div>
                  
                  <!-- ä¸­å¿ƒæ˜¾ç¤ºåŒºåŸŸ -->
                  <div id="rcCenterDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) translateZ(350px); width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 50%; backdrop-filter: blur(20px); border: 3px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 80px rgba(102, 126, 234, 0.8), inset 0 0 60px rgba(118, 75, 162, 0.3); z-index: 100;">
                    <div id="rcNameDisplay" style="font-size: 42px; font-weight: 700; color: #fff; text-shadow: 0 0 30px rgba(255, 255, 255, 0.9), 0 0 60px rgba(102, 126, 234, 0.8); text-align: center; line-height: 1.2; padding: 20px;">
                      <div class="rc-pulse-text">ç‚¹å‡»å¼€å§‹æŠ½å–</div>
                    </div>
                  </div>
                </div>
                
                <!-- æŠ½å–ç»“æœåˆ—è¡¨ -->
                <div id="rcResultList" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; max-width: 90%; z-index: 10;"></div>
              </div>
              
              <!-- æŠ½å–å†å² -->
              <div id="rcHistory" class="mt16"></div>
            </div>
            
            <style>
              @keyframes rcPulse {
                0%, 100% { 
                  transform: scale(1);
                  opacity: 1;
                }
                50% { 
                  transform: scale(1.05);
                  opacity: 0.9;
                }
              }
              
              @keyframes rcPlanetRotate {
                from { transform: rotateX(-20deg) rotateY(0deg); }
                to { transform: rotateX(-20deg) rotateY(360deg); }
              }
              
              @keyframes rcNameGlow {
                0%, 100% { 
                  text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
                  transform: scale(1);
                }
                50% { 
                  text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
                  transform: scale(1.1);
                }
              }
              
              @keyframes rcSelectedPulse {
                0%, 100% { 
                  opacity: 0.6;
                  transform: translate(-50%, -50%) translateZ(300px) scale(1);
                }
                50% { 
                  opacity: 1;
                  transform: translate(-50%, -50%) translateZ(300px) scale(1.2);
                }
              }
              
              .rc-pulse-text {
                animation: rcPulse 2s ease-in-out infinite;
              }
              
              .rc-planet-name {
                position: absolute;
                font-size: 18px;
                font-weight: 600;
                color: #fff;
                text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
                white-space: nowrap;
                cursor: pointer;
                transition: all 0.3s ease;
                transform-style: preserve-3d;
              }
              
              .rc-planet-name:hover {
                transform: scale(1.3) !important;
                z-index: 10;
                text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
              }
              
              .rc-planet-name.selected {
                animation: rcNameGlow 1s ease-in-out infinite;
                font-size: 24px;
                z-index: 20;
              }
              
              .rc-planet-grid {
                background: 
                  radial-gradient(circle at 30% 30%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 70%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
              }
              
              #rcPlanetSphere.rc-rotating {
                animation: rcPlanetRotate 20s linear infinite;
              }
              
              #rcPlanetSphere.rc-fast-rotating {
                animation: rcPlanetRotate 0.5s linear infinite;
              }
              
              #rcSelectedHighlight.active {
                opacity: 1;
                animation: rcSelectedPulse 1s ease-in-out infinite;
              }
              
              .rc-result-item {
                padding: 18px 36px;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
                color: white;
                border-radius: 20px;
                font-size: 26px;
                font-weight: 700;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5), 0 0 30px rgba(255, 255, 255, 0.4);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.3);
                animation: rcPulse 1.5s ease-in-out infinite;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
              }
            </style>
            
            <style>
              @keyframes pulse {
                0%, 100% { 
                  opacity: 1;
                  transform: scale(1);
                }
                50% { 
                  opacity: 0.7;
                  transform: scale(1.05);
                }
              }
              
              .timer-wheel-input {
                transition: all 0.2s ease;
                user-select: none;
              }
              
              .timer-wheel-input:hover {
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                background: #f8fafc;
              }
              
              .timer-wheel-input:focus {
                outline: none;
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
                background: white;
              }
              
              .timer-wheel-input::-webkit-inner-spin-button,
              .timer-wheel-input::-webkit-outer-spin-button {
                opacity: 1;
                height: 20px;
              }
            </style>

            <!-- è®¡æ—¶å™¨è§†å›¾ -->
            <div id="timerView" style="display: none;">
              <div style="text-align: center; padding: 40px 20px;">
                <!-- è®¡æ—¶å™¨æ˜¾ç¤º -->
                <div id="timerDisplay" style="font-size: 120px; font-weight: 700; color: #2563eb; margin-bottom: 40px; font-family: 'Courier New', monospace; text-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);">
                  00:00:00
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 40px; flex-wrap: wrap;">
                  <button id="timerStartBtn" onclick="timerStart()" class="btn primary" style="padding: 16px 48px; font-size: 18px; font-weight: 600; min-width: 120px;">
                    â–¶ï¸ å¼€å§‹
                  </button>
                  <button id="timerPauseBtn" onclick="timerPause()" class="btn" style="padding: 16px 48px; font-size: 18px; font-weight: 600; min-width: 120px; display: none;">
                    â¸ï¸ æš‚åœ
                  </button>
                  <button id="timerResumeBtn" onclick="timerResume()" class="btn primary" style="padding: 16px 48px; font-size: 18px; font-weight: 600; min-width: 120px; display: none;">
                    â–¶ï¸ ç»§ç»­
                  </button>
                  <button onclick="timerReset()" class="btn" style="padding: 16px 48px; font-size: 18px; font-weight: 600; min-width: 120px;">
                    ğŸ”„ é‡ç½®
                  </button>
                </div>
                
                <!-- å¿«é€Ÿè®¾ç½® -->
                <div style="background: var(--soft); padding: 24px; border-radius: 16px; margin-bottom: 24px;">
                  <h3 style="margin-bottom: 16px; color: var(--text); font-size: 18px;">â±ï¸ å¿«é€Ÿè®¾ç½®</h3>
                  <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="timerSetTime(60)" class="btn" style="padding: 10px 20px;">1åˆ†é’Ÿ</button>
                    <button onclick="timerSetTime(300)" class="btn" style="padding: 10px 20px;">5åˆ†é’Ÿ</button>
                    <button onclick="timerSetTime(600)" class="btn" style="padding: 10px 20px;">10åˆ†é’Ÿ</button>
                    <button onclick="timerSetTime(900)" class="btn" style="padding: 10px 20px;">15åˆ†é’Ÿ</button>
                    <button onclick="timerSetTime(1800)" class="btn" style="padding: 10px 20px;">30åˆ†é’Ÿ</button>
                    <button onclick="timerSetTime(3600)" class="btn" style="padding: 10px 20px;">1å°æ—¶</button>
                  </div>
                </div>
                
                <!-- è‡ªå®šä¹‰æ—¶é—´è®¾ç½® -->
                <div style="background: var(--soft); padding: 24px; border-radius: 16px;">
                  <h3 style="margin-bottom: 16px; color: var(--text); font-size: 18px;">â° è‡ªå®šä¹‰æ—¶é—´ï¼ˆé¼ æ ‡æ‚¬åœå¯æ»šè½®è°ƒæ•´ï¼‰</h3>
                  <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
                    <label style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                      <span style="font-weight: 600; color: var(--text);">æ—¶</span>
                      <input type="number" id="timerHour" min="0" max="23" value="0" step="1" class="timer-wheel-input" style="width: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center; font-size: 20px; font-weight: 600; cursor: ns-resize;">
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                      <span style="font-weight: 600; color: var(--text);">åˆ†</span>
                      <input type="number" id="timerMinute" min="0" max="59" value="0" step="1" class="timer-wheel-input" style="width: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center; font-size: 20px; font-weight: 600; cursor: ns-resize;">
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                      <span style="font-weight: 600; color: var(--text);">ç§’</span>
                      <input type="number" id="timerSecond" min="0" max="59" value="0" step="1" class="timer-wheel-input" style="width: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center; font-size: 20px; font-weight: 600; cursor: ns-resize;">
                    </label>
                    <div style="display: flex; align-items: flex-end; height: 100%;">
                      <button onclick="timerSetCustom()" class="btn primary" style="padding: 12px 32px; font-size: 16px; font-weight: 600; margin-top: 28px;">è®¾ç½®</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½®è§†å›¾ -->
            <div id="settingsView" style="display: none;">
              <!-- å¤‡ä»½è®¾ç½®æç¤º -->
              <div id="backupWarning" style="display: none; padding: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; margin-bottom: 16px;">
                <div style="color: #ef4444; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                  <span>âš ï¸</span>
                  <span>è¯·å…ˆè®¾ç½®å¤‡ä»½è·¯å¾„ï¼Œä»¥ç¡®ä¿æ•°æ®å®‰å…¨ï¼ç‚¹å‡»é¡¶éƒ¨"å¤‡ä»½è®¾ç½®"æŒ‰é’®è¿›è¡Œè®¾ç½®ã€‚</span>
                </div>
              </div>
              
              <div class="card" style="flex-direction: column; align-items: flex-start; padding: 24px;">
                <h3 style="margin-bottom: 16px;">ğŸ”’ å¯†ç ä¿æŠ¤</h3>
                <div class="subtle" style="margin-bottom: 16px;">è®¾ç½®å¯†ç åï¼Œåˆ é™¤ç­çº§å’Œæ¸…ç©ºç§¯åˆ†ç­‰æ•æ„Ÿæ“ä½œéœ€è¦å¯†ç éªŒè¯</div>
                <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px;">
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">å½“å‰çŠ¶æ€</label>
                    <div id="passwordStatus" style="padding: 8px; background: var(--soft); border-radius: 8px;"></div>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºç¦ç”¨å¯†ç ä¿æŠ¤ï¼‰">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                  </div>
                  <button onclick="savePassword()" class="btn primary">ä¿å­˜å¯†ç è®¾ç½®</button>
                </div>
              </div>

              <div class="card mt16" style="flex-direction: column; align-items: flex-start; padding: 24px;">
                <h3 style="margin-bottom: 16px;">ğŸ¨ è‡ªå®šä¹‰èƒŒæ™¯</h3>
                <div class="subtle" style="margin-bottom: 16px;">ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡ï¼Œè®©ç³»ç»Ÿæ›´ä¸ªæ€§åŒ–</div>
                <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px;">
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</label>
                    <input type="file" id="bgImageFile" accept="image/*" style="width: 100%;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">èƒŒæ™¯æ¨¡ç³Šç¨‹åº¦ï¼š<span id="blurValue">0</span>px</label>
                    <input type="range" id="bgBlurRange" min="0" max="20" value="0" style="width: 100%;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">èƒŒæ™¯é€æ˜åº¦ï¼š<span id="opacityValue">30</span>%</label>
                    <input type="range" id="bgOpacityRange" min="0" max="100" value="30" style="width: 100%;">
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button onclick="applyBackground()" class="btn primary" style="flex: 1;">åº”ç”¨èƒŒæ™¯</button>
                    <button onclick="removeBackground()" class="btn" style="flex: 1;">ç§»é™¤èƒŒæ™¯</button>
                  </div>
                </div>
              </div>

              <div class="card mt16" style="flex-direction: column; align-items: flex-start; padding: 24px;">
                <h3 style="margin-bottom: 16px;">ğŸ“ ç­çº§ç®¡ç†</h3>
                <div class="subtle" style="margin-bottom: 16px;">ç®¡ç†å½“å‰ç­çº§çš„åŸºæœ¬ä¿¡æ¯</div>
                <button onclick="renameCurrentClass()" class="btn primary">é‡å‘½åå½“å‰ç­çº§</button>
              </div>

              <div class="card mt16" style="flex-direction: column; align-items: flex-start; padding: 24px;">
                <h3 style="margin-bottom: 8px;">ğŸ§¹ å­˜å‚¨ç©ºé—´ç®¡ç†</h3>
                <div class="subtle" style="margin-bottom: 16px; font-size: 13px;">
                  æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼ˆä¸ä¼šåˆ é™¤å­¦ç”Ÿæ­£åœ¨ä½¿ç”¨çš„å¤´åƒï¼‰
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px;">
                  <button onclick="manualCleanupAvatars()" class="btn" style="background: #f59e0b; color: white;">ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒ</button>
                </div>
              </div>

              <div class="card mt16" style="flex-direction: column; align-items: flex-start; padding: 24px;">
                <h3 style="margin-bottom: 16px;">âš ï¸ å±é™©æ“ä½œ</h3>
                <div class="subtle" style="margin-bottom: 16px;">ä»¥ä¸‹æ“ä½œä¼šæ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ</div>
                <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px;">
                  <button onclick="clearAllPoints()" class="btn warn">æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿç§¯åˆ†</button>
                  <button onclick="clearAllHistory()" class="btn warn">æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•</button>
                  <button onclick="resetSystemToInitial()" class="btn" style="background: #dc2626; color: white; font-weight: 700;">ğŸ”„ é‡ç½®ç³»ç»Ÿåˆ°åˆå§‹çŠ¶æ€</button>
                </div>
                <div class="subtle" style="margin-top: 12px; font-size: 12px; color: #dc2626;">
                  âš ï¸ é‡ç½®ç³»ç»Ÿå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆå­¦ç”Ÿã€å°ç»„ã€è§„åˆ™ã€å†å²ã€å•†åŸã€å¯†ç ã€èƒŒæ™¯ç­‰ï¼‰ï¼Œæ¢å¤åˆ°åˆå§‹å®‰è£…çŠ¶æ€
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§æ’è¡Œæ¦œ -->
      <div id="rankPane">
        <div class="panel">
          <h2 style="display: flex; align-items: center; gap: 8px;">
            <span style="flex: 1;">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</span>
            <div style="display: flex; align-items: center; gap: 6px;">
            <select id="rankTypeSel" onchange="switchRankType(this.value)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;">
              <option value="total">æ€»æ¦œ</option>
              <option value="day">æ—¥æ¦œ</option>
              <option value="week">å‘¨æ¦œ</option>
              <option value="month">æœˆæ¦œ</option>
              <option value="year">å¹´æ¦œ</option>
            </select>
              <button id="progressRankBtn" class="btn" style="background: rgba(59,130,246,0.15); color: #2563eb; border: 1px solid rgba(37,99,235,0.3); font-size: 12px; padding: 4px 10px; border-radius: 6px;" onclick="toggleProgressRank()">ğŸ“ˆ è¿›æ­¥æ¦œ</button>
              <select id="progressRangeSel" onchange="changeProgressRange(this.value)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;" disabled>
                <option value="7">è¿‘7å¤©</option>
                <option value="30">è¿‘30å¤©</option>
              </select>
            </div>
          </h2>
          <div style="display: flex; gap: 6px; padding: 8px 12px; background: white; border-bottom: 1px solid var(--border);">
            <button class="rank-mode-btn active" data-mode="student" onclick="switchRankMode('student')" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">ğŸ‘¤ ä¸ªäºº</button>
            <button class="rank-mode-btn" data-mode="group" onclick="switchRankMode('group')" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">ğŸ‘¥ å°ç»„</button>
          </div>
          <div id="rankList">
            <!-- æ’è¡Œæ¦œå°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—å®¹å™¨ -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <div class="modal-header" id="modalTitle">æ ‡é¢˜</div>
      <div class="modal-body" id="modalBody">å†…å®¹</div>
      <div class="modal-footer">
        <button id="modalOk" class="btn primary">ç¡®å®š</button>
        <button id="modalCancel" class="btn">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div id="toast"></div>

  <script>
    // ==================== å…¨å±€å˜é‡ ==================== 
    const CLASSES_KEY = 'cpm_classes_list_v1';
    const CURRENT_CLASS_KEY = 'cpm_current_class_id';
    const STATE_KEY_PREFIX = 'cpm_state_';
    const MALL_KEY = 'cpm_mall_items_v1';
    const RC_RECORDS_KEY = 'cpm_rc_records';
    const RC_CALLED_KEY = 'cpm_rc_called_set';
    const THEME_KEY = 'cpm_theme';
    const POINT_HISTORY_KEY = 'cpm_point_history_v1';
    const RANK_SNAPSHOT_KEY_PREFIX = 'cpm_rank_snapshot_';
    const PASSWORD_KEY = 'cpm_system_password';
    const BG_IMAGE_KEY = 'cpm_bg_image';
    const BG_SETTINGS_KEY = 'cpm_bg_settings';
    const DB_NAME = 'class_points_db_v1';
    const AVA_STORE = 'avatars';
    const BACKUP_FOLDER_STORE = 'backup_folder';
    const BACKUP_MAX_FILES = 5; // æœ€å¤šä¿ç•™5ä¸ªå¤‡ä»½æ–‡ä»¶

    let classes = [];
    let currentClassId = null;
    let state = {
      students: [],
      groups: [],
      rules: [],
      history: []
    };
    let mallItems = [];
    let rcRecords = [];
    let rcCalledSet = [];
    let pointHistory = {}; // ä¸ªäººç§¯åˆ†å†å² {studentId: [{time, delta, reason}]}
    let currentRankType = 'total'; // å½“å‰æ’è¡Œæ¦œç±»å‹
    let currentRankMode = 'student'; // å½“å‰æ’è¡Œæ¦œæ¨¡å¼ï¼šstudent(ä¸ªäºº) æˆ– group(å°ç»„)
    let bgSettings = { blur: 0, opacity: 30 }; // èƒŒæ™¯è®¾ç½®
    let currentRuleFilter = 'all'; // å½“å‰è§„åˆ™ç­›é€‰ï¼šall(å…¨éƒ¨), add(åŠ åˆ†), subtract(å‡åˆ†)
    let selectedStudentIds = new Set(); // å·²é€‰ä¸­çš„å­¦ç”ŸIDé›†åˆï¼Œè·¨æœç´¢/å­—æ¯ç­›é€‰ä¿æŒ
    // è¿›æ­¥æ’è¡Œæ¦œè¯´æ˜ï¼šä»…ç»Ÿè®¡è¯¾å ‚åŠ /å‡åˆ†ç­‰è¡Œä¸ºï¼Œå•†åŸå…‘æ¢(type === 'exchange') ä¸è®¡å…¥è¿›æ­¥å‡€å¢
    let progressRankEnabled = false; // æ˜¯å¦å¯ç”¨è¿›æ­¥æ¦œ
    let progressRangeDays = 7; // è¿›æ­¥æ¦œç»Ÿè®¡å¤©æ•°

    // ==================== æ®µä½ç³»ç»Ÿé…ç½® ====================
    const RANK_TIERS = [
      // å€”å¼ºé’é“œ
      { tier: 'bronze', division: 3, name: 'é’é“œIII', min: 0, max: 14, color: '#CD7F32', icon: 'ğŸ¥‰' },
      { tier: 'bronze', division: 2, name: 'é’é“œII', min: 15, max: 29, color: '#CD7F32', icon: 'ğŸ¥‰' },
      { tier: 'bronze', division: 1, name: 'é’é“œI', min: 30, max: 49, color: '#CD7F32', icon: 'ğŸ¥‰' },
      
      // ç§©åºç™½é“¶
      { tier: 'silver', division: 3, name: 'ç™½é“¶III', min: 50, max: 69, color: '#C0C0C0', icon: 'ğŸ¥ˆ' },
      { tier: 'silver', division: 2, name: 'ç™½é“¶II', min: 70, max: 89, color: '#C0C0C0', icon: 'ğŸ¥ˆ' },
      { tier: 'silver', division: 1, name: 'ç™½é“¶I', min: 90, max: 114, color: '#C0C0C0', icon: 'ğŸ¥ˆ' },
      
      // è£è€€é»„é‡‘
      { tier: 'gold', division: 4, name: 'é»„é‡‘IV', min: 115, max: 139, color: '#FFD700', icon: 'ğŸ¥‡' },
      { tier: 'gold', division: 3, name: 'é»„é‡‘III', min: 140, max: 169, color: '#FFD700', icon: 'ğŸ¥‡' },
      { tier: 'gold', division: 2, name: 'é»„é‡‘II', min: 170, max: 199, color: '#FFD700', icon: 'ğŸ¥‡' },
      { tier: 'gold', division: 1, name: 'é»„é‡‘I', min: 200, max: 234, color: '#FFD700', icon: 'ğŸ¥‡' },
      
      // å°Šè´µé“‚é‡‘
      { tier: 'platinum', division: 4, name: 'é“‚é‡‘IV', min: 235, max: 274, color: '#00CED1', icon: 'ğŸ’' },
      { tier: 'platinum', division: 3, name: 'é“‚é‡‘III', min: 275, max: 314, color: '#00CED1', icon: 'ğŸ’' },
      { tier: 'platinum', division: 2, name: 'é“‚é‡‘II', min: 315, max: 359, color: '#00CED1', icon: 'ğŸ’' },
      { tier: 'platinum', division: 1, name: 'é“‚é‡‘I', min: 360, max: 409, color: '#00CED1', icon: 'ğŸ’' },
      
      // æ°¸æ’é’»çŸ³
      { tier: 'diamond', division: 5, name: 'é’»çŸ³V', min: 410, max: 469, color: '#4169E1', icon: 'ğŸ’ ' },
      { tier: 'diamond', division: 4, name: 'é’»çŸ³IV', min: 470, max: 539, color: '#4169E1', icon: 'ğŸ’ ' },
      { tier: 'diamond', division: 3, name: 'é’»çŸ³III', min: 540, max: 619, color: '#4169E1', icon: 'ğŸ’ ' },
      { tier: 'diamond', division: 2, name: 'é’»çŸ³II', min: 620, max: 709, color: '#4169E1', icon: 'ğŸ’ ' },
      { tier: 'diamond', division: 1, name: 'é’»çŸ³I', min: 710, max: 809, color: '#4169E1', icon: 'ğŸ’ ' },
      
      // è‡³å°Šæ˜Ÿè€€
      { tier: 'star', division: 5, name: 'æ˜Ÿè€€V', min: 810, max: 929, color: '#9400D3', icon: 'â­' },
      { tier: 'star', division: 4, name: 'æ˜Ÿè€€IV', min: 930, max: 1059, color: '#9400D3', icon: 'â­' },
      { tier: 'star', division: 3, name: 'æ˜Ÿè€€III', min: 1060, max: 1199, color: '#9400D3', icon: 'â­' },
      { tier: 'star', division: 2, name: 'æ˜Ÿè€€II', min: 1200, max: 1349, color: '#9400D3', icon: 'â­' },
      { tier: 'star', division: 1, name: 'æ˜Ÿè€€I', min: 1350, max: 1519, color: '#9400D3', icon: 'â­' },
      
      // æœ€å¼ºç‹è€…
      { tier: 'king', division: 0, name: 'æœ€å¼ºç‹è€…', min: 1520, max: 1719, color: '#DC143C', icon: 'ğŸ‘‘', starPerPoints: 8 },
      
      // æ— åŒç‹è€…
      { tier: 'supreme', division: 0, name: 'æ— åŒç‹è€…', min: 1720, max: 2119, color: '#B8860B', icon: 'âš”ï¸', starPerPoints: 16 },
      
      // è£è€€ç‹è€…
      { tier: 'glory', division: 0, name: 'è£è€€ç‹è€…', min: 2120, max: 3119, color: '#FF1493', icon: 'ğŸ”±', starPerPoints: 20 },
      
      // ä¼ å¥‡ç‹è€…
      { tier: 'legend', division: 0, name: 'ä¼ å¥‡ç‹è€…', min: 3120, max: Infinity, color: '#FF6347', icon: 'ğŸ†', starPerPoints: 30 }
    ];
    let dbp = null;

    // ==================== æ®µä½ç³»ç»Ÿå‡½æ•° ====================
    function calculateRankTier(points) {
      // æ ¹æ®ç§¯åˆ†è®¡ç®—æ®µä½
      for (let i = RANK_TIERS.length - 1; i >= 0; i--) {
        const tierConfig = RANK_TIERS[i];
        if (points >= tierConfig.min) {
          const result = {
            tier: tierConfig.tier,
            division: tierConfig.division,
            name: tierConfig.name,
            icon: tierConfig.icon,
            color: tierConfig.color,
            points: points,
            min: tierConfig.min,
            max: tierConfig.max === Infinity ? tierConfig.min + 1000 : tierConfig.max,
            stars: 0,
            displayName: ''
          };
          
          // è®¡ç®—ç‹è€…æ®µä½çš„æ˜Ÿæ•°
          if (tierConfig.starPerPoints) {
            const stars = Math.floor((points - tierConfig.min) / tierConfig.starPerPoints);
            result.stars = stars;
            
            // æ ¹æ®æ®µä½ç¡®å®šæ˜Ÿæ•°èŒƒå›´
            if (tierConfig.tier === 'king') {
              result.displayName = `${tierConfig.icon} ${tierConfig.name} ${stars}æ˜Ÿ`;
            } else if (tierConfig.tier === 'supreme') {
              result.displayName = `${tierConfig.icon} ${tierConfig.name} ${25 + stars}æ˜Ÿ`;
            } else if (tierConfig.tier === 'glory') {
              result.displayName = `${tierConfig.icon} ${tierConfig.name} ${50 + Math.floor((points - tierConfig.min) / tierConfig.starPerPoints)}æ˜Ÿ`;
            } else if (tierConfig.tier === 'legend') {
              result.displayName = `${tierConfig.icon} ${tierConfig.name} ${100 + Math.floor((points - tierConfig.min) / tierConfig.starPerPoints)}æ˜Ÿ`;
            }
          } else {
            result.displayName = `${tierConfig.icon} ${tierConfig.name}`;
          }
          
          // è®¡ç®—åˆ°ä¸‹ä¸€æ®µä½çš„è¿›åº¦
          if (tierConfig.max !== Infinity) {
            result.progress = Math.round(((points - tierConfig.min) / (tierConfig.max - tierConfig.min + 1)) * 100);
            result.nextTierPoints = tierConfig.max + 1;
            result.pointsToNext = tierConfig.max + 1 - points;
          } else {
            result.progress = 100;
            result.nextTierPoints = null;
            result.pointsToNext = 0;
          }
          
          return result;
        }
      }
      
      // é»˜è®¤è¿”å›é’é“œIII
      return {
        tier: 'bronze',
        division: 3,
        name: 'é’é“œIII',
        icon: 'ğŸ¥‰',
        color: '#CD7F32',
        points: points,
        min: 0,
        max: 14,
        stars: 0,
        displayName: 'ğŸ¥‰ é’é“œIII',
        progress: Math.round((points / 15) * 100),
        nextTierPoints: 15,
        pointsToNext: 15 - points
      };
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function gid() {
      return Math.random().toString(36).slice(2, 10);
    }

    function now() {
      const d = new Date();
      const p = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }

    function toast(text, ms = 3200) {
      const el = $('#toast');
      el.textContent = text;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(() => el.style.display = 'none', ms);
    }

    function formatHistoryTimestamp(entry) {
      if (!entry) return '';
      if (entry.time) return entry.time;
      if (entry.timestamp) {
        const date = new Date(entry.timestamp);
        const p = n => String(n).padStart(2, '0');
        return `${date.getFullYear()}-${p(date.getMonth() + 1)}-${p(date.getDate())} ${p(date.getHours())}:${p(date.getMinutes())}:${p(date.getSeconds())}`;
      }
      return '';
    }


    function cKey(classId) {
      return STATE_KEY_PREFIX + classId;
    }

    function defaultState() {
      return {
        students: [],
        groups: [],
        rules: [],
        history: []
      };
    }

    // å›¾ç‰‡å‹ç¼©å‡½æ•°
    async function compressImage(file, quality = 0.7, maxWidth = 800) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½¬æ¢ä¸º Blob
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                } else {
                  reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
                }
              },
              'image/jpeg',
              quality
            );
          };
          img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
        reader.readAsDataURL(file);
      });
    }

    function placeholderAvatar(name) {
      const c = name?.trim()?.[0] || 'å­¦';
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
          <rect width='100%' height='100%' fill='#f1f5f9'/>
          <text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' 
                font-size='72' fill='#2563eb' font-family='Arial'>${c}</text>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // ==================== å®Œæ•´æ‹¼éŸ³åº“ï¼ˆå†…è”ï¼‰ ====================
    // ä½¿ç”¨ pinyin-pro çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œæ”¯æŒå®Œæ•´æ±‰å­—æ‹¼éŸ³è½¬æ¢
    // ä¸ºäº†ä¿æŒå•æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªè½»é‡çº§çš„æ‹¼éŸ³æ˜ å°„æ–¹æ¡ˆ
    // å¦‚æœæµè§ˆå™¨æ”¯æŒï¼Œä¼˜å…ˆä½¿ç”¨å†…ç½®çš„æ‹¼éŸ³åº“ï¼›å¦åˆ™ä½¿ç”¨æ‰©å±•çš„æ˜ å°„è¡¨
    
    // å®Œæ•´çš„ç™¾å®¶å§“æ‹¼éŸ³æ˜ å°„è¡¨ï¼ˆåŒ…å«å¸¸ç”¨å§“æ°å’Œåå­—ä¸­çš„å­—ï¼‰
    const pinyinMap = {
      // ç™¾å®¶å§“å‰100ä¸ªå¸¸è§å§“æ°
      'èµµ': 'zhao', 'é’±': 'qian', 'å­™': 'sun', 'æ': 'li', 'å‘¨': 'zhou', 'å´': 'wu', 'éƒ‘': 'zheng', 'ç‹': 'wang',
      'å†¯': 'feng', 'é™ˆ': 'chen', 'è¤š': 'chu', 'å«': 'wei', 'è’‹': 'jiang', 'æ²ˆ': 'shen', 'éŸ©': 'han', 'æ¨': 'yang',
      'æœ±': 'zhu', 'ç§¦': 'qin', 'å°¤': 'you', 'è®¸': 'xu', 'ä½•': 'he', 'å•': 'lv', 'æ–½': 'shi', 'å¼ ': 'zhang',
      'å­”': 'kong', 'æ›¹': 'cao', 'ä¸¥': 'yan', 'å': 'hua', 'é‡‘': 'jin', 'é­': 'wei', 'é™¶': 'tao', 'å§œ': 'jiang',
      'æˆš': 'qi', 'è°¢': 'xie', 'é‚¹': 'zou', 'å–»': 'yu', 'æŸ': 'bai', 'æ°´': 'shui', 'çª¦': 'dou', 'ç« ': 'zhang',
      'äº‘': 'yun', 'è‹': 'su', 'æ½˜': 'pan', 'è‘›': 'ge', 'å¥š': 'xi', 'èŒƒ': 'fan', 'å½­': 'peng', 'éƒ': 'lang',
      'é²': 'lu', 'éŸ¦': 'wei', 'æ˜Œ': 'chang', 'é©¬': 'ma', 'è‹—': 'miao', 'å‡¤': 'feng', 'èŠ±': 'hua', 'æ–¹': 'fang',
      'ä¿': 'yu', 'ä»»': 'ren', 'è¢': 'yuan', 'æŸ³': 'liu', 'é…†': 'feng', 'é²': 'bao', 'å²': 'shi', 'å”': 'tang',
      'è´¹': 'fei', 'å»‰': 'lian', 'å²‘': 'cen', 'è–›': 'xue', 'é›·': 'lei', 'è´º': 'he', 'å€ª': 'ni', 'æ±¤': 'tang',
      'æ»•': 'teng', 'æ®·': 'yin', 'ç½—': 'luo', 'æ¯•': 'bi', 'éƒ': 'hao', 'é‚¬': 'wu', 'å®‰': 'an', 'å¸¸': 'chang',
      'ä¹': 'yue', 'äº': 'yu', 'æ—¶': 'shi', 'å‚…': 'fu', 'çš®': 'pi', 'å': 'bian', 'é½': 'qi', 'åº·': 'kang',
      'ä¼': 'wu', 'ä½™': 'yu', 'å…ƒ': 'yuan', 'åœ': 'bu', 'é¡¾': 'gu', 'å­Ÿ': 'meng', 'å¹³': 'ping', 'é»„': 'huang',
      'å’Œ': 'he', 'ç©†': 'mu', 'è§': 'xiao', 'å°¹': 'yin', 'å§š': 'yao', 'é‚µ': 'shao', 'æ¹›': 'zhan', 'æ±ª': 'wang',
      'ç¥': 'qi', 'æ¯›': 'mao', 'ç¦¹': 'yu', 'ç‹„': 'di', 'ç±³': 'mi', 'è´': 'bei', 'æ˜': 'ming', 'è‡§': 'zang',
      'è®¡': 'ji', 'ä¼': 'fu', 'æˆ': 'cheng', 'æˆ´': 'dai', 'è°ˆ': 'tan', 'å®‹': 'song', 'èŒ…': 'mao', 'åº': 'pang',
      'ç†Š': 'xiong', 'çºª': 'ji', 'èˆ’': 'shu', 'å±ˆ': 'qu', 'é¡¹': 'xiang', 'ç¥': 'zhu', 'è‘£': 'dong', 'æ¢': 'liang',
      'æœ': 'du', 'é˜®': 'ruan', 'è“': 'lan', 'é—µ': 'min', 'å¸­': 'xi', 'å­£': 'ji', 'éº»': 'ma', 'å¼º': 'qiang',
      'è´¾': 'jia', 'è·¯': 'lu', 'å¨„': 'lou', 'å±': 'wei', 'æ±Ÿ': 'jiang', 'ç«¥': 'tong', 'é¢œ': 'yan', 'éƒ­': 'guo',
      'æ¢…': 'mei', 'ç››': 'sheng', 'æ—': 'lin', 'åˆ': 'diao', 'é’Ÿ': 'zhong', 'å¾': 'xu', 'é‚±': 'qiu', 'éª†': 'luo',
      'é«˜': 'gao', 'å¤': 'xia', 'è”¡': 'cai', 'ç”°': 'tian', 'æ¨Š': 'fan', 'èƒ¡': 'hu', 'å‡Œ': 'ling', 'éœ': 'huo',
      'è™': 'yu', 'ä¸‡': 'wan', 'æ”¯': 'zhi', 'æŸ¯': 'ke', 'æ˜': 'zan', 'ç®¡': 'guan', 'å¢': 'lu', 'è«': 'mo',
      'ç»': 'jing', 'æˆ¿': 'fang', 'è£˜': 'qiu', 'ç¼ª': 'miao', 'å¹²': 'gan', 'è§£': 'xie', 'åº”': 'ying', 'å®—': 'zong',
      'ä¸': 'ding', 'å®£': 'xuan', 'è´²': 'ben', 'é‚“': 'deng', 'éƒ': 'yu', 'å•': 'shan', 'æ­': 'hang', 'æ´ª': 'hong',
      'åŒ…': 'bao', 'è¯¸': 'zhu', 'å·¦': 'zuo', 'çŸ³': 'shi', 'å´”': 'cui', 'å‰': 'ji', 'é’®': 'niu', 'é¾š': 'gong',
      'ç¨‹': 'cheng', 'åµ‡': 'ji', 'é‚¢': 'xing', 'æ»‘': 'hua', 'è£´': 'pei', 'é™†': 'lu', 'è£': 'rong', 'ç¿': 'weng',
      'è€': 'xun', 'ç¾Š': 'yang', 'æ–¼': 'yu', 'æƒ ': 'hui', 'ç”„': 'zhen', 'æ›²': 'qu', 'å®¶': 'jia', 'å°': 'feng',
      'èŠ®': 'rui', 'ç¾¿': 'yi', 'å‚¨': 'chu', 'é³': 'jin', 'æ±²': 'ji', 'é‚´': 'bing', 'ç³œ': 'mi', 'æ¾': 'song',
      'äº•': 'jing', 'æ®µ': 'duan', 'å¯Œ': 'fu', 'å·«': 'wu', 'ä¹Œ': 'wu', 'ç„¦': 'jiao', 'å·´': 'ba', 'å¼“': 'gong',
      'ç‰§': 'mu', 'éš—': 'kui', 'å±±': 'shan', 'è°·': 'gu', 'è½¦': 'che', 'ä¾¯': 'hou', 'å®“': 'mi', 'è“¬': 'peng',
      'å…¨': 'quan', 'éƒ—': 'xi', 'ç­': 'ban', 'ä»°': 'yang', 'ç§‹': 'qiu', 'ä»²': 'zhong', 'ä¼Š': 'yi', 'å®«': 'gong',
      'å®': 'ning', 'ä»‡': 'qiu', 'æ ¾': 'luan', 'æš´': 'bao', 'ç”˜': 'gan', 'é’­': 'tou', 'å‰': 'li', 'æˆ': 'rong',
      'ç¥–': 'zu', 'æ­¦': 'wu', 'ç¬¦': 'fu', 'åˆ˜': 'liu', 'æ™¯': 'jing', 'è©¹': 'zhan', 'æŸ': 'shu', 'é¾™': 'long',
      'å¶': 'ye', 'å¹¸': 'xing', 'å¸': 'si', 'éŸ¶': 'shao', 'éƒœ': 'gao', 'é»': 'li', 'è“Ÿ': 'ji', 'è–„': 'bo',
      'å°': 'yin', 'å®¿': 'su', 'ç™½': 'bai', 'æ€€': 'huai', 'è’²': 'pu', 'é‚°': 'tai', 'ä»': 'cong', 'é„‚': 'e',
      'ç´¢': 'suo', 'å’¸': 'xian', 'ç±': 'ji', 'èµ–': 'lai', 'å“': 'zhuo', 'è”º': 'lin', 'å± ': 'tu', 'è’™': 'meng',
      'æ± ': 'chi', 'ä¹”': 'qiao', 'é˜´': 'yin', 'é¬±': 'yu', 'èƒ¥': 'xu', 'èƒ½': 'neng', 'è‹': 'cang', 'åŒ': 'shuang',
      'é—»': 'wen', 'è˜': 'shen', 'å…š': 'dang', 'ç¿Ÿ': 'zhai', 'è°­': 'tan', 'è´¡': 'gong', 'åŠ³': 'lao', 'é€„': 'pang',
      'å§¬': 'ji', 'ç”³': 'shen', 'æ‰¶': 'fu', 'å µ': 'du', 'å†‰': 'ran', 'å®°': 'zai', 'éƒ¦': 'li', 'é›': 'yong',
      'å»': 'que', 'ç’©': 'qu', 'æ¡‘': 'sang', 'æ¡‚': 'gui', 'æ¿®': 'pu', 'ç‰›': 'niu', 'å¯¿': 'shou', 'é€š': 'tong',
      'è¾¹': 'bian', 'æ‰ˆ': 'hu', 'ç‡•': 'yan', 'å†€': 'ji', 'éƒ': 'jia', 'æµ¦': 'pu', 'å°š': 'shang', 'å†œ': 'nong',
      'æ¸©': 'wen', 'åˆ«': 'bie', 'åº„': 'zhuang', 'æ™': 'yan', 'æŸ´': 'chai', 'ç¿': 'qu', 'é˜': 'yan', 'å……': 'chong',
      'æ…•': 'mu', 'è¿': 'lian', 'èŒ¹': 'ru', 'ä¹ ': 'xi', 'å®¦': 'huan', 'è‰¾': 'ai', 'é±¼': 'yu', 'å®¹': 'rong',
      'å‘': 'xiang', 'å¤': 'gu', 'æ˜“': 'yi', 'æ…': 'shen', 'æˆˆ': 'ge', 'å»–': 'liao', 'åº¾': 'yu', 'ç»ˆ': 'zhong',
      'æš¨': 'ji', 'å±…': 'ju', 'è¡¡': 'heng', 'æ­¥': 'bu', 'éƒ½': 'du', 'è€¿': 'geng', 'æ»¡': 'man', 'å¼˜': 'hong',
      'åŒ¡': 'kuang', 'å›½': 'guo', 'æ–‡': 'wen', 'å¯‡': 'kou', 'å¹¿': 'guang', 'ç¦„': 'lu', 'é˜™': 'que', 'ä¸œ': 'dong',
      'æ¬§': 'ou', 'æ®³': 'shu', 'æ²ƒ': 'wo', 'åˆ©': 'li', 'è”š': 'wei', 'è¶Š': 'yue', 'å¤”': 'kui', 'éš†': 'long',
      'å¸ˆ': 'shi', 'å·©': 'gong', 'å': 'she', 'è‚': 'nie', 'æ™': 'chao', 'å‹¾': 'gou', 'æ•–': 'ao', 'è': 'rong',
      'å†·': 'leng', 'è¨¾': 'zi', 'è¾›': 'xin', 'é˜š': 'kan', 'é‚£': 'na', 'ç®€': 'jian', 'é¥¶': 'rao', 'ç©º': 'kong',
      'æ›¾': 'zeng', 'æ¯‹': 'wu', 'æ²™': 'sha', 'ä¹œ': 'nie', 'å…»': 'yang', 'é ': 'ju', 'é¡»': 'xu', 'ä¸°': 'feng',
      'å·¢': 'chao', 'å…³': 'guan', 'è’¯': 'kuai', 'ç›¸': 'xiang', 'æŸ¥': 'zha', 'å¾Œ': 'hou', 'è†': 'jing', 'çº¢': 'hong',
      'æ¸¸': 'you', 'ç«º': 'zhu', 'æƒ': 'quan', 'é€¯': 'lu', 'ç›–': 'gai', 'ç›Š': 'yi', 'æ¡“': 'huan', 'å…¬': 'gong',
      'ä¸‡ä¿Ÿ': 'moqi', 'å¸é©¬': 'sima', 'ä¸Šå®˜': 'shangguan', 'æ¬§é˜³': 'ouyang', 'å¤ä¾¯': 'xiahou', 'è¯¸è‘›': 'zhuge',
      'é—»äºº': 'wenren', 'ä¸œæ–¹': 'dongfang', 'èµ«è¿': 'helian', 'çš‡ç”«': 'huangfu', 'å°‰è¿Ÿ': 'yuchi', 'å…¬ç¾Š': 'gongyang',
      'æ¾¹å°': 'tantai', 'å…¬å†¶': 'gongye', 'å®—æ”¿': 'zongzheng', 'æ¿®é˜³': 'puyang', 'æ·³äº': 'chunyu', 'å•äº': 'chanyu',
      'å¤ªå”': 'taishu', 'ç”³å± ': 'shentu', 'å…¬å­™': 'gongsun', 'ä»²å­™': 'zhongsun', 'è½©è¾•': 'xuanyuan', 'ä»¤ç‹': 'linghu',
      'é’Ÿç¦»': 'zhongli', 'å®‡æ–‡': 'yuwen', 'é•¿å­™': 'zhangsun', 'æ…•å®¹': 'murong', 'é²œäº': 'xianyu', 'é—¾ä¸˜': 'lvqiu',
      'å¸å¾’': 'situ', 'å¸ç©º': 'sikong', 'äº“å®˜': 'qiguan', 'å¸å¯‡': 'sikou', 'ä»‰': 'zhang', 'ç£': 'du', 'å­è½¦': 'ziche',
      'é¢›å­™': 'zhuansun', 'ç«¯æœ¨': 'duanmu', 'å·«é©¬': 'wuma', 'å…¬è¥¿': 'gongxi', 'æ¼†é›•': 'qidiao', 'ä¹æ­£': 'yuezheng',
      'å£¤é©·': 'rangsi', 'å…¬è‰¯': 'gongliang', 'æ‹“è·‹': 'tuoba', 'å¤¹è°·': 'jiagu', 'å®°çˆ¶': 'zaifu', 'ç©€æ¢': 'guliang',
      'æ™‹': 'jin', 'æ¥š': 'chu', 'é—«': 'yan', 'æ³•': 'fa', 'æ±': 'ru', 'é„¢': 'yan', 'æ¶‚': 'tu', 'é’¦': 'qin',
      'æ®µå¹²': 'duangan', 'ç™¾é‡Œ': 'baili', 'ä¸œéƒ­': 'dongguo', 'å—é—¨': 'nanmen', 'å‘¼å»¶': 'huyan', 'å½’': 'gui',
      'æµ·': 'hai', 'ç¾ŠèˆŒ': 'yangshe', 'å¾®ç”Ÿ': 'weisheng', 'å²³': 'yue', 'å¸…': 'shuai', 'ç¼‘': 'gou', 'äº¢': 'kang',
      'å†µ': 'kuang', 'å': 'hou', 'æœ‰': 'you', 'ç´': 'qin', 'æ¢ä¸˜': 'liangqiu', 'å·¦ä¸˜': 'zuoqiu', 'ä¸œé—¨': 'dongmen',
      'è¥¿é—¨': 'ximen', 'å•†': 'shang', 'ç‰Ÿ': 'mou', 'ä½˜': 'she', 'ä½´': 'nai', 'ä¼¯': 'bo', 'èµ': 'shang', 'å—å®«': 'nangong',
      'å¢¨': 'mo', 'å“ˆ': 'ha', 'è°¯': 'qiao', 'ç¬ª': 'da', 'å¹´': 'nian', 'çˆ±': 'ai', 'é˜³': 'yang', 'ä½Ÿ': 'tong',
      'ç¬¬äº”': 'diwu', 'è¨€': 'yan', 'ç¦': 'fu', 'ç¶¦': 'qi', 'æ¼†': 'qi', 'äº“': 'qi', 'éƒ„': 'qie',
      // å¸¸ç”¨åå­—ä¸­çš„å­—ï¼ˆè¡¥å……ï¼‰
      'ä¸€': 'yi', 'äºŒ': 'er', 'ä¸‰': 'san', 'å››': 'si', 'äº”': 'wu', 'å…­': 'liu', 'ä¸ƒ': 'qi', 'å…«': 'ba', 'ä¹': 'jiu', 'å': 'shi',
      'æ˜': 'ming', 'å': 'hua', 'å¼º': 'qiang', 'èŠ³': 'fang', 'å†›': 'jun', 'ä¼Ÿ': 'wei', 'æ•': 'min', 'é™': 'jing', 'ä¸½': 'li', 'å¨Ÿ': 'juan',
      'å‹‡': 'yong', 'è‰³': 'yan', 'æ°': 'jie', 'ç£Š': 'lei', 'æ¶›': 'tao', 'è¶…': 'chao', 'é¹': 'peng', 'è‹±': 'ying', 'è¾‰': 'hui', 'æ–Œ': 'bin',
      'åˆš': 'gang', 'éœ': 'xia', 'å¹³': 'ping', 'æ³¢': 'bo', 'ç²': 'ling', 'ç§€': 'xiu', 'å°': 'xiao', 'å¤§': 'da', 'å­': 'zi', 'å»º': 'jian',
      'æ–°': 'xin', 'æ˜¥': 'chun', 'ç§‹': 'qiu', 'å†¬': 'dong', 'å¤©': 'tian', 'å®‡': 'yu', 'æµ©': 'hao', 'å©·': 'ting', 'æ´': 'jie', 'ç³': 'lin',
      'è': 'ping', 'é›ª': 'xue', 'è‰': 'li', 'æ…§': 'hui', 'äº‘': 'yun', 'å¼€': 'kai', 'å¿ƒ': 'xin', 'å‡¯': 'kai', 'ç§‘': 'ke', 'å¯': 'ke',
      'ç”»': 'hua', 'æ™º': 'zhi', 'èˆª': 'hang', 'ä¹¦': 'shu', 'å¨´': 'xian'
    };

    // å®Œæ•´çš„æ±‰å­—æ‹¼éŸ³æ˜ å°„è¡¨ï¼ˆåŸºäºUnicodeèŒƒå›´ï¼Œè¦†ç›–å¸¸ç”¨æ±‰å­—ï¼‰
    // è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ‹¼éŸ³åº“å®ç°ï¼Œæ”¯æŒå¤§éƒ¨åˆ†å¸¸ç”¨æ±‰å­—
    const pinyinDict = (function() {
      // ä½¿ç”¨ Intl.Segmenter æˆ–æ‹¼éŸ³åº“APIï¼ˆå¦‚æœå¯ç”¨ï¼‰
      // å¦åˆ™ä½¿ç”¨æ‰©å±•çš„æ˜ å°„è¡¨ + UnicodeèŒƒå›´ä¼°ç®—
      const dict = {};
      
      // æ‰©å±•æ˜ å°„è¡¨ï¼ˆè¡¥å……ä¸€äº›éå¸¸ç”Ÿåƒ»çš„å§“æ°ï¼ŒpinyinMapä¸­å·²åŒ…å«çš„ç™¾å®¶å§“ä¸å†é‡å¤ï¼‰
      // æ³¨æ„ï¼šObject.assign ä¼šè¦†ç›–ï¼Œæ‰€ä»¥ extendedMap ä¸­çš„å€¼ä¼šè¦†ç›– pinyinMap ä¸­çš„å€¼
      // è¿™é‡Œåªä¿ç•™ä¸€äº›éå¸¸ç”Ÿåƒ»çš„å§“æ°ï¼Œé¿å…é‡å¤
      const extendedMap = {
        // éå¸¸ç”Ÿåƒ»çš„å§“æ°ï¼ˆå¦‚æœä¸åœ¨ pinyinMap ä¸­ï¼‰
        'éƒ„': 'qie', 'éƒ•': 'cheng', 'éƒ–': 'dou', 'éƒ˜': 'lu', 'éƒ™': 'fu', 'éƒš': 'wu',
        'éƒ›': 'fu', 'éƒ ': 'geng', 'éƒ£': 'bo', 'éƒ¤': 'xi', 'éƒ¥': 'bei', 'éƒ©': 'xiao',
        'éƒª': 'qi', 'éƒ«': 'pi', 'éƒ¬': 'qing', 'éƒ®': 'zhou', 'éƒ¯': 'tan', 'éƒ°': 'zou',
        'éƒ±': 'ping', 'éƒ²': 'lai', 'éƒ³': 'ni', 'éƒµ': 'you', 'éƒ¶': 'bu', 'éƒ·': 'xiang',
        'éƒ¸': 'dan', 'éƒ¹': 'ju', 'éƒº': 'yong', 'éƒ»': 'qiao', 'éƒ¼': 'yi', 'éƒ¾': 'yan',
        'éƒ¿': 'mei', 'é„€': 'ruo', 'é„': 'bei', 'é„ƒ': 'shu', 'é„„': 'juan', 'é„…': 'yu',
        'é„†': 'yun', 'é„‡': 'hou', 'é„ˆ': 'kui', 'é„‰': 'xiang', 'é„Š': 'xiang', 'é„‹': 'sou',
        'é„Œ': 'tang', 'é„': 'ming', 'é„': 'xi', 'é„': 'ru', 'é„': 'chu', 'é„‘': 'zi',
        'é„’': 'zou', 'é„“': 'yi', 'é„”': 'wu', 'é„•': 'xiang', 'é„–': 'yun', 'é„—': 'hao',
        'é„˜': 'yong', 'é„š': 'mao', 'é„›': 'chao', 'é„œ': 'fu', 'é„': 'liao', 'é„': 'yin',
        'é„Ÿ': 'zhuan', 'é„ ': 'hu', 'é„¡': 'qiao', 'é„£': 'zhang', 'é„¤': 'man', 'é„¥': 'qiao',
        'é„¦': 'xu', 'é„¨': 'bi', 'é„©': 'xun', 'é„ª': 'bi', 'é„«': 'zeng', 'é„¬': 'wei',
        'é„®': 'mao', 'é„¯': 'shan', 'é„°': 'lin', 'é„±': 'po', 'é„²': 'dan', 'é„³': 'meng',
        'é„´': 'ye', 'é„µ': 'cao', 'é„¶': 'kuai', 'é„·': 'feng', 'é„¸': 'meng', 'é„¹': 'zou',
        'é„º': 'kuang', 'é„»': 'lian', 'é„¼': 'can', 'é„½': 'chan', 'é„¾': 'you', 'é„¿': 'ji',
        'é…€': 'yan', 'é…': 'chan', 'é…‚': 'zan', 'é…ƒ': 'ling', 'é…„': 'huan', 'é……': 'xi',
        'é…†': 'feng', 'é…‡': 'zan', 'é…ˆ': 'li'
      };
      
      // åˆå¹¶åˆ°å­—å…¸
      Object.assign(dict, pinyinMap, extendedMap);
      return dict;
    })();

    // ä½¿ç”¨å®Œæ•´æ‹¼éŸ³åº“è·å–æ‹¼éŸ³ï¼ˆä¼˜å…ˆä½¿ç”¨æ‰©å±•æ˜ å°„è¡¨ï¼Œå¦åˆ™ä½¿ç”¨GB2312é¦–å­—æ¯åŒºé—´ä¼°ç®—ï¼‰
    function getPinyin(text) {
      if (!text) return '';
      return text.split('').map(c => {
        // ä¼˜å…ˆæŸ¥æ‰©å±•æ˜ å°„è¡¨
        if (pinyinDict[c]) return pinyinDict[c];
        // å¦‚æœä¸åœ¨æ˜ å°„è¡¨ä¸­ï¼Œä½¿ç”¨GB2312é¦–å­—æ¯åŒºé—´ä¼°ç®—ï¼ˆè¿”å›é¦–å­—æ¯ä½œä¸ºæ‹¼éŸ³çš„ç®€åŒ–è¡¨ç¤ºï¼‰
        const firstLetter = getFirstLetterByGB2312(c);
        // å¦‚æœé¦–å­—æ¯ä¼°ç®—å¤±è´¥ï¼Œè¿”å›åŸå­—ç¬¦
        if (firstLetter === c[0] && /[^a-z]/i.test(c)) {
          return c; // éæ±‰å­—æˆ–æ— æ³•ä¼°ç®—ï¼Œè¿”å›åŸå­—ç¬¦
        }
        // ä½¿ç”¨é¦–å­—æ¯ä½œä¸ºæ‹¼éŸ³çš„ç®€åŒ–è¡¨ç¤ºï¼ˆç”¨äºæœç´¢åŒ¹é…ï¼‰
        return firstLetter;
      }).join('');
    }

    // GB2312é¦–å­—æ¯åŒºé—´ä¼°ç®—ï¼ˆä½œä¸ºå…œåº•æ–¹æ¡ˆï¼‰
    function getFirstLetterByGB2312(char) {
      const code = char.charCodeAt(0);
      if (code >= 0xB0A1 && code <= 0xB0C4) return 'a';
      if (code >= 0xB0C5 && code <= 0xB2C0) return 'b';
      if (code >= 0xB2C1 && code <= 0xB4ED) return 'c';
      if (code >= 0xB4EE && code <= 0xB6E9) return 'd';
      if (code >= 0xB6EA && code <= 0xB7A1) return 'e';
      if (code >= 0xB7A2 && code <= 0xB8C0) return 'f';
      if (code >= 0xB8C1 && code <= 0xB9FD) return 'g';
      if (code >= 0xB9FE && code <= 0xBBF6) return 'h';
      if (code >= 0xBBF7 && code <= 0xBFA5) return 'j';
      if (code >= 0xBFA6 && code <= 0xC0AB) return 'k';
      if (code >= 0xC0AC && code <= 0xC2E7) return 'l';
      if (code >= 0xC2E8 && code <= 0xC4C2) return 'm';
      if (code >= 0xC4C3 && code <= 0xC5B5) return 'n';
      if (code >= 0xC5B6 && code <= 0xC5BD) return 'o';
      if (code >= 0xC5BE && code <= 0xC6D9) return 'p';
      if (code >= 0xC6DA && code <= 0xC8BA) return 'q';
      if (code >= 0xC8BB && code <= 0xC8F5) return 'r';
      if (code >= 0xC8F6 && code <= 0xCBF9) return 's';
      if (code >= 0xCBFA && code <= 0xCDD9) return 't';
      if (code >= 0xCDDA && code <= 0xCEF3) return 'w';
      if (code >= 0xCEF4 && code <= 0xD188) return 'x';
      if (code >= 0xD1B9 && code <= 0xD4D0) return 'y';
      if (code >= 0xD4D1 && code <= 0xD7F9) return 'z';
      return char[0];
    }

    // è·å–æ±‰å­—æ‹¼éŸ³é¦–å­—æ¯ï¼ˆä½¿ç”¨å®Œæ•´æ‹¼éŸ³åº“ï¼‰
    function getFirstLetter(char) {
      if (!char) return '';
      // ä¼˜å…ˆæŸ¥æ‰©å±•æ˜ å°„è¡¨
      if (pinyinDict[char]) {
        const pinyin = pinyinDict[char];
        return pinyin[0].toLowerCase();
      }
      // å¦‚æœä¸åœ¨æ˜ å°„è¡¨ä¸­ï¼Œç›´æ¥ä½¿ç”¨GB2312é¦–å­—æ¯åŒºé—´ä½œä¸ºå…œåº•
      return getFirstLetterByGB2312(char);
    }

    function isNameMatch(name, filter) {
      if (!filter) return true;
      
      const lower = filter.toLowerCase().trim();
      const nameLower = name.toLowerCase();
      const pinyin = getPinyin(name).toLowerCase();
      const lettersOnly = pinyin.replace(/[^a-z]/g, '');
      const initials = name.split('').map(getFirstLetter).join('').toLowerCase();
      
      // å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯å•ä¸ªè‹±æ–‡å­—æ¯ï¼Œåˆ™ä»…æŒ‰é¦–å­—æ¯åŒ¹é…
      if (/^[a-z]$/.test(lower)) {
        return initials.startsWith(lower);
      }
      
      // æ”¯æŒï¼šæ±‰å­—ã€æ‹¼éŸ³å…¨æ‹¼ã€æ‹¼éŸ³é¦–å­—æ¯
      return nameLower.includes(lower) || 
             pinyin.includes(lower) || 
             lettersOnly.includes(lower) ||
             lettersOnly.startsWith(lower) ||
             initials.includes(lower) ||
             initials.startsWith(lower);
    }

    // ==================== IndexedDB API ====================
    function openDB() {
      if (dbp) return dbp;
      
      dbp = new Promise((resolve, reject) => {
        console.log('å°è¯•æ‰“å¼€ IndexedDB:', DB_NAME);
        
        if (!window.indexedDB) {
          reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB'));
          return;
        }
        
        const timeout = setTimeout(() => {
          reject(new Error('æ‰“å¼€æ•°æ®åº“è¶…æ—¶ï¼ˆ15ç§’ï¼‰'));
        }, 15000);
        
        try {
          const req = indexedDB.open(DB_NAME, 1);
          
          req.onupgradeneeded = (e) => {
            console.log('æ•°æ®åº“å‡çº§ä¸­...');
            const db = req.result;
            if (!db.objectStoreNames.contains(AVA_STORE)) {
              db.createObjectStore(AVA_STORE);
              console.log('å·²åˆ›å»ºå¯¹è±¡å­˜å‚¨:', AVA_STORE);
            }
            if (!db.objectStoreNames.contains(BACKUP_FOLDER_STORE)) {
              db.createObjectStore(BACKUP_FOLDER_STORE);
              console.log('å·²åˆ›å»ºå¯¹è±¡å­˜å‚¨:', BACKUP_FOLDER_STORE);
            }
          };
          
          req.onsuccess = () => {
            clearTimeout(timeout);
            console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸ');
            resolve(req.result);
          };
          
          req.onerror = () => {
            clearTimeout(timeout);
            console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', req.error);
            reject(req.error || new Error('æ— æ³•æ‰“å¼€æ•°æ®åº“'));
          };
          
          req.onblocked = () => {
            clearTimeout(timeout);
            console.error('æ•°æ®åº“è¢«é˜»å¡');
            reject(new Error('æ•°æ®åº“è¢«é˜»å¡ï¼Œè¯·å…³é—­å…¶ä»–æ ‡ç­¾é¡µ'));
          };
        } catch (err) {
          clearTimeout(timeout);
          reject(err);
        }
      });
      
      return dbp;
    }

    async function putAvatar(key, blob) {
      try {
        console.log('å¼€å§‹ä¸Šä¼ å¤´åƒ:', key, 'å¤§å°:', blob.size);
        const db = await openDB();
        console.log('æ•°æ®åº“å·²æ‰“å¼€');
        
        return new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('å¤´åƒä¸Šä¼ è¶…æ—¶ï¼ˆ10ç§’ï¼‰'));
          }, 10000);
          
          try {
            const tx = db.transaction(AVA_STORE, 'readwrite');
            const store = tx.objectStore(AVA_STORE);
            const request = store.put(blob, key);
            
            request.onsuccess = () => {
              clearTimeout(timeout);
              console.log('å¤´åƒä¿å­˜æˆåŠŸ');
              resolve(true);
            };
            
            request.onerror = (e) => {
              clearTimeout(timeout);
              console.error('å¤´åƒä¿å­˜å¤±è´¥:', e);
              reject(request.error || new Error('ä¿å­˜å¤±è´¥'));
            };
            
            tx.oncomplete = () => {
              clearTimeout(timeout);
              console.log('äº‹åŠ¡å®Œæˆ');
            };
            
            tx.onerror = (e) => {
              clearTimeout(timeout);
              console.error('äº‹åŠ¡é”™è¯¯:', e);
              reject(tx.error || new Error('äº‹åŠ¡å¤±è´¥'));
            };
          } catch (err) {
            clearTimeout(timeout);
            reject(err);
          }
        });
      } catch (error) {
        console.error('putAvatar é”™è¯¯:', error);
        throw error;
      }
    }

    async function getAvatar(key) {
      try {
        // å…ˆå°è¯•ä» IndexedDB è¯»å–
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(AVA_STORE, 'readonly');
          const req = tx.objectStore(AVA_STORE).get(key);
          req.onsuccess = () => {
            if (req.result) {
              resolve(req.result);
            } else {
              // å¦‚æœ IndexedDB æ²¡æœ‰ï¼Œå°è¯•ä» localStorage è¯»å– base64
              const base64Data = localStorage.getItem(`avatar_${key}`);
              if (base64Data) {
                // å°† base64 è½¬æ¢ä¸º blob
                fetch(base64Data)
                  .then(res => res.blob())
                  .then(blob => resolve(blob))
                  .catch(() => resolve(null));
              } else {
                resolve(null);
              }
            }
          };
          req.onerror = () => {
            // IndexedDB å‡ºé”™ï¼Œå°è¯• localStorage
            const base64Data = localStorage.getItem(`avatar_${key}`);
            if (base64Data) {
              fetch(base64Data)
                .then(res => res.blob())
                .then(blob => resolve(blob))
                .catch(() => resolve(null));
            } else {
              resolve(null);
            }
          };
        });
      } catch (error) {
        // å¦‚æœ IndexedDB å®Œå…¨ä¸å¯ç”¨ï¼Œç›´æ¥ä» localStorage è¯»å–
        console.warn('IndexedDB ä¸å¯ç”¨ï¼Œå°è¯•ä» localStorage è¯»å–');
        const base64Data = localStorage.getItem(`avatar_${key}`);
        if (base64Data) {
          const blob = await fetch(base64Data).then(res => res.blob());
          return blob;
        }
        return null;
      }
    }

    async function delAvatar(key) {
      try {
        // å°è¯•ä» IndexedDB åˆ é™¤
        const db = await openDB();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(AVA_STORE, 'readwrite');
          tx.objectStore(AVA_STORE).delete(key);
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
        });
      } catch (error) {
        console.warn('ä» IndexedDB åˆ é™¤å¤±è´¥:', error);
      }
      
      // åŒæ—¶å°è¯•ä» localStorage åˆ é™¤
      try {
        localStorage.removeItem(`avatar_${key}`);
      } catch (error) {
        console.warn('ä» localStorage åˆ é™¤å¤±è´¥:', error);
      }

      return true;
    }

    function blobToDataUrl(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function getAvatarDataUrl(key) {
      if (!key) return null;
      const cached = localStorage.getItem(`avatar_${key}`);
      if (cached) return cached;
      
      try {
        const blob = await getAvatar(key);
        if (!blob) return null;
        const dataUrl = await blobToDataUrl(blob);
        return dataUrl;
      } catch (error) {
        console.warn('è·å–å¤´åƒæ•°æ®å¤±è´¥:', error);
        return null;
      }
    }

    async function restoreAvatarsFromBackup(avatarMap = {}) {
      const entries = Object.entries(avatarMap);
      if (entries.length === 0) return;
      
      for (const [key, dataUrl] of entries) {
        if (!key || !dataUrl) continue;
        try {
          localStorage.setItem(`avatar_${key}`, dataUrl);
        } catch (error) {
          console.warn('ä¿å­˜å¤´åƒåˆ° localStorage å¤±è´¥:', error);
        }
        
        try {
          const blob = await fetch(dataUrl).then(res => res.blob());
          await putAvatar(key, blob);
        } catch (error) {
          console.warn('ä¿å­˜å¤´åƒåˆ° IndexedDB å¤±è´¥:', error);
        }
      }
    }

    // æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒï¼ˆé‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼‰
    function cleanupUnusedAvatars() {
      try {
        console.log('ğŸ§¹ å¼€å§‹æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒ...');
        
        // è·å–æ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„å¤´åƒ key
        const usedKeys = new Set();
        const allClasses = JSON.parse(localStorage.getItem('cpm_classes') || '[]');
        
        console.log('ğŸ“‚ æ‰¾åˆ°ç­çº§æ•°é‡:', allClasses.length);
        
        allClasses.forEach(classId => {
          const stateKey = `cpm_state_${classId}`;
          try {
            const classState = JSON.parse(localStorage.getItem(stateKey) || '{}');
            
            if (classState.students && Array.isArray(classState.students)) {
              classState.students.forEach(student => {
                if (student.avatarKey) {
                  // æ³¨æ„ï¼šä¸è¦åŠ  avatar_ å‰ç¼€ï¼Œå› ä¸ºå­˜å‚¨æ—¶å·²ç»åŠ äº†
                  usedKeys.add(student.avatarKey);
                  console.log('âœ“ æ­£åœ¨ä½¿ç”¨çš„å¤´åƒ:', student.avatarKey, '(å­¦ç”Ÿ:', student.name, ')');
                }
              });
            }
          } catch (e) {
            console.warn('è¯»å–ç­çº§çŠ¶æ€å¤±è´¥:', classId, e);
          }
        });
        
        console.log('ğŸ“Š æ­£åœ¨ä½¿ç”¨çš„å¤´åƒæ€»æ•°:', usedKeys.size);
        
        // æŸ¥æ‰¾æ‰€æœ‰å¤´åƒæ–‡ä»¶
        const allAvatarKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('avatar_')) {
            // æå–å®é™…çš„ avatarKeyï¼ˆå»æ‰ avatar_ å‰ç¼€ï¼‰
            const avatarKey = key.substring(7); // 'avatar_'.length === 7
            allAvatarKeys.push({ storageKey: key, avatarKey: avatarKey });
          }
        }
        
        console.log('ğŸ“¦ localStorage ä¸­çš„å¤´åƒæ€»æ•°:', allAvatarKeys.length);
        
        // æ‰¾å‡ºæœªä½¿ç”¨çš„å¤´åƒ
        const keysToDelete = [];
        allAvatarKeys.forEach(item => {
          if (!usedKeys.has(item.avatarKey)) {
            keysToDelete.push(item.storageKey);
            console.log('âŒ æœªä½¿ç”¨çš„å¤´åƒ:', item.storageKey);
          }
        });
        
        if (keysToDelete.length === 0) {
          console.log('âœ¨ æ²¡æœ‰éœ€è¦æ¸…ç†çš„å¤´åƒ');
          return 0;
        }
        
        console.log(`ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤ ${keysToDelete.length} ä¸ªæœªä½¿ç”¨çš„å¤´åƒ`);
        
        // åˆ é™¤æœªä½¿ç”¨çš„å¤´åƒ
        let deletedCount = 0;
        keysToDelete.forEach(key => {
          try {
            localStorage.removeItem(key);
            deletedCount++;
          } catch (e) {
            console.warn('åˆ é™¤å¤±è´¥:', key, e);
          }
        });
        
        console.log(`âœ… æ¸…ç†å®Œæˆï¼ŒæˆåŠŸåˆ é™¤äº† ${deletedCount} ä¸ªæœªä½¿ç”¨çš„å¤´åƒ`);
        return deletedCount;
      } catch (error) {
        console.error('âŒ æ¸…ç†å¤´åƒå¤±è´¥:', error);
        return 0;
      }
    }

    // æ‰‹åŠ¨æ¸…ç†å¤´åƒï¼ˆå¸¦UIæç¤ºï¼‰
    function manualCleanupAvatars() {
      console.log('=== å¼€å§‹æ‰‹åŠ¨æ¸…ç†å¤´åƒ ===');
      
      const deletedCount = cleanupUnusedAvatars();
      
      console.log('=== æ¸…ç†å®Œæˆ ===');
      
      if (deletedCount > 0) {
        alert(`âœ… æ¸…ç†å®Œæˆï¼\n\nå·²åˆ é™¤ ${deletedCount} ä¸ªæœªä½¿ç”¨çš„å¤´åƒ\né‡Šæ”¾äº†å­˜å‚¨ç©ºé—´\n\nğŸ’¡ æç¤ºï¼šåªä¼šåˆ é™¤æ²¡æœ‰å­¦ç”Ÿä½¿ç”¨çš„å¤´åƒ\nå·²ä¸Šä¼ çš„å­¦ç”Ÿå¤´åƒä¸ä¼šè¢«åˆ é™¤\n\nç°åœ¨å¯ä»¥ç»§ç»­ä¸Šä¼ æ–°å¤´åƒäº†ã€‚`);
      } else {
        alert(`âœ¨ æ²¡æœ‰éœ€è¦æ¸…ç†çš„å¤´åƒ\n\næ‰€æœ‰å¤´åƒéƒ½åœ¨ä½¿ç”¨ä¸­\nå­˜å‚¨ç©ºé—´å·²ç»å¾ˆå¹²å‡€äº†ï¼\n\nğŸ“Š å½“å‰å·²ä½¿ç”¨å¤´åƒæ•°é‡ï¼š${state.students.filter(s => s.avatarKey).length}`);
      }
      
      console.log('å½“å‰å­¦ç”Ÿå¤´åƒæ•°:', state.students.filter(s => s.avatarKey).length);
    }

    // ==================== localStorage API ====================
    function saveClasses() {
      localStorage.setItem(CLASSES_KEY, JSON.stringify(classes));
    }

    function loadClasses() {
      try {
        classes = JSON.parse(localStorage.getItem(CLASSES_KEY) || '[]');
      } catch {
        classes = [];
      }
      
      if (classes.length === 0) {
        const id = gid();
        classes = [{ id, name: 'é»˜è®¤ç­çº§' }];
        saveClasses();
      }
    }

    function saveState() {
      const key = cKey(currentClassId);
      const payload = JSON.stringify(state);
      try {
        localStorage.setItem(key, payload);
      } catch (err) {
        console.error('saveState quota error', err);
        alert('ä¿å­˜å¤±è´¥ï¼šæµè§ˆå™¨æœ¬åœ°å­˜å‚¨å·²æ»¡ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½æˆ–åˆ é™¤éƒ¨åˆ†å†å²è®°å½•åå†å°è¯•ã€‚\n\næç¤ºï¼šå¯åœ¨â€œç§¯åˆ†å†å²/å•†åŸå…‘æ¢è®°å½•â€ä¸­æ¸…ç†æ—§è®°å½•ï¼Œæˆ–ä½¿ç”¨å³ä¸Šè§’â€œå¯¼å‡ºâ€æŒ‰é’®å…ˆå¤‡ä»½ã€‚');
        return;
      }
      renderAll();
      // è‡ªåŠ¨å¤‡ä»½ï¼ˆä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹å¤‡ä»½ï¼‰
      debouncedAutoBackup();
    }

    // ==================== è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½ ====================
    let backupFolderHandle = null;
    let backupInProgress = false;

    // åŠ è½½å¤‡ä»½æ–‡ä»¶å¤¹å¥æŸ„
    async function loadBackupFolderHandle() {
      try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(BACKUP_FOLDER_STORE, 'readonly');
          const store = tx.objectStore(BACKUP_FOLDER_STORE);
          const req = store.get('folder_handle');
          
          req.onsuccess = () => {
            if (req.result) {
              // File System Access API çš„å¥æŸ„éœ€è¦é‡æ–°éªŒè¯æƒé™
              if ('requestPermission' in req.result) {
                req.result.requestPermission({ mode: 'readwrite' }).then(permission => {
                  if (permission === 'granted') {
                    backupFolderHandle = req.result;
                    updateBackupButtonStatus();
                    resolve(req.result);
                  } else {
                    backupFolderHandle = null;
                    updateBackupButtonStatus();
                    resolve(null);
                  }
                }).catch(() => {
                  backupFolderHandle = null;
                  updateBackupButtonStatus();
                  resolve(null);
                });
              } else {
                backupFolderHandle = req.result;
                updateBackupButtonStatus();
                resolve(req.result);
              }
            } else {
              backupFolderHandle = null;
              updateBackupButtonStatus();
              resolve(null);
            }
          };
          
          req.onerror = () => {
            backupFolderHandle = null;
            updateBackupButtonStatus();
            resolve(null);
          };
        });
      } catch (error) {
        console.warn('åŠ è½½å¤‡ä»½æ–‡ä»¶å¤¹å¥æŸ„å¤±è´¥:', error);
        backupFolderHandle = null;
        updateBackupButtonStatus();
        return null;
      }
    }

    // æ›´æ–°å¤‡ä»½æŒ‰é’®çŠ¶æ€
    function updateBackupButtonStatus() {
      const btn = $('#backupSettingsBtn');
      if (!btn) return;
      
      // æ›´æ–°çº¢è‰²æç¤ºçš„æ˜¾ç¤ºçŠ¶æ€
      const warning = $('#backupWarning');
      const inlineWarning = $('#backupInlineWarning');
      if (warning) {
        warning.style.display = backupFolderHandle ? 'none' : 'block';
      }
      if (inlineWarning) {
        inlineWarning.style.display = backupFolderHandle ? 'none' : 'inline';
      }
      
      if (backupFolderHandle) {
        btn.textContent = 'ğŸ’¾ å¤‡ä»½å·²è®¾ç½®';
        btn.title = 'è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨ï¼Œæ¯æ¬¡æ“ä½œä¼šè‡ªåŠ¨ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼ˆæœ€å¤šä¿ç•™5ä¸ªå¤‡ä»½ï¼‰';
        btn.style.color = 'var(--success)';
      } else {
        btn.textContent = 'ğŸ’¾ å¤‡ä»½è®¾ç½®';
        btn.title = 'è®¾ç½®è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶å¤¹ï¼ˆæ¯æ¬¡æ“ä½œè‡ªåŠ¨ä¿å­˜ï¼Œæœ€å¤šä¿ç•™5ä¸ªå¤‡ä»½ï¼‰';
        btn.style.color = '';
      }
    }

    // ä¿å­˜å¤‡ä»½æ–‡ä»¶å¤¹å¥æŸ„
    async function saveBackupFolderHandle(handle) {
      try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(BACKUP_FOLDER_STORE, 'readwrite');
          const store = tx.objectStore(BACKUP_FOLDER_STORE);
          const req = store.put(handle, 'folder_handle');
          
          req.onsuccess = () => {
            backupFolderHandle = handle;
            resolve();
          };
          
          req.onerror = () => {
            reject(req.error);
          };
        });
      } catch (error) {
        console.error('ä¿å­˜å¤‡ä»½æ–‡ä»¶å¤¹å¥æŸ„å¤±è´¥:', error);
        throw error;
      }
    }

    // é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹
    async function selectBackupFolder() {
      try {
        if (!window.showDirectoryPicker) {
          alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®APIï¼Œæ— æ³•ä½¿ç”¨è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½ã€‚\nè¯·ä½¿ç”¨ Chrome 86+ã€Edge 86+ æˆ–å…¶ä»–åŸºäº Chromium çš„æµè§ˆå™¨ã€‚');
          return;
        }

        const handle = await window.showDirectoryPicker({
          mode: 'readwrite'
        });
        
        await saveBackupFolderHandle(handle);
        updateBackupButtonStatus();
        toast('âœ… å¤‡ä»½æ–‡ä»¶å¤¹å·²è®¾ç½®ï¼Œå°†è‡ªåŠ¨ä¿å­˜å¤‡ä»½æ–‡ä»¶');
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡å¤‡ä»½
        autoBackup();
      } catch (error) {
        if (error.name === 'AbortError') {
          // ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©
          return;
        }
        console.error('é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹å¤±è´¥:', error);
        alert('é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥ï¼š' + error.message);
      }
    }

    // è‡ªåŠ¨å¤‡ä»½å‡½æ•°
    async function autoBackup() {
      // é˜²æ­¢é‡å¤å¤‡ä»½
      if (backupInProgress) return;
      
      // å¦‚æœæ²¡æœ‰è®¾ç½®å¤‡ä»½æ–‡ä»¶å¤¹ï¼Œè·³è¿‡
      if (!backupFolderHandle) {
        // å°è¯•åŠ è½½å·²ä¿å­˜çš„å¥æŸ„
        await loadBackupFolderHandle();
        if (!backupFolderHandle) {
          return; // ä»ç„¶æ²¡æœ‰ï¼Œè·³è¿‡å¤‡ä»½
        }
      }

      backupInProgress = true;

      try {
        // éªŒè¯æƒé™
        if ('requestPermission' in backupFolderHandle) {
          const permission = await backupFolderHandle.requestPermission({ mode: 'readwrite' });
          if (permission !== 'granted') {
            console.warn('å¤‡ä»½æ–‡ä»¶å¤¹æƒé™è¢«æ‹’ç»');
            backupFolderHandle = null;
            backupInProgress = false;
            return;
          }
        }

        // å‡†å¤‡å¤‡ä»½æ•°æ®
        const avatarBundle = {};
        const processedKeys = new Set();
        
        for (const student of state.students) {
          if (!student?.avatarKey || processedKeys.has(student.avatarKey)) continue;
          const dataUrl = await getAvatarDataUrl(student.avatarKey);
          if (dataUrl) {
            avatarBundle[student.avatarKey] = dataUrl;
            processedKeys.add(student.avatarKey);
          }
        }

        const data = {
          version: '1.2',
          exportTime: now(),
          className: getClass().name,
          state: state,
          pointHistory: pointHistory, // ä¸ªäººå†å²ä¸€èµ·å¤‡ä»½
          mallItems: mallItems,
          avatars: avatarBundle
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });

        // ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
        const timestamp = new Date();
        const dateStr = timestamp.toISOString().slice(0, 10).replace(/-/g, '-');
        const timeStr = timestamp.toTimeString().slice(0, 8).replace(/:/g, '-');
        const fileName = `ç­çº§ç§¯åˆ†å¤‡ä»½_${dateStr}_${timeStr}.json`;

        // å†™å…¥æ–‡ä»¶
        const fileHandle = await backupFolderHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();

        // ç®¡ç†å¤‡ä»½æ–‡ä»¶æ•°é‡ï¼ˆä¿ç•™æœ€æ–°çš„5ä¸ªï¼‰
        await manageBackupFiles();

        console.log('è‡ªåŠ¨å¤‡ä»½æˆåŠŸ:', fileName);
      } catch (error) {
        console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
        // é™é»˜å¤±è´¥ï¼Œä¸æ‰“æ‰°ç”¨æˆ·
        // å¦‚æœæƒé™é—®é¢˜ï¼Œæ¸…é™¤å¥æŸ„
        if (error.name === 'NotAllowedError' || error.name === 'SecurityError') {
          backupFolderHandle = null;
        }
      } finally {
        backupInProgress = false;
      }
    }

    // ç®¡ç†å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™æœ€æ–°çš„5ä¸ªï¼‰
    async function manageBackupFiles() {
      try {
        const files = [];
        
        // éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        for await (const entry of backupFolderHandle.values()) {
          if (entry.kind === 'file' && entry.name.startsWith('ç­çº§ç§¯åˆ†å¤‡ä»½_') && entry.name.endsWith('.json')) {
            const file = await entry.getFile();
            files.push({
              name: entry.name,
              handle: entry,
              lastModified: file.lastModified
            });
          }
        }

        // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        files.sort((a, b) => b.lastModified - a.lastModified);

        // å¦‚æœè¶…è¿‡5ä¸ªï¼Œåˆ é™¤æœ€æ—§çš„
        if (files.length > BACKUP_MAX_FILES) {
          const filesToDelete = files.slice(BACKUP_MAX_FILES);
          for (const fileInfo of filesToDelete) {
            try {
              await backupFolderHandle.removeEntry(fileInfo.name);
              console.log('å·²åˆ é™¤æ—§å¤‡ä»½:', fileInfo.name);
            } catch (error) {
              console.warn('åˆ é™¤æ—§å¤‡ä»½å¤±è´¥:', fileInfo.name, error);
            }
          }
        }
      } catch (error) {
        console.warn('ç®¡ç†å¤‡ä»½æ–‡ä»¶å¤±è´¥:', error);
      }
    }

    function loadState() {
      try {
        state = JSON.parse(localStorage.getItem(cKey(currentClassId)) || 'null') || defaultState();
      } catch {
        state = defaultState();
      }
      
      state.students ||= [];
      state.groups ||= [];
      state.rules ||= [];
      state.history ||= [];
    }

    function getClass() {
      return classes.find(c => c.id === currentClassId) || { name: 'æœªçŸ¥ç­çº§' };
    }

    // ==================== ç­çº§ç®¡ç† ====================
    function refreshClassOptions() {
      const sel = $('#classSel');
      sel.innerHTML = classes.map(c => 
        `<option value="${c.id}" ${c.id === currentClassId ? 'selected' : ''}>${c.name}</option>`
      ).join('');
    }

    function addClass() {
      const name = prompt('è¾“å…¥ç­çº§åç§°ï¼š', 'æ–°ç­çº§');
      if (!name) return;
      
      const id = gid();
      classes.push({ id, name: name.trim() });
      saveClasses();
      currentClassId = id;
      localStorage.setItem(CURRENT_CLASS_KEY, currentClassId);
      refreshClassOptions();
      loadState();
      renderAll();
      toast(`å·²åˆ›å»ºç­çº§ï¼š${name}`);
    }

    function deleteClass() {
      if (!checkPassword()) return;
      
      if (classes.length === 1) {
        alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªç­çº§');
        return;
      }
      
      const c = getClass();
      if (!confirm(`ç¡®å®šåˆ é™¤ç­çº§"${c.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      localStorage.removeItem(cKey(currentClassId));
      classes = classes.filter(x => x.id !== currentClassId);
      saveClasses();
      
      currentClassId = classes[0].id;
      localStorage.setItem(CURRENT_CLASS_KEY, currentClassId);
      refreshClassOptions();
      loadState();
      renderAll();
      toast('ç­çº§å·²åˆ é™¤');
    }

    function switchClass(classId) {
      currentClassId = classId;
      localStorage.setItem(CURRENT_CLASS_KEY, currentClassId);
      selectedStudentIds.clear(); // åˆ‡æ¢ç­çº§æ—¶æ¸…ç©ºå·²é€‰
      loadState();
      renderAll();
    }

    // ==================== å­¦ç”Ÿç®¡ç† ====================
    function addStudent() {
      const name = prompt('è¾“å…¥å­¦ç”Ÿå§“åï¼š');
      if (!name || !name.trim()) return;
      
      const id = gid();
      state.students.push({
        id,
        name: name.trim(),
        points: 0,
        totalEarned: 0,  // å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆç”¨äºæ’åï¼‰
        groupId: null,
        avatarKey: null
      });
      
      state.history.unshift({
        id: gid(),
        time: now(),
        title: 'æ·»åŠ å­¦ç”Ÿ',
        detail: name.trim(),
        delta: 0
      });
      
      saveState();
      toast(`å·²æ·»åŠ å­¦ç”Ÿï¼š${name}`);
    }

    function openBatchAdd() {
      openModal('æ‰¹é‡æ·»åŠ å­¦ç”Ÿ', `
        <div class="subtle">æ¯è¡Œä¸€ä¸ªå§“åï¼Œæ”¯æŒç©ºæ ¼/é€—å·åˆ†éš”</div>
        <textarea id="batchNames" rows="8" style="width:100%;margin-top:8px" placeholder="å¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
      `);
      
      $('#modalOk').onclick = () => {
        const text = $('#batchNames').value || '';
        const lines = text.split(/[\n\r,ï¼Œã€\s]+/).map(s => s.trim()).filter(Boolean);
        
        if (lines.length === 0) {
          alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå§“å');
          return;
        }
        
        lines.forEach(name => {
          const id = gid();
          state.students.push({
            id,
            name,
            points: 0,
            totalEarned: 0,  // å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆç”¨äºæ’åï¼‰
            groupId: null,
            avatarKey: null
          });
        });
        
        state.history.unshift({
          id: gid(),
          time: now(),
          title: 'æ‰¹é‡æ·»åŠ å­¦ç”Ÿ',
          detail: `${lines.length}åå­¦ç”Ÿ`,
          delta: 0
        });
        
        saveState();
        closeModal();
        toast(`å·²æ·»åŠ  ${lines.length} åå­¦ç”Ÿ`);
      };
    }

    function openEditStudent(studentId) {
      const s = state.students.find(x => x.id === studentId);
      if (!s) return;
      
      openModal(`ç¼–è¾‘å­¦ç”Ÿï¼š${s.name}`, `
        <div style="display: flex; gap: 20px;">
          <div style="width: 180px;">
            <div class="avatar" style="width: 140px; height: 140px; margin: 0 auto 12px;">
              <img id="editAvaPrev" style="width: 100%; height: 100%; object-fit: cover;" src="${placeholderAvatar(s.name)}"/>
            </div>
            <input id="editAvaFile" type="file" accept="image/*" style="width: 100%; font-size: 13px;"/>
            <div class="subtle" style="margin-top: 8px; font-size: 12px;">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</div>
          </div>
          <div style="flex: 1; display: flex; flex-direction: column; gap: 12px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">å­¦ç”Ÿå§“å</label>
              <input id="editName" value="${s.name}" placeholder="è¾“å…¥å­¦ç”Ÿå§“å"/>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">æ‰€å±å°ç»„</label>
              <select id="editGroupSel">
                <option value="">æœªåˆ†ç»„</option>
                ${state.groups.map(g => {
                  const selected = (g.members || []).includes(s.id) ? 'selected' : '';
                  return `<option value="${g.id}" ${selected}>${g.name}</option>`;
                }).join('')}
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">å½“å‰ç§¯åˆ†</label>
              <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${s.points || 0} åˆ†</div>
            </div>
          </div>
        </div>
      `);
      
      // åŠ è½½ç°æœ‰å¤´åƒ
      if (s.avatarKey) {
        const previewImg = $('#editAvaPrev');
        // ä¼˜å…ˆä» localStorage è¯»å– base64
        if (s.avatarBase64) {
          const base64Data = localStorage.getItem(`avatar_${s.avatarKey}`);
          if (base64Data) {
            previewImg.src = base64Data;
            console.log('å·²åŠ è½½å¤´åƒé¢„è§ˆ (base64)');
          }
        } else {
          // ä» IndexedDB è¯»å–
          getAvatar(s.avatarKey).then(blob => {
            if (blob) {
              previewImg.src = URL.createObjectURL(blob);
              console.log('å·²åŠ è½½å¤´åƒé¢„è§ˆ (blob)');
            }
          }).catch(e => console.error('åŠ è½½å¤´åƒå¤±è´¥:', e));
        }
      }
      
      // å¤´åƒé¢„è§ˆ
      $('#editAvaFile').onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // é¢„è§ˆ
        const reader = new FileReader();
        reader.onload = () => {
          $('#editAvaPrev').src = reader.result;
        };
        reader.readAsDataURL(file);
      };
      
      $('#modalOk').onclick = async () => {
        try {
          const newName = $('#editName').value.trim();
          if (!newName) {
            alert('å§“åä¸èƒ½ä¸ºç©º');
            return;
          }
          
          // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
          const okBtn = $('#modalOk');
          const originalText = okBtn.textContent;
          okBtn.disabled = true;
          okBtn.textContent = 'ä¿å­˜ä¸­...';
          
          const oldName = s.name;
          s.name = newName;
          
          // å¤„ç†å¤´åƒä¸Šä¼ 
          const file = $('#editAvaFile').files?.[0];
          if (file) {
            try {
              okBtn.textContent = 'ä¸Šä¼ å¤´åƒä¸­...';
              console.log('å‡†å¤‡ä¸Šä¼ å¤´åƒï¼Œæ–‡ä»¶å¤§å°:', file.size, 'ç±»å‹:', file.type);
              
              // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
              if (file.size > 5 * 1024 * 1024) {
                throw new Error('å›¾ç‰‡æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
              }
              
              // åˆ é™¤æ—§å¤´åƒï¼ˆé‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼‰
              if (s.avatarKey) {
                console.log('åˆ é™¤æ—§å¤´åƒ:', s.avatarKey);
                try {
                  await delAvatar(s.avatarKey);
                  localStorage.removeItem(`avatar_${s.avatarKey}`);
                  delete s.avatarBase64;
                  console.log('âœ… æ—§å¤´åƒå·²åˆ é™¤');
                } catch (e) {
                  console.warn('åˆ é™¤æ—§å¤´åƒå¤±è´¥:', e);
                }
              }
              
              // å‹ç¼©å›¾ç‰‡
              console.log('å¼€å§‹å‹ç¼©å›¾ç‰‡...');
              const compressedFile = await compressImage(file, 0.7, 800);
              console.log('å‹ç¼©å®Œæˆï¼ŒåŸå¤§å°:', file.size, 'å‹ç¼©å:', compressedFile.size);
              
              // è½¬æ¢ä¸º base64
              console.log('å¼€å§‹è½¬æ¢å›¾ç‰‡ä¸º base64...');
              const reader = new FileReader();
              const base64Promise = new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                reader.readAsDataURL(compressedFile);
              });
              
              const base64Data = await base64Promise;
              const key = `ava_${currentClassId}_${s.id}_${Date.now()}`;
              
              console.log('å¼€å§‹ä¿å­˜å¤´åƒ...');
              
              // ç›´æ¥ä½¿ç”¨ localStorage å­˜å‚¨ base64ï¼ˆæ›´å¯é ï¼‰
              try {
                localStorage.setItem(`avatar_${key}`, base64Data);
                s.avatarKey = key;
                s.avatarBase64 = true; // æ ‡è®°ä½¿ç”¨ base64
                console.log('âœ… å¤´åƒå·²ä¿å­˜åˆ° localStorage (base64):', key);
              } catch (storageError) {
                console.error('localStorage ä¿å­˜å¤±è´¥:', storageError);
                // å¦‚æœ localStorage å¤±è´¥ï¼Œå°è¯• IndexedDB
                try {
                  const blob = new Blob([await file.arrayBuffer()], { 
                    type: file.type || 'image/jpeg' 
                  });
                  await putAvatar(key, blob);
                  s.avatarKey = key;
                  delete s.avatarBase64;
                  console.log('âœ… å¤´åƒå·²ä¿å­˜åˆ° IndexedDB:', key);
                } catch (indexedDBError) {
                  console.error('IndexedDB ä¹Ÿå¤±è´¥äº†:', indexedDBError);
                  throw new Error('å­˜å‚¨ç©ºé—´ä¸è¶³æˆ–æµè§ˆå™¨é™åˆ¶ï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡');
                }
              }
            } catch (err) {
              console.error('âŒ å¤´åƒä¸Šä¼ å¤±è´¥:', err);
              
              let errorMsg = 'å¤´åƒä¸Šä¼ å¤±è´¥ï¼š\n' + err.message;
              
              if (err.message.includes('quota') || err.message.includes('å­˜å‚¨ç©ºé—´')) {
                errorMsg += '\n\nğŸ’¡ å»ºè®®ï¼š\n1. ç‚¹å‡»è®¾ç½® â†’ "æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒ"æŒ‰é’®\n2. æ¸…ç†å®Œæˆåé‡è¯•ä¸Šä¼ \n3. æˆ–é€‰æ‹©æ›´å°çš„å›¾ç‰‡ï¼ˆæ¨èå°äº500KBï¼‰';
              } else {
                errorMsg += '\n\nè¯·å°è¯•ï¼š\n1. é€‰æ‹©æ›´å°çš„å›¾ç‰‡\n2. åˆ·æ–°é¡µé¢åé‡è¯•';
              }
              
              alert(errorMsg);
              okBtn.disabled = false;
              okBtn.textContent = originalText;
              return;
            }
          }
          
          // å¤„ç†å°ç»„
          const newGroupId = $('#editGroupSel').value;
          state.groups.forEach(g => {
            g.members = (g.members || []).filter(mid => mid !== s.id);
          });
          if (newGroupId) {
            const g = state.groups.find(x => x.id === newGroupId);
            if (g) {
              g.members ||= [];
              g.members.push(s.id);
            }
          }
          s.groupId = newGroupId || null;
          
          // è®°å½•å†å²
          if (oldName !== newName) {
            state.history.unshift({
              id: gid(),
              time: now(),
              title: 'ç¼–è¾‘å­¦ç”Ÿ',
              detail: `${oldName} â†’ ${newName}`,
              delta: 0
            });
          }
          
          console.log('ä¿å­˜å­¦ç”Ÿä¿¡æ¯åˆ° state...');
          saveState();
          
          console.log('åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨...');
          // å…ˆåˆ·æ–°å­¦ç”Ÿåˆ—è¡¨ï¼Œç¡®ä¿æ–°å¤´åƒæ˜¾ç¤º
          await renderStudents();
          console.log('âœ… å­¦ç”Ÿåˆ—è¡¨å·²åˆ·æ–°');
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿å¤´åƒå®Œå…¨åŠ è½½
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          okBtn.disabled = false;
          okBtn.textContent = originalText;
          
          console.log('å…³é—­æ¨¡æ€æ¡†...');
          closeModal();
          
          console.log('âœ… æ‰€æœ‰æ“ä½œå®Œæˆ');
          toast(`âœ… å·²æ›´æ–°ï¼š${s.name}`);
          
        } catch (error) {
          console.error('âŒ ä¿å­˜å¤±è´¥:', error);
          alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
          const okBtn = $('#modalOk');
          if (okBtn) {
            okBtn.disabled = false;
            okBtn.textContent = 'ç¡®å®š';
          }
        }
      };
    }

    function removeStudent(studentId) {
      const s = state.students.find(x => x.id === studentId);
      if (!s) return;
      
      if (!confirm(`âš ï¸ ç¡®å®šåˆ é™¤å­¦ç”Ÿ"${s.name}"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤è¯¥å­¦ç”Ÿçš„æ‰€æœ‰æ•°æ®\nâ€¢ ä»æ‰€æœ‰å°ç»„ä¸­ç§»é™¤\nâ€¢ åˆ é™¤è¯¥å­¦ç”Ÿçš„å¤´åƒ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      // ä½¿ç”¨å¯†ç éªŒè¯
      checkPassword(true, () => {
        // å¯†ç éªŒè¯é€šè¿‡åæ‰§è¡Œåˆ é™¤
        if (s.avatarKey) delAvatar(s.avatarKey);
        
        selectedStudentIds.delete(studentId);
        state.students = state.students.filter(x => x.id !== studentId);
        
        state.groups.forEach(g => {
          g.members = (g.members || []).filter(mid => mid !== studentId);
        });
        
        state.history.unshift({
          id: gid(),
          time: now(),
          title: 'åˆ é™¤å­¦ç”Ÿ',
          detail: s.name,
          delta: 0
        });
        
        saveState();
        toast(`âœ… å·²åˆ é™¤å­¦ç”Ÿï¼š${s.name}`);
        renderAll();
      });
    }

    // ==================== ç§¯åˆ†å†å²ç®¡ç† ====================
    function loadPointHistory() {
      try {
        pointHistory = JSON.parse(localStorage.getItem(POINT_HISTORY_KEY) || '{}');
      } catch {
        pointHistory = {};
      }
    }

    function savePointHistory() {
      localStorage.setItem(POINT_HISTORY_KEY, JSON.stringify(pointHistory));
      // ç§¯åˆ†å†å²å˜åŒ–æ—¶ä¹Ÿè§¦å‘å¤‡ä»½ï¼ˆä½†ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹å¤‡ä»½ï¼‰
      debouncedAutoBackup();
    }

    // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹å¤‡ä»½
    let backupTimer = null;
    function debouncedAutoBackup() {
      if (backupTimer) {
        clearTimeout(backupTimer);
      }
      // 3ç§’å†…çš„å¤šæ¬¡æ“ä½œåªå¤‡ä»½ä¸€æ¬¡
      backupTimer = setTimeout(() => {
        autoBackup();
        backupTimer = null;
      }, 3000);
    }

    function recordPointChange(studentId, delta, reason, changeType = 'adjust') {
      pointHistory[studentId] ||= [];
      pointHistory[studentId].push({
        id: gid(),
        time: now(),
        timestamp: Date.now(),
        delta: delta,
        reason: reason,
        type: changeType
      });
      savePointHistory();
    }

    // ==================== ç§¯åˆ†ç®¡ç† ====================
    function getChecked() {
      return Array.from(selectedStudentIds);
    }

    function allClassAdjust(type) {
      if (state.students.length === 0) {
        alert('ç­çº§ä¸­è¿˜æ²¡æœ‰å­¦ç”Ÿ');
        return;
      }
      
      const allStudentIds = state.students.map(s => s.id);
      const isAdd = type === 'add';
      const title = isAdd ? 'â• å…¨ç­åŠ åˆ†' : 'â– å…¨ç­å‡åˆ†';
      
      // ç­›é€‰è§„åˆ™ï¼šåŠ åˆ†æ˜¾ç¤ºæ­£åˆ†è§„åˆ™ï¼Œå‡åˆ†æ˜¾ç¤ºè´Ÿåˆ†è§„åˆ™
      const filteredRules = state.rules.filter(r => {
        const delta = Number(r.delta);
        if (isAdd) return delta > 0;
        else return delta < 0;
      });

      if (filteredRules.length === 0) {
        alert(`è¿˜æ²¡æœ‰${isAdd ? 'åŠ åˆ†' : 'å‡åˆ†'}è§„åˆ™ï¼Œè¯·å…ˆåœ¨ç§¯åˆ†è§„åˆ™ä¸­åˆ›å»º`);
        return;
      }

      openModal(`${title}ï¼ˆå…±${state.students.length}äººï¼‰`, `
        <div style="margin-bottom: 16px;">
          <div class="subtle" style="margin-bottom: 12px;">é€‰æ‹©è¦åº”ç”¨çš„ç§¯åˆ†è§„åˆ™ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œå°†åº”ç”¨åˆ°å…¨ç­æ‰€æœ‰å­¦ç”Ÿï¼š</div>
          <div style="max-height: 500px; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
              ${filteredRules.map(r => `
                <label class="rule-select-card" style="display: flex; flex-direction: column; align-items: stretch; padding: 16px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white; position: relative;">
                  <input type="checkbox" class="rule-check" data-rule-id="${r.id}" style="position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; cursor: pointer;">
                  <div style="text-align: center; margin-top: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 8px; min-height: 40px; display: flex; align-items: center; justify-content: center;">${r.name}</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${Number(r.delta) > 0 ? 'var(--success)' : 'var(--danger)'};">
                      ${Number(r.delta) > 0 ? '+' : ''}${r.delta} åˆ†
                    </div>
                  </div>
                </label>
              `).join('')}
            </div>
          </div>
        </div>
      `);

      $('#modalOk').onclick = () => {
        const checkedRules = Array.from($$('.rule-check:checked')).map(el => {
          const ruleId = el.dataset.ruleId;
          return state.rules.find(r => r.id === ruleId);
        }).filter(Boolean);

        if (checkedRules.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§„åˆ™');
          return;
        }

        // åº”ç”¨æ‰€æœ‰é€‰ä¸­çš„è§„åˆ™åˆ°å…¨ç­
        const totalDelta = checkedRules.reduce((sum, r) => sum + Number(r.delta), 0);
        const ruleNames = `å…¨ç­ ` + checkedRules.map(r => r.name).join('ã€');
        const allNames = state.students.map(s => s.name).join('ã€');

        state.students.forEach(s => {
          // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
          if (s.totalEarned === undefined) {
            s.totalEarned = s.points || 0;
          }
          
          // æ›´æ–°å¯ç”¨ç§¯åˆ†å’Œå†å²ç´¯è®¡ç§¯åˆ†
          s.points = (Number(s.points) || 0) + totalDelta;
          s.totalEarned = (Number(s.totalEarned) || 0) + totalDelta;
          
          recordPointChange(s.id, totalDelta, ruleNames);
        });

        state.history.unshift({
          id: gid(),
          time: now(),
          title: ruleNames,
          detail: `å­¦ç”Ÿï¼š${allNames}`,
          delta: totalDelta,
          studentIds: allStudentIds
        });

        saveState();
        closeModal();
        renderAll();
        toast(`å…¨ç­ ${totalDelta > 0 ? '+' : ''}${totalDelta} åˆ†`);
      };
    }

    function openQuickAdjust(studentIds, type) {
      if (!Array.isArray(studentIds) || studentIds.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€åå­¦ç”Ÿ');
        return;
      }

      const students = studentIds.map(id => state.students.find(s => s.id === id)).filter(Boolean);
      if (students.length === 0) return;

      const studentNames = students.map(s => s.name).join('ã€');
      const isAdd = type === 'add';
      const title = isAdd ? 'â• åŠ åˆ†' : 'â– å‡åˆ†';
      
      // ç­›é€‰è§„åˆ™ï¼šåŠ åˆ†æ˜¾ç¤ºæ­£åˆ†è§„åˆ™ï¼Œå‡åˆ†æ˜¾ç¤ºè´Ÿåˆ†è§„åˆ™
      const filteredRules = state.rules.filter(r => {
        const delta = Number(r.delta);
        if (isAdd) return delta > 0;
        else return delta < 0;
      });

      if (filteredRules.length === 0) {
        alert(`è¿˜æ²¡æœ‰${isAdd ? 'åŠ åˆ†' : 'å‡åˆ†'}è§„åˆ™ï¼Œè¯·å…ˆåœ¨ç§¯åˆ†è§„åˆ™ä¸­åˆ›å»º`);
        console.log('æ‰€æœ‰è§„åˆ™:', state.rules);
        console.log('ç­›é€‰åçš„è§„åˆ™:', filteredRules);
        console.log('ç±»å‹:', type, 'æ˜¯å¦åŠ åˆ†:', isAdd);
        return;
      }

      openModal(`${title} - ${studentNames}`, `
        <div style="margin-bottom: 16px;">
          <div class="subtle" style="margin-bottom: 12px;">é€‰æ‹©è¦åº”ç”¨çš„ç§¯åˆ†è§„åˆ™ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</div>
          <div style="max-height: 500px; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
              ${filteredRules.map(r => `
                <label class="rule-select-card" style="display: flex; flex-direction: column; align-items: stretch; padding: 16px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white; position: relative;">
                  <input type="checkbox" class="rule-check" data-rule-id="${r.id}" style="position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; cursor: pointer;">
                  <div style="text-align: center; margin-top: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 8px; min-height: 40px; display: flex; align-items: center; justify-content: center;">${r.name}</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${Number(r.delta) > 0 ? 'var(--success)' : 'var(--danger)'};">
                      ${Number(r.delta) > 0 ? '+' : ''}${r.delta} åˆ†
                    </div>
                  </div>
                </label>
              `).join('')}
            </div>
          </div>
        </div>
      `);

      $('#modalOk').onclick = () => {
        const checkedRules = Array.from($$('.rule-check:checked')).map(el => {
          const ruleId = el.dataset.ruleId;
          return state.rules.find(r => r.id === ruleId);
        }).filter(Boolean);

        if (checkedRules.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§„åˆ™');
          return;
        }

        // åº”ç”¨æ‰€æœ‰é€‰ä¸­çš„è§„åˆ™
        const totalDelta = checkedRules.reduce((sum, r) => sum + Number(r.delta), 0);
        const ruleNames = checkedRules.map(r => r.name).join('ã€');

        students.forEach(s => {
          // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
          if (s.totalEarned === undefined) {
            s.totalEarned = s.points || 0;
          }
          
          // æ›´æ–°å¯ç”¨ç§¯åˆ†å’Œå†å²ç´¯è®¡ç§¯åˆ†
          s.points = (Number(s.points) || 0) + totalDelta;
          s.totalEarned = (Number(s.totalEarned) || 0) + totalDelta;
          
          recordPointChange(s.id, totalDelta, ruleNames);
        });

        state.history.unshift({
          id: gid(),
          time: now(),
          title: ruleNames,
          detail: studentNames,
          delta: totalDelta,
          studentIds: studentIds
        });

        saveState();
        closeModal();
        toast(`${studentNames} ${totalDelta > 0 ? '+' : ''}${totalDelta} åˆ†`);
        
        // æ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬å¤é€‰æ¡†å’ŒselectedStudentIdsï¼‰
        $$('.check').forEach(c => c.checked = false);
        selectedStudentIds.clear();
        updateSelectedCount();
      };
    }

    function adjust(studentIds, delta, reason = 'å¿«é€Ÿè°ƒæ•´') {
      if (!Array.isArray(studentIds) || studentIds.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€åå­¦ç”Ÿ');
        return;
      }
      
      const names = [];
      
      studentIds.forEach(id => {
        const s = state.students.find(x => x.id === id);
        if (!s) return;
        
        // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
        if (s.totalEarned === undefined) {
          s.totalEarned = s.points || 0;
        }
        
        // æ›´æ–°å¯ç”¨ç§¯åˆ†
        s.points = (Number(s.points) || 0) + delta;
        
        // æ›´æ–°å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆç”¨äºæ’åï¼Œå…‘æ¢ä¸å½±å“æ­¤å€¼ï¼‰
        s.totalEarned = (Number(s.totalEarned) || 0) + delta;
        
        names.push(s.name);
        
        // è®°å½•ä¸ªäººç§¯åˆ†å†å²
        recordPointChange(id, delta, reason);
      });
      
      state.history.unshift({
        id: gid(),
        time: now(),
        title: reason,
        detail: names.join(', '),
        delta: delta,
        studentIds: studentIds
      });
      
      saveState();
      toast(`${names.join(', ')} ${delta > 0 ? '+' : ''}${delta} åˆ†`);
      
      // æ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬å¤é€‰æ¡†å’ŒselectedStudentIdsï¼‰
      $$('.check').forEach(c => c.checked = false);
      selectedStudentIds.clear();
      updateSelectedCount();
    }

    function openCustomAdjust() {
      const ids = getChecked();
      if (ids.length === 0) {
        alert('è¯·å…ˆå‹¾é€‰å­¦ç”Ÿ');
        return;
      }
      
      openModal('è‡ªå®šä¹‰è°ƒæ•´ç§¯åˆ†', `
        <div class="subtle">å·²é€‰ä¸­ ${ids.length} åå­¦ç”Ÿ</div>
        <input type="number" id="customDelta" placeholder="è¾“å…¥åˆ†å€¼ï¼ˆæ­£æ•°åŠ åˆ†ï¼Œè´Ÿæ•°æ‰£åˆ†ï¼‰" style="margin-top: 12px;" autofocus>
        <input type="text" id="customReason" placeholder="è°ƒæ•´åŸå› ï¼ˆå¯é€‰ï¼‰" style="margin-top: 8px;">
      `);
      
      $('#modalOk').onclick = () => {
        const delta = parseInt($('#customDelta').value) || 0;
        const reason = $('#customReason').value.trim() || 'è‡ªå®šä¹‰è°ƒæ•´';
        
        if (delta === 0) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†å€¼');
          return;
        }
        
        adjust(ids, delta, reason);
        closeModal();
      };
    }

    // ==================== å°ç»„ç®¡ç† ====================
    function createGroup() {
      const name = $('#newGroupName').value.trim();
      if (!name) {
        alert('è¯·è¾“å…¥å°ç»„å');
        return;
      }
      
      state.groups.push({
        id: gid(),
        name: name,
        members: []
      });
      
      $('#newGroupName').value = '';
      saveState();
      toast(`å·²åˆ›å»ºå°ç»„ï¼š${name}`);
    }

    function deleteGroup(groupId) {
      const g = state.groups.find(x => x.id === groupId);
      if (!g) return;
      
      if (!confirm(`ç¡®å®šåˆ é™¤å°ç»„"${g.name}"å—ï¼Ÿæˆå‘˜ä¸ä¼šè¢«åˆ é™¤ã€‚`)) {
        return;
      }
      
      state.groups = state.groups.filter(x => x.id !== groupId);
      saveState();
      toast(`å·²åˆ é™¤å°ç»„ï¼š${g.name}`);
    }

    function openGroupEdit(groupId) {
      const g = state.groups.find(x => x.id === groupId);
      if (!g) return;
      
      openModal(`ç¼–è¾‘å°ç»„ï¼š${g.name}`, `
        <div class="subtle" style="margin-bottom: 12px;">å‹¾é€‰å­¦ç”ŸåŠ å…¥æœ¬å°ç»„ï¼ˆå·²åœ¨å…¶ä»–ç»„çš„å­¦ç”Ÿä¸å¯é€‰ï¼‰</div>
        <div id="memberBox" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
          ${state.students.map(s => {
            const isInCurrentGroup = (g.members || []).includes(s.id);
            
            // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨å…¶ä»–å°ç»„
            let otherGroup = null;
            if (!isInCurrentGroup) {
              for (const group of state.groups) {
                if (group.id !== g.id && (group.members || []).includes(s.id)) {
                  otherGroup = group;
                  break;
                }
              }
            }
            
            const isDisabled = otherGroup !== null;
            const isChecked = isInCurrentGroup;
            const disabledAttr = isDisabled ? 'disabled' : '';
            const checkedAttr = isChecked ? 'checked' : '';
            const opacityStyle = isDisabled ? 'opacity: 0.5;' : '';
            const cursorStyle = isDisabled ? 'cursor: not-allowed;' : 'cursor: pointer;';
            
            return `
              <label style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; ${opacityStyle} ${cursorStyle} background: ${isDisabled ? '#f5f5f5' : 'white'}; transition: all 0.2s;" ${!isDisabled ? `onmouseover="this.style.background='var(--soft)'" onmouseout="this.style.background='white'"` : ''}>
                <input data-mid="${s.id}" type="checkbox" ${checkedAttr} ${disabledAttr} style="width: 18px; height: 18px; margin-right: 12px; ${cursorStyle}"/>
                <div style="flex: 1;">
                  <div style="font-weight: 500; font-size: 14px; color: ${isDisabled ? '#999' : '#333'}; margin-bottom: ${otherGroup ? '4px' : '0'};">
                    ${s.name}
                  </div>
                  ${otherGroup ? `<div style="font-size: 12px; color: #999;">å·²åœ¨ã€${otherGroup.name}ã€‘</div>` : ''}
                </div>
                ${isChecked ? '<span style="color: var(--primary); font-size: 12px;">âœ“ å½“å‰æˆå‘˜</span>' : ''}
              </label>
            `;
          }).join('')}
        </div>
      `);
      
      $('#modalOk').onclick = () => {
        const mids = Array.from($('#memberBox').querySelectorAll('input[type="checkbox"]:not([disabled])'))
          .filter(i => i.checked)
          .map(i => i.dataset.mid);
        
        // ä»å…¶ä»–å°ç»„ä¸­ç§»é™¤
        state.groups.forEach(gg => {
          gg.members = (gg.members || []).filter(mid => 
            !mids.includes(mid) || gg.id === g.id
          );
        });
        
        g.members = mids;
        
        state.history.unshift({
          id: gid(),
          time: now(),
          title: 'ç¼–è¾‘å°ç»„',
          detail: `${g.name}: ${mids.length}åæˆå‘˜`,
          delta: 0
        });
        
        saveState();
        renderAll();
        closeModal();
        toast(`å°ç»„"${g.name}"å·²æ›´æ–°ï¼Œå…±${mids.length}åæˆå‘˜`);
      };
    }

    function adjustGroupPoints(groupId, groupName, type) {
      const group = state.groups.find(g => g.id === groupId);
      if (!group || !group.members || group.members.length === 0) {
        alert('å°ç»„æ²¡æœ‰æˆå‘˜');
        return;
      }
      
      const memberStudents = (group.members || [])
        .map(id => state.students.find(s => s.id === id))
        .filter(Boolean);
      
      if (memberStudents.length === 0) {
        alert('å°ç»„æ²¡æœ‰æœ‰æ•ˆæˆå‘˜');
        return;
      }
      
      const isAdd = type === 'add';
      const title = isAdd ? 'â• å°ç»„åŠ åˆ†' : 'â– å°ç»„å‡åˆ†';
      
      // ç­›é€‰è§„åˆ™ï¼šåŠ åˆ†æ˜¾ç¤ºæ­£åˆ†è§„åˆ™ï¼Œå‡åˆ†æ˜¾ç¤ºè´Ÿåˆ†è§„åˆ™
      const filteredRules = state.rules.filter(r => {
        const delta = Number(r.delta);
        if (isAdd) return delta > 0;
        else return delta < 0;
      });

      if (filteredRules.length === 0) {
        alert(`è¿˜æ²¡æœ‰${isAdd ? 'åŠ åˆ†' : 'å‡åˆ†'}è§„åˆ™ï¼Œè¯·å…ˆåœ¨ç§¯åˆ†è§„åˆ™ä¸­åˆ›å»º`);
        return;
      }

      openModal(`${title} - ${groupName}ï¼ˆ${memberStudents.length}äººï¼‰`, `
        <div style="margin-bottom: 16px;">
          <div class="subtle" style="margin-bottom: 12px;">é€‰æ‹©è¦åº”ç”¨çš„ç§¯åˆ†è§„åˆ™ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œå°†åº”ç”¨åˆ°å°ç»„æ‰€æœ‰æˆå‘˜ï¼š</div>
          <div style="max-height: 500px; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
              ${filteredRules.map(r => `
                <label class="rule-select-card" style="display: flex; flex-direction: column; align-items: stretch; padding: 16px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white; position: relative;">
                  <input type="checkbox" class="rule-check" data-rule-id="${r.id}" style="position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; cursor: pointer;">
                  <div style="text-align: center; margin-top: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 8px; min-height: 40px; display: flex; align-items: center; justify-content: center;">${r.name}</div>
                    <div style="font-size: 28px; font-weight: 700; color: ${Number(r.delta) > 0 ? 'var(--success)' : 'var(--danger)'};">
                      ${Number(r.delta) > 0 ? '+' : ''}${r.delta} åˆ†
                    </div>
                  </div>
                </label>
              `).join('')}
            </div>
          </div>
        </div>
      `);

      $('#modalOk').onclick = () => {
        const checkedRules = Array.from($$('.rule-check:checked')).map(el => {
          const ruleId = el.dataset.ruleId;
          return state.rules.find(r => r.id === ruleId);
        }).filter(Boolean);

        if (checkedRules.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§„åˆ™');
          return;
        }

        // åº”ç”¨æ‰€æœ‰é€‰ä¸­çš„è§„åˆ™åˆ°å°ç»„æˆå‘˜
        const totalDelta = checkedRules.reduce((sum, r) => sum + Number(r.delta), 0);
        const ruleNames = `å°ç»„ã€${groupName}ã€‘` + checkedRules.map(r => r.name).join('ã€');
        const studentNames = memberStudents.map(s => s.name).join('ã€');

        memberStudents.forEach(s => {
          // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
          if (s.totalEarned === undefined) {
            s.totalEarned = s.points || 0;
          }
          
          // æ›´æ–°å¯ç”¨ç§¯åˆ†å’Œå†å²ç´¯è®¡ç§¯åˆ†
          s.points = (Number(s.points) || 0) + totalDelta;
          s.totalEarned = (Number(s.totalEarned) || 0) + totalDelta;
          
          recordPointChange(s.id, totalDelta, ruleNames);
        });

        state.history.unshift({
          id: gid(),
          time: now(),
          title: ruleNames,
          detail: `å­¦ç”Ÿï¼š${studentNames}`,
          delta: totalDelta,
          studentIds: group.members
        });

        saveState();
        closeModal();
        renderAll();
        toast(`å°ç»„ã€${groupName}ã€‘${totalDelta > 0 ? '+' : ''}${totalDelta} åˆ†`);
      };
    }

    // ==================== è§„åˆ™ç®¡ç† ====================
    function createRule() {
      const name = $('#newRuleName').value.trim();
      const points = parseInt($('#newRulePoints').value) || 0;
      
      if (!name) {
        alert('è¯·è¾“å…¥è§„åˆ™åç§°');
        return;
      }
      
      if (points === 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†å€¼');
        return;
      }
      
      state.rules.push({
        id: gid(),
        name: name,
        delta: points,
        desc: ''
      });
      
      $('#newRuleName').value = '';
      $('#newRulePoints').value = '';
      saveState();
      toast(`å·²æ·»åŠ è§„åˆ™ï¼š${name} (${points > 0 ? '+' : ''}${points}åˆ†)`);
    }

    function applyRule(ruleId) {
      const rule = state.rules.find(r => r.id === ruleId);
      if (!rule) return;
      
      const ids = getChecked();
      if (ids.length === 0) {
        alert('è¯·å…ˆå‹¾é€‰å­¦ç”Ÿ');
        return;
      }
      
      const delta = rule.delta || rule.points || 0; // å…¼å®¹æ—§æ•°æ®
      adjust(ids, delta, `è§„åˆ™ï¼š${rule.name}`);
    }

    function deleteRule(ruleId) {
      const rule = state.rules.find(r => r.id === ruleId);
      if (!rule) return;
      
      if (!confirm(`ç¡®å®šåˆ é™¤è§„åˆ™"${rule.name}"å—ï¼Ÿ`)) {
        return;
      }
      
      state.rules = state.rules.filter(r => r.id !== ruleId);
      saveState();
      toast(`å·²åˆ é™¤è§„åˆ™ï¼š${rule.name}`);
    }

    // ==================== æ›´æ–°é€‰ä¸­å­¦ç”Ÿæ•° ====================
    function updateSelectedCount() {
      const selectedDisplay = $('#selectedCountDisplay');
      if (selectedDisplay) {
        selectedDisplay.textContent = selectedStudentIds.size;
      }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰å½“å‰åˆ—è¡¨å­¦ç”Ÿ
    function toggleSelectAll() {
      const checkboxes = Array.from($$('#studentGrid .check'));
      if (!checkboxes.length) return;
      const allSelected = checkboxes.every(cb => cb.checked);
      checkboxes.forEach(cb => {
        cb.checked = !allSelected;
        if (!allSelected) {
          selectedStudentIds.add(cb.dataset.sid);
        } else {
          selectedStudentIds.delete(cb.dataset.sid);
        }
      });
      updateSelectedCount();
    }

    // ==================== UIæ¸²æŸ“ ====================
    async function renderStudents(filter = '') {
      const grid = $('#studentGrid');
      let students = state.students;
      
      // æ¸…ç†å·²åˆ é™¤å­¦ç”Ÿçš„é€‰ä¸­è®°å½•
      selectedStudentIds = new Set(Array.from(selectedStudentIds).filter(id => state.students.some(s => s.id === id)));
      
      // æ›´æ–°å­¦ç”Ÿæ€»æ•°æ˜¾ç¤º
      const totalCount = state.students.length;
      const countDisplay = $('#studentCountDisplay');
      if (countDisplay) {
        countDisplay.textContent = totalCount;
      }
      
      // é‡ç½®é€‰ä¸­å­¦ç”Ÿæ•°
      updateSelectedCount();
      
      if (students.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ‘¨â€ğŸ“</div>
            <div class="empty-state-text">è¿˜æ²¡æœ‰å­¦ç”Ÿ</div>
            <button onclick="addStudent()" class="btn primary">+ æ·»åŠ ç¬¬ä¸€ä¸ªå­¦ç”Ÿ</button>
          </div>
        `;
        return;
      }
      
      // åº”ç”¨æœç´¢è¿‡æ»¤
      if (filter) {
        students = students.filter(s => isNameMatch(s.name, filter));
      }
      
      if (students.length === 0 && filter) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ”</div>
            <div class="empty-state-text">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</div>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = students.map(s => {
        // ä½¿ç”¨å­¦ç”Ÿå¯¹è±¡ä¸Šçš„totalEarnedå­—æ®µï¼ˆæ’åç§¯åˆ†ï¼‰
        const totalEarned = s.totalEarned || s.points || 0;
        
        // è®¡ç®—æ®µä½
        const rankTier = calculateRankTier(totalEarned);
        
        return `
          <div class="card" data-id="${s.id}">
            <input type="checkbox" class="check" data-sid="${s.id}" ${selectedStudentIds.has(s.id) ? 'checked' : ''}>
            <div class="avatar" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…" style="border-color: ${rankTier.color}; cursor: pointer;" onclick="openEditStudent('${s.id}')">
              <img src="${placeholderAvatar(s.name)}" alt="${s.name}" data-student-id="${s.id}">
            </div>
            <div class="name">${s.name}</div>
            <div class="rank-tier" style="color: ${rankTier.color}; font-weight: bold;">
              ${rankTier.displayName}
            </div>
            <div class="rank-progress">
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${rankTier.progress}%; background: linear-gradient(90deg, ${rankTier.color}, ${rankTier.color}88);"></div>
              </div>
              <div class="progress-text">${rankTier.points}/${rankTier.max === Infinity ? 'âˆ' : rankTier.nextTierPoints}åˆ† (${rankTier.progress}%)</div>
            </div>
            
            <div class="card-actions">
              <button class="btn-add" onclick="openQuickAdjust(['${s.id}'], 'add')">åŠ åˆ†</button>
              <button class="btn-subtract" onclick="openQuickAdjust(['${s.id}'], 'subtract')">å‡åˆ†</button>
            </div>
            
            <div class="card-links">
              <button class="btn-text" onclick="showStudentHistory('${s.id}')">å†å²</button>
              <button class="btn-text" onclick="showStudentMall('${s.id}')">ç§¯åˆ†å•†åŸ</button>
            </div>
            
            <div class="card-bottom">
              <button class="btn-text" onclick="openEditStudent('${s.id}')">ç¼–è¾‘</button>
              <button class="btn-text" onclick="removeStudent('${s.id}')" style="color: var(--danger);">åˆ é™¤</button>
            </div>
            
            <div class="card-stats">
              <div><span>å¯ç”¨ç§¯åˆ†ï¼š</span><span>${s.points || 0}</span></div>
              <div><span>æ’åç§¯åˆ†ï¼š</span><span>${totalEarned}</span></div>
            </div>
          </div>
        `;
      }).join('');
      
      // åŠ è½½å¤´åƒ
      const imgs = grid.querySelectorAll('.avatar img');
      const loadPromises = Array.from(imgs).map(async (img) => {
        const sid = img.dataset.studentId;
        const student = students.find(s => s.id === sid);
        if (student?.avatarKey) {
          try {
            // å…ˆå°è¯•ä» localStorage è¯»å– base64
            if (student.avatarBase64) {
              const base64Data = localStorage.getItem(`avatar_${student.avatarKey}`);
              if (base64Data) {
                // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                return new Promise((resolve) => {
                  img.onload = () => resolve();
                  img.onerror = () => resolve();
                  img.src = base64Data;
                });
              }
            }
            
            // å¦‚æœä¸æ˜¯ base64ï¼Œä» IndexedDB è¯»å–
            const blob = await getAvatar(student.avatarKey);
            if (blob) {
              const url = URL.createObjectURL(blob);
              return new Promise((resolve) => {
                img.onload = () => resolve();
                img.onerror = () => resolve();
                img.src = url;
              });
            }
          } catch (e) {
            console.error('Failed to load avatar:', e);
          }
        }
        return Promise.resolve();
      });
      
      await Promise.all(loadPromises);
      
      // æ·»åŠ å¤é€‰æ¡†å˜åŒ–ç›‘å¬å™¨
      grid.querySelectorAll('.check').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const id = e.target.dataset.sid;
          if (e.target.checked) {
            selectedStudentIds.add(id);
          } else {
            selectedStudentIds.delete(id);
          }
          updateSelectedCount();
        });
      });
    }

    function renderGroups() {
      const list = $('#groupList');
      const groups = state.groups;
      
      if (groups.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-text">è¿˜æ²¡æœ‰å°ç»„ï¼Œè¯·å…ˆåˆ›å»º</div>
          </div>
        `;
        return;
      }
      
      list.innerHTML = groups.map(g => {
        const memberCount = (g.members || []).length;
        const members = (g.members || [])
          .map(mid => state.students.find(s => s.id === mid))
          .filter(Boolean);
        
        // è®¡ç®—å°ç»„æ€»ç§¯åˆ†ï¼ˆåŸºäºå¯ç”¨ç§¯åˆ†ï¼‰
        const totalPoints = members.reduce((sum, s) => sum + (s.points || 0), 0);
        
        // è®¡ç®—å°ç»„æ’åç§¯åˆ†ï¼ˆåŸºäºæˆå‘˜çš„totalEarnedï¼‰
        const totalEarned = members.reduce((sum, s) => sum + (s.totalEarned || s.points || 0), 0);
        
        // è®¡ç®—å°ç»„å¹³å‡ç§¯åˆ†ï¼ˆç”¨äºæ®µä½è®¡ç®—ï¼‰
        const avgEarned = memberCount > 0 ? Math.round(totalEarned / memberCount) : 0;
        
        // è®¡ç®—å°ç»„æ®µä½ï¼ˆåŸºäºå¹³å‡ç§¯åˆ†ï¼‰
        const rankTier = calculateRankTier(avgEarned);
        
        return `
          <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div class="name" style="text-align: left;">${g.name}</div>
              <div class="subtle">æˆå‘˜: ${memberCount} äºº | æ€»ç§¯åˆ†: ${totalEarned} | äººå‡: ${avgEarned}åˆ†</div>
              <div style="margin-top: 6px;">
                <span style="color: ${rankTier.color}; font-weight: 600; font-size: 13px;">
                  ${rankTier.displayName}
                </span>
                <span style="font-size: 10px; color: var(--muted); margin-left: 4px;">(åŸºäºäººå‡)</span>
                ${rankTier.nextTierPoints ? 
                  `<span style="font-size: 11px; color: var(--muted); margin-left: 8px;">
                    è·ç¦»ä¸‹ä¸€æ®µä½è¿˜éœ€ ${Math.ceil(rankTier.pointsToNext / memberCount)}åˆ†/äºº
                  </span>` : 
                  `<span style="font-size: 11px; color: ${rankTier.color}; margin-left: 8px;">å·²è¾¾æœ€é«˜æ®µä½</span>`
                }
              </div>
            </div>
            <div class="row">
              <button class="btn primary" onclick="openGroupEdit('${g.id}')">ç¼–è¾‘æˆå‘˜</button>
              <button class="btn" style="background: var(--success); color: white;" onclick="adjustGroupPoints('${g.id}', '${g.name}', 'add')">â• åŠ åˆ†</button>
              <button class="btn" style="background: var(--danger); color: white;" onclick="adjustGroupPoints('${g.id}', '${g.name}', 'subtract')">â– å‡åˆ†</button>
              <button class="btn warn" onclick="deleteGroup('${g.id}')">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderRules() {
      const list = $('#ruleList');
      let rules = state.rules;
      
      // æ ¹æ®ç­›é€‰ç±»å‹è¿‡æ»¤è§„åˆ™
      if (currentRuleFilter === 'add') {
        rules = rules.filter(r => {
          const delta = r.delta || r.points || 0;
          return delta > 0;
        });
      } else if (currentRuleFilter === 'subtract') {
        rules = rules.filter(r => {
          const delta = r.delta || r.points || 0;
          return delta < 0;
        });
      }
      
      if (rules.length === 0) {
        const filterText = currentRuleFilter === 'add' ? 'åŠ åˆ†' : currentRuleFilter === 'subtract' ? 'å‡åˆ†' : '';
        list.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-text">${filterText ? `è¿˜æ²¡æœ‰${filterText}è§„åˆ™` : 'è¿˜æ²¡æœ‰è§„åˆ™ï¼Œè¯·å…ˆæ·»åŠ '}</div>
          </div>
        `;
        return;
      }
      
      list.innerHTML = rules.map(r => {
        const delta = r.delta || r.points || 0; // å…¼å®¹æ—§æ•°æ®
        return `
          <div class="card" style="flex-direction: column; align-items: stretch; padding: 16px;">
            <div style="text-align: center; margin-bottom: 12px;">
              <div class="name" style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${r.name}</div>
              <div class="pts" style="color: ${delta > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700; font-size: 24px;">${delta > 0 ? '+' : ''}${delta} åˆ†</div>
            </div>
            <div style="display: flex; gap: 8px; flex-direction: column;">
              <button class="btn primary" onclick="applyRule('${r.id}')" style="width: 100%;">åº”ç”¨</button>
              <button class="btn warn" onclick="deleteRule('${r.id}')" style="width: 100%;">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterRules(type) {
      currentRuleFilter = type;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      $$('.rule-filter-btn').forEach(btn => {
        if (btn.dataset.filter === type) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      renderRules();
    }

    function renderHistory() {
      const list = $('#historyList');
      const history = state.history.slice(0, 50); // åªæ˜¾ç¤ºæœ€è¿‘50æ¡
      
      if (history.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <div class="empty-state-text">è¿˜æ²¡æœ‰å†å²è®°å½•</div>
          </div>
        `;
        return;
      }
      
      list.innerHTML = history.map((h, index) => {
        const isRevoked = h.revoked || (h.title && h.title.includes('ã€å·²æ’¤å›ã€‘'));
        const canRevoke = index < 10 && !isRevoked && h.delta !== 0;
        
        return `
          <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div class="name" style="text-align: left;">${h.title}</div>
              <div class="subtle">${h.time}</div>
              <div class="subtle">${h.detail}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div class="pts" style="${h.delta > 0 ? 'color: var(--success)' : h.delta < 0 ? 'color: var(--danger)' : 'color: var(--muted)'}">
                ${h.delta > 0 ? '+' : ''}${h.delta}
              </div>
              ${canRevoke ? `<button class="btn warn" style="font-size: 12px; padding: 4px 12px;" onclick="revokeHistory(${index})">æ’¤å›</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æ’¤å›ç§¯åˆ†è®°å½•
    function revokeHistory(index) {
      const record = state.history[index];
      if (!record) return;
      
      // æ£€æŸ¥æ˜¯å¦å·²æ’¤å›
      if (record.title && record.title.includes('ã€å·²æ’¤å›ã€‘')) {
        alert('è¯¥è®°å½•å·²ç»æ’¤å›è¿‡äº†');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦æ’¤å›è¿™æ¡è®°å½•å—ï¼Ÿ\n\n${record.title}\n${record.detail}\nç§¯åˆ†å˜åŠ¨ï¼š${record.delta > 0 ? '+' : ''}${record.delta}`)) {
        return;
      }
      
      // è·å–å—å½±å“çš„å­¦ç”ŸIDï¼ˆä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„studentIdsï¼‰
      let affectedStudents = [];
      
      if (record.studentIds && Array.isArray(record.studentIds)) {
        affectedStudents = record.studentIds;
      } else {
        // å¦‚æœæ²¡æœ‰studentIdsï¼Œå°è¯•ä»detailè§£æ
        if (record.detail) {
          const match = record.detail.match(/å­¦ç”Ÿï¼š(.+?)(?:\s|$)/);
          if (match) {
            const names = match[1].split('ã€');
            names.forEach(name => {
              const student = state.students.find(s => s.name === name.trim());
              if (student) {
                affectedStudents.push(student.id);
              }
            });
          }
        }
      }
      
      // æ’¤å›ç§¯åˆ†ï¼ˆåå‘æ“ä½œï¼‰
      if (affectedStudents.length > 0) {
        let successCount = 0;
        affectedStudents.forEach(studentId => {
          const student = state.students.find(s => s.id === studentId);
          if (student) {
            // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            if (student.totalEarned === undefined) {
              student.totalEarned = student.points || 0;
            }
            
            // åå‘è°ƒæ•´ç§¯åˆ†ï¼šåŸæ¥åŠ åˆ†ç°åœ¨æ‰£åˆ†ï¼ŒåŸæ¥æ‰£åˆ†ç°åœ¨åŠ åˆ†
            student.points -= record.delta;
            
            // å¦‚æœæ˜¯å…‘æ¢è®°å½•ï¼ˆdeltaä¸ºè´Ÿï¼‰ï¼Œæ’¤å›æ—¶ä¸å½±å“ totalEarned
            // å¦‚æœæ˜¯åŠ å‡åˆ†è®°å½•ï¼Œæ’¤å›æ—¶éœ€è¦åŒæ­¥è°ƒæ•´ totalEarned
            if (record.title !== 'å…‘æ¢å•†å“') {
              student.totalEarned -= record.delta;
            }
            
            const changeType = record.title === 'å…‘æ¢å•†å“' ? 'exchange' : 'adjust';
            recordPointChange(studentId, -record.delta, `æ’¤å›ï¼š${record.title || ''}`, changeType); // è®°å½•åå‘å˜åŠ¨
            successCount++;
          }
        });
        
        if (successCount === 0) {
          alert('æ‰¾ä¸åˆ°ç›¸å…³å­¦ç”Ÿï¼Œæ— æ³•æ’¤å›');
          return;
        }
      } else {
        alert('æ— æ³•è¯†åˆ«å—å½±å“çš„å­¦ç”Ÿï¼Œæ’¤å›å¤±è´¥');
        return;
      }
      
      // æ ‡è®°ä¸ºå·²æ’¤å›ï¼ˆä¸åˆ é™¤ï¼Œä¿ç•™è®°å½•ï¼‰
      state.history[index] = {
        ...record,
        title: `ã€å·²æ’¤å›ã€‘${record.title}`,
        delta: 0,
        revoked: true,
        revokedTime: now()
      };
      
      saveState();
      renderAll();
      toast('âœ… å·²æ’¤å›è¯¥æ¡è®°å½•ï¼Œç§¯åˆ†å·²è°ƒæ•´');
    }

    // åˆ¤æ–­æ—¶é—´æ˜¯å¦åœ¨èŒƒå›´å†…
    function isInTimeRange(timestamp, type) {
      const now = new Date();
      const time = new Date(timestamp);
      
      if (type === 'day') {
        return time.toDateString() === now.toDateString();
      }
      
      if (type === 'week') {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        return time >= weekAgo;
      }
      
      if (type === 'month') {
        return time.getFullYear() === now.getFullYear() && 
               time.getMonth() === now.getMonth();
      }
      
      if (type === 'year') {
        return time.getFullYear() === now.getFullYear();
      }
      
      return true;
    }

    function toggleProgressRank() {
      progressRankEnabled = !progressRankEnabled;
      updateProgressControls();
      
      if (progressRankEnabled && currentRankMode === 'group') {
        switchRankMode('student');
        return;
      }
      
      renderRank();
    }

    function changeProgressRange(value) {
      const days = parseInt(value, 10) || 7;
      progressRangeDays = days;
      updateProgressControls();
      if (progressRankEnabled) {
        renderRank();
      }
    }

    function updateProgressControls() {
      const btn = $('#progressRankBtn');
      const rangeSel = $('#progressRangeSel');
      
      if (btn) {
        if (progressRankEnabled) {
          btn.textContent = 'ğŸ“ˆ è¿›æ­¥æ¦œ (å·²å¼€å¯)';
          btn.style.background = 'linear-gradient(135deg, #2563eb, #3b82f6)';
          btn.style.color = '#fff';
        } else {
          btn.textContent = 'ğŸ“ˆ è¿›æ­¥æ¦œ';
          btn.style.background = 'rgba(59,130,246,0.15)';
          btn.style.color = '#2563eb';
        }
      }
      
      if (rangeSel) {
        rangeSel.disabled = !progressRankEnabled;
        rangeSel.value = `${progressRangeDays}`;
        rangeSel.style.opacity = progressRankEnabled ? '1' : '0.6';
      }
    }

    function calculateProgressRank(days) {
      const now = Date.now();
      const threshold = now - days * 24 * 60 * 60 * 1000;
      
      return state.students.map(s => {
        const history = pointHistory[s.id] || [];
        const progress = history
          .filter(h => {
            const ts = h.timestamp || (h.time ? new Date(h.time).getTime() : null);
            if (!ts) return false;
            return ts >= threshold && (h.type || 'adjust') !== 'exchange';
          })
          .reduce((sum, h) => sum + (h.delta || 0), 0);
        
        return {
          ...s,
          progressPoints: progress
        };
      }).filter(s => s.progressPoints > 0);
    }

    // è®¡ç®—å¤šç»´åº¦æ’è¡Œæ¦œæ•°æ®
    function calculateRankData(type) {
      const students = state.students.slice();
      
      if (type === 'total') {
        // æ€»æ¦œï¼šä½¿ç”¨å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆä¸å—å…‘æ¢å½±å“ï¼‰
        return students.map(s => ({
          ...s,
          rankPoints: s.totalEarned || s.points || 0  // ä½¿ç”¨totalEarnedï¼Œå…¼å®¹æ—§æ•°æ®
        }));
      }
      
      // æ—¶é—´ç»´åº¦ï¼šä»ç§¯åˆ†å†å²è®¡ç®—
      return students.map(s => {
        const history = pointHistory[s.id] || [];
        const rangePoints = history
          .filter(h => isInTimeRange(h.timestamp, type))
          .reduce((sum, h) => sum + (h.delta || 0), 0);
        
        return {
          ...s,
          rankPoints: rangePoints
        };
      }).filter(s => s.rankPoints !== 0); // åªæ˜¾ç¤ºæœ‰ç§¯åˆ†å˜åŒ–çš„
    }

    function switchRankType(type) {
      currentRankType = type;
      $('#rankTypeSel').value = type;
      progressRankEnabled = false;
      updateProgressControls();
      renderRank();
    }

    function switchRankMode(mode) {
      currentRankMode = mode;
      
      if (mode === 'group' && progressRankEnabled) {
        progressRankEnabled = false;
      }
      updateProgressControls();
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      $$('.rank-mode-btn').forEach(btn => {
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      renderRank();
    }

    async function renderRank() {
      updateProgressControls();
      const list = $('#rankList');
      
      if (currentRankMode === 'group') {
        // å°ç»„æ’è¡Œæ¦œ
        if (state.groups.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">è¿˜æ²¡æœ‰å°ç»„</div>
            </div>
          `;
          return;
        }
        
        // è®¡ç®—æ¯ä¸ªå°ç»„çš„ç§¯åˆ†
        const groupRanks = state.groups.map(g => {
          const members = (g.members || []).map(mid => state.students.find(s => s.id === mid)).filter(Boolean);
          const totalPoints = members.reduce((sum, s) => sum + (s.points || 0), 0);
          const totalEarned = members.reduce((sum, s) => sum + (s.totalEarned || s.points || 0), 0);
          const avgEarned = members.length > 0 ? Math.round(totalEarned / members.length) : 0;
          
          return {
            id: g.id,
            name: g.name,
            members: members,
            memberCount: members.length,
            totalPoints: totalPoints,
            totalEarned: totalEarned,
            avgEarned: avgEarned,
            avgPoints: members.length > 0 ? Math.round(totalPoints / members.length) : 0
          };
        });
        
        // æ’åºï¼ˆæŒ‰äººå‡ç§¯åˆ†æ’åºï¼‰
        groupRanks.sort((a, b) => b.avgEarned - a.avgEarned);
        
        list.innerHTML = groupRanks.map((g, idx) => {
          // è®¡ç®—å°ç»„æ®µä½ï¼ˆåŸºäºäººå‡æ’åç§¯åˆ†ï¼‰
          const rankTier = calculateRankTier(g.avgEarned);
          
          // æ’åå›¾æ ‡
          let rankIcon = `<div class="num">${idx + 1}</div>`;
          if (idx === 0) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; font-weight: 900;">ğŸ‘‘</div>`;
          } else if (idx === 1) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #C0C0C0, #999); color: white;">â¬†ï¸</div>`;
          } else if (idx === 2) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: white;">â¬‡ï¸</div>`;
          }
          
          return `
            <div class="rank-item">
              ${rankIcon}
              <div class="avatar" style="background: linear-gradient(135deg, #a855f7, #ec4899); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; padding: 0; border-color: ${rankTier.color};">
                ${g.memberCount}
              </div>
              <div style="flex: 1;">
                <div class="name">${g.name}</div>
                <div class="rank-tier-small" style="color: ${rankTier.color}; font-size: 11px; font-weight: 600; margin-top: 2px;">
                  ${rankTier.displayName}
                </div>
              </div>
              <div class="pts" style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700;">${g.avgEarned} åˆ†/äºº</div>
                <div style="font-size: 11px; color: var(--muted);">æ€»åˆ†: ${g.totalEarned} (${g.memberCount}äºº)</div>
                ${rankTier.stars > 0 ? `<div style="font-size: 11px; color: ${rankTier.color};">âš¡${rankTier.stars > 24 ? rankTier.stars : ''}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        
      } else {
        // ä¸ªäººæ’è¡Œæ¦œ
        if (state.students.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ†</div>
              <div class="empty-state-text">è¿˜æ²¡æœ‰å­¦ç”Ÿ</div>
            </div>
          `;
          return;
        }
        
        if (progressRankEnabled) {
          const progressData = calculateProgressRank(progressRangeDays);
          
          if (progressData.length === 0) {
            list.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“ˆ</div>
                <div class="empty-state-text">æœ€è¿‘ ${progressRangeDays} å¤©æš‚æ— è¿›æ­¥è®°å½•</div>
              </div>
            `;
            return;
          }
          
          progressData.sort((a, b) => b.progressPoints - a.progressPoints);
          
          list.innerHTML = progressData.map((s, idx) => {
            const rankTier = calculateRankTier(s.totalEarned || s.points || 0);
            let rankIcon = `<div class="num">${idx + 1}</div>`;
            if (idx === 0) {
              rankIcon = `<div class="num" style="background: linear-gradient(135deg, #D97706, #FACC15); color: white; font-weight: 900;">ğŸ”¥</div>`;
            } else if (idx === 1) {
              rankIcon = `<div class="num" style="background: linear-gradient(135deg, #60A5FA, #3B82F6); color: white;">â­</div>`;
            } else if (idx === 2) {
              rankIcon = `<div class="num" style="background: linear-gradient(135deg, #34D399, #10B981); color: white;">ğŸŒŸ</div>`;
            }
            
            return `
              <div class="rank-item">
                ${rankIcon}
                <div class="avatar" style="border-color: ${rankTier.color};">
                  <img src="${placeholderAvatar(s.name)}" alt="${s.name}" data-student-id="${s.id}">
                </div>
                <div style="flex: 1;">
                  <div class="name">${s.name}</div>
                  <div class="rank-tier-small" style="color: ${rankTier.color}; font-size: 11px; font-weight: 600; margin-top: 2px;">
                    ${rankTier.displayName}
                  </div>
                </div>
                <div class="pts" style="text-align: right;">
                  <div style="font-size: 18px; font-weight: 700; color: #16a34a;">+${s.progressPoints} åˆ†</div>
                  <div style="font-size: 11px; color: var(--muted);">å½“å‰æ€»åˆ†ï¼š${s.points || 0}</div>
                </div>
              </div>
            `;
          }).join('');
          
          // åŠ è½½å¤´åƒ
          const imgs = list.querySelectorAll('.avatar img');
          const loadPromises = Array.from(imgs).map(async (img) => {
            const sid = img.dataset.studentId;
            const stored = await loadAvatar(sid);
            if (stored) {
              img.src = stored;
            }
          });
          await Promise.all(loadPromises);
          return;
        }
        
        let arr = calculateRankData(currentRankType);
        
        if (arr.length === 0) {
          const typeNames = {
            'day': 'ä»Šæ—¥',
            'week': 'æœ¬å‘¨',
            'month': 'æœ¬æœˆ',
            'year': 'ä»Šå¹´'
          };
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“Š</div>
              <div class="empty-state-text">${typeNames[currentRankType] || ''}æš‚æ— ç§¯åˆ†å˜åŒ–</div>
            </div>
          `;
          return;
        }
        
        // æ’åº
        arr.sort((a, b) => b.rankPoints - a.rankPoints);
        
        list.innerHTML = arr.map((s, idx) => {
          // è®¡ç®—æ®µä½
          const rankTier = calculateRankTier(s.totalEarned || s.points || 0);
          
          // æ’åå›¾æ ‡
          let rankIcon = `<div class="num">${idx + 1}</div>`;
          if (idx === 0) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; font-weight: 900;">ğŸ‘‘</div>`;
          } else if (idx === 1) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #C0C0C0, #999); color: white;">â¬†ï¸</div>`;
          } else if (idx === 2) {
            rankIcon = `<div class="num" style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: white;">â¬‡ï¸</div>`;
          }
          
          return `
            <div class="rank-item">
              ${rankIcon}
              <div class="avatar" style="border-color: ${rankTier.color};">
                <img src="${placeholderAvatar(s.name)}" alt="${s.name}" data-student-id="${s.id}">
              </div>
              <div style="flex: 1;">
                <div class="name">${s.name}</div>
                <div class="rank-tier-small" style="color: ${rankTier.color}; font-size: 11px; font-weight: 600; margin-top: 2px;">
                  ${rankTier.displayName}
                </div>
              </div>
              <div class="pts" style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700;">${s.rankPoints} åˆ†</div>
                ${rankTier.stars > 0 ? `<div style="font-size: 11px; color: ${rankTier.color};">âš¡${rankTier.stars > 24 ? rankTier.stars : ''}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        // åŠ è½½å¤´åƒ
        const imgs = list.querySelectorAll('.avatar img');
        const loadPromises = Array.from(imgs).map(async (img) => {
          const sid = img.dataset.studentId;
          const student = arr.find(s => s.id === sid);
          if (student?.avatarKey) {
            try {
              // å…ˆå°è¯•ä» localStorage è¯»å– base64
              if (student.avatarBase64) {
                const base64Data = localStorage.getItem(`avatar_${student.avatarKey}`);
                if (base64Data) {
                  return new Promise((resolve) => {
                    img.onload = () => resolve();
                    img.onerror = () => resolve();
                    img.src = base64Data;
                  });
                }
              }
              
              // å¦‚æœä¸æ˜¯ base64ï¼Œä» IndexedDB è¯»å–
              const blob = await getAvatar(student.avatarKey);
              if (blob) {
                const url = URL.createObjectURL(blob);
                return new Promise((resolve) => {
                  img.onload = () => resolve();
                  img.onerror = () => resolve();
                  img.src = url;
                });
              }
            } catch (e) {
              console.error('Failed to load avatar:', e);
            }
          }
          return Promise.resolve();
        });
        
        await Promise.all(loadPromises);
      }
    }

    // ==================== å­¦ç”Ÿè¯¦æƒ…åŠŸèƒ½ ====================
    function showStudentHistory(studentId) {
      const student = state.students.find(s => s.id === studentId);
      if (!student) return;
      
      const history = pointHistory[studentId] || [];
      
      openModal(`${student.name} çš„ç§¯åˆ†å†å²`, `
        <div style="text-align: right; margin-bottom: 8px;">
          <button class="btn" style="padding: 6px 12px;" onclick="exportSingleStudentHistory('${studentId}')">ğŸ“¤ å¯¼å‡ºè¯¥å­¦ç”Ÿç§¯åˆ†æ˜ç»†</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          ${history.length === 0 ? 
            '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">è¿˜æ²¡æœ‰å†å²è®°å½•</div></div>' :
            history.slice(0, 50).map(h => `
              <div class="card" style="flex-direction: row; justify-content: space-between; margin-bottom: 8px; padding: 12px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600;">${h.reason}</div>
                  <div class="subtle" style="font-size: 12px;">${h.time}</div>
                </div>
                <div style="font-size: 18px; font-weight: 700; color: ${h.delta > 0 ? 'var(--success)' : 'var(--danger)'};">
                  ${h.delta > 0 ? '+' : ''}${h.delta}
                </div>
              </div>
            `).join('')
          }
        </div>
      `);
      
      $('#modalOk').style.display = 'none';
      $('#modalCancel').textContent = 'å…³é—­';
    }

    function showStudentMall(studentId) {
      const student = state.students.find(s => s.id === studentId);
      if (!student) return;
      
      if (mallItems.length === 0) {
        alert('å•†åŸè¿˜æ²¡æœ‰å•†å“ï¼Œè¯·å…ˆåœ¨ç§¯åˆ†å•†åŸæ·»åŠ å•†å“');
        return;
      }
      
      openModal(`${student.name} çš„ç§¯åˆ†å•†åŸï¼ˆå½“å‰ ${student.points} åˆ†ï¼‰`, `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">
          ${mallItems.map(item => `
            <div class="card" style="padding: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">${item.name}</div>
              <div style="color: var(--primary); font-weight: 700; margin-bottom: 8px;">${item.price} åˆ†</div>
              <div class="subtle" style="font-size: 12px; margin-bottom: 8px;">åº“å­˜: ${item.stock === -1 ? 'æ— é™' : item.stock}</div>
              <button 
                class="btn primary" 
                onclick="quickRedeem('${studentId}', '${item.id}')" 
                style="width: 100%; padding: 6px; font-size: 12px;"
                ${student.points < item.price || (item.stock !== -1 && item.stock <= 0) ? 'disabled' : ''}>
                ${student.points < item.price ? 'ç§¯åˆ†ä¸è¶³' : 'ç«‹å³å…‘æ¢'}
              </button>
            </div>
          `).join('')}
        </div>
      `);
      
      $('#modalOk').style.display = 'none';
      $('#modalCancel').textContent = 'å…³é—­';
    }

    function quickRedeem(studentId, itemId) {
      const student = state.students.find(s => s.id === studentId);
      const item = mallItems.find(i => i.id === itemId);
      
      if (!student || !item) return;
      
      // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
      if (student.points < item.price) {
        alert(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ ${item.price} åˆ†ï¼Œå½“å‰åªæœ‰ ${student.points} åˆ†`);
        return;
      }
      
      // æ£€æŸ¥åº“å­˜
      if (item.stock !== -1 && item.stock <= 0) {
        alert('å•†å“å·²å”®ç½„');
        return;
      }
      
      // å…³é—­ä¹‹å‰çš„å¼¹çª—ï¼Œæ˜¾ç¤ºç¡®è®¤ç•Œé¢
      closeModal();
      
      openModal(`å…‘æ¢å•†å“ï¼š${item.name}`, `
        <div style="padding: 16px 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--soft); border-radius: 8px; margin-bottom: 16px;">
            <div>
              <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">å…‘æ¢å­¦ç”Ÿ</div>
              <div style="font-size: 18px; font-weight: 600; color: var(--text);">${student.name}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">å½“å‰ç§¯åˆ†</div>
              <div style="font-size: 18px; font-weight: 600; color: var(--primary);">${student.points} åˆ†</div>
            </div>
          </div>
          
          <div style="border-left: 3px solid var(--primary); padding-left: 12px; margin-bottom: 16px;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${item.name}</div>
            <div style="color: var(--muted); margin-bottom: 4px;">ä»·æ ¼ï¼š<span style="color: var(--danger); font-weight: 600;">${item.price} ç§¯åˆ†</span></div>
            <div style="color: var(--muted);">åº“å­˜ï¼š${item.stock === -1 ? 'æ— é™' : item.stock}</div>
            ${item.description ? `<div style="margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 12px; color: #666;">${item.description}</div>` : ''}
          </div>
          
          <div style="padding: 12px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
            <div style="font-size: 14px; color: #856404;">
              âœ¨ å…‘æ¢åå‰©ä½™ï¼š<span style="font-weight: 600; font-size: 16px; color: var(--success);">${student.points - item.price} ç§¯åˆ†</span>
            </div>
          </div>
        </div>
      `);
      
      $('#modalOk').textContent = 'âœ“ ç¡®è®¤å…‘æ¢';
      $('#modalOk').onclick = () => {
        // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
        if (student.totalEarned === undefined) {
          student.totalEarned = student.points || 0;
        }
        
        // æ‰§è¡Œå…‘æ¢ï¼šåªæ‰£é™¤å¯ç”¨ç§¯åˆ†ï¼Œä¸å½±å“å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆtotalEarnedï¼‰
        student.points -= item.price;
        // æ³¨æ„ï¼šè¿™é‡Œä¸ä¿®æ”¹ student.totalEarnedï¼Œä¿æŒæ’åä¸å˜
        
        if (item.stock !== -1) {
          item.stock--;
          saveMallItems();
        }
        
        // è®°å½•ä¸ªäººç§¯åˆ†å†å²ï¼ˆä¸å½±å“æ’åç§¯åˆ†ï¼‰
        recordPointChange(studentId, -item.price, `å…‘æ¢å•†å“ï¼š${item.name}`, 'exchange');
        
        state.history.unshift({
          id: gid(),
          time: now(),
          title: 'å…‘æ¢å•†å“',
          detail: `å­¦ç”Ÿï¼š${student.name} å…‘æ¢ ${item.name}`,
          delta: -item.price,
          studentIds: [studentId]
        });
        
        saveState();
        closeModal();
        renderStudents();
        toast(`ğŸ‰ ${student.name} æˆåŠŸå…‘æ¢ ${item.name}ï¼æ’åç§¯åˆ†ä¿æŒä¸å˜`);
      };
    }

    // ==================== å•†åŸç®¡ç† ====================
    function loadMallItems() {
      try {
        mallItems = JSON.parse(localStorage.getItem(MALL_KEY) || '[]');
      } catch {
        mallItems = [];
      }
    }

    function saveMallItems() {
      localStorage.setItem(MALL_KEY, JSON.stringify(mallItems));
    }

    function openAddMallItem() {
      openModal('æ·»åŠ å•†å“', `
        <input type="text" id="mallItemName" placeholder="å•†å“åç§°" style="margin-bottom: 8px;">
        <input type="number" id="mallItemPrice" placeholder="ç§¯åˆ†ä»·æ ¼" style="margin-bottom: 8px;">
        <input type="number" id="mallItemStock" placeholder="åº“å­˜æ•°é‡ï¼ˆ-1è¡¨ç¤ºæ— é™ï¼‰" value="-1" style="margin-bottom: 8px;">
        <textarea id="mallItemDesc" placeholder="å•†å“æè¿°ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
      `);
      
      $('#modalOk').onclick = () => {
        const name = $('#mallItemName').value.trim();
        const price = parseInt($('#mallItemPrice').value) || 0;
        const stock = parseInt($('#mallItemStock').value) || -1;
        const description = $('#mallItemDesc').value.trim();
        
        if (!name) {
          alert('è¯·è¾“å…¥å•†å“åç§°');
          return;
        }
        
        if (price <= 0) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼');
          return;
        }
        
        mallItems.push({
          id: gid(),
          name,
          price,
          stock,
          description
        });
        
        saveMallItems();
        closeModal();
        renderMall();
        toast(`å·²æ·»åŠ å•†å“ï¼š${name}`);
      };
    }

    function deleteMallItem(itemId) {
      const item = mallItems.find(i => i.id === itemId);
      if (!item) return;
      
      if (!confirm(`ç¡®å®šåˆ é™¤å•†å“"${item.name}"å—ï¼Ÿ`)) {
        return;
      }
      
      mallItems = mallItems.filter(i => i.id !== itemId);
      saveMallItems();
      renderMall();
      toast(`å·²åˆ é™¤å•†å“ï¼š${item.name}`);
    }

    function redeemItem(itemId) {
      const item = mallItems.find(i => i.id === itemId);
      if (!item) return;
      
      openModal(`å…‘æ¢å•†å“ï¼š${item.name}`, `
        <div class="subtle">ä»·æ ¼ï¼š${item.price} ç§¯åˆ† | åº“å­˜ï¼š${item.stock === -1 ? 'æ— é™' : item.stock}</div>
        <div style="margin-top: 12px;">
          <label>é€‰æ‹©å­¦ç”Ÿï¼š</label>
          <select id="redeemStudent" style="margin-top: 8px;">
            ${state.students.map(s => 
              `<option value="${s.id}">${s.name} (${s.points}åˆ†)</option>`
            ).join('')}
          </select>
        </div>
      `);
      
      $('#modalOk').onclick = () => {
        const studentId = $('#redeemStudent').value;
        const student = state.students.find(s => s.id === studentId);
        
        if (!student) {
          alert('å­¦ç”Ÿä¸å­˜åœ¨');
          return;
        }
        
        if (student.points < item.price) {
          alert(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ ${item.price} åˆ†ï¼Œå½“å‰ ${student.points} åˆ†`);
          return;
        }
        
        if (item.stock !== -1 && item.stock <= 0) {
          alert('å•†å“å·²å”®ç½„');
          return;
        }
        
        // ç¡®è®¤å…‘æ¢
        if (!confirm(`ç¡®è®¤å…‘æ¢å—ï¼Ÿ\n\nå­¦ç”Ÿï¼š${student.name}\nå•†å“ï¼š${item.name}\nä»·æ ¼ï¼š${item.price} ç§¯åˆ†\nå‰©ä½™ç§¯åˆ†ï¼š${student.points - item.price} ç§¯åˆ†\n\næ³¨ï¼šå…‘æ¢ä¸å½±å“æ’åç§¯åˆ†`)) {
          return;
        }
        
        // åˆå§‹åŒ– totalEarnedï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
        if (student.totalEarned === undefined) {
          student.totalEarned = student.points || 0;
        }
        
        // åªæ‰£é™¤å¯ç”¨ç§¯åˆ†ï¼Œä¸å½±å“å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆtotalEarnedï¼‰
        student.points -= item.price;
        // æ³¨æ„ï¼šä¸ä¿®æ”¹ student.totalEarnedï¼Œä¿æŒæ’åä¸å˜
        
        if (item.stock !== -1) {
          item.stock--;
          saveMallItems();
        }
        
        // è®°å½•ä¸ªäººç§¯åˆ†å†å²ï¼ˆä¸å½±å“æ’åç§¯åˆ†ï¼‰
        recordPointChange(studentId, -item.price, `å…‘æ¢å•†å“ï¼š${item.name}`, 'exchange');
        
        state.history.unshift({
          id: gid(),
          time: now(),
          title: 'å…‘æ¢å•†å“',
          detail: `å­¦ç”Ÿï¼š${student.name} å…‘æ¢ ${item.name}`,
          delta: -item.price,
          studentIds: [studentId]
        });
        
        saveState();
        closeModal();
        renderMall();
        renderStudents();
        toast(`${student.name} æˆåŠŸå…‘æ¢ ${item.name}ï¼ˆæ’åç§¯åˆ†ä¿æŒä¸å˜ï¼‰`);
      };
    }

    function renderMall() {
      const grid = $('#mallGrid');
      
      if (mallItems.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ›’</div>
            <div class="empty-state-text">è¿˜æ²¡æœ‰å•†å“</div>
            <button onclick="openAddMallItem()" class="btn primary">+ æ·»åŠ ç¬¬ä¸€ä¸ªå•†å“</button>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = mallItems.map(item => `
        <div class="card">
          <div class="name">${item.name}</div>
          <div class="pts">${item.price} åˆ†</div>
          <div class="subtle">åº“å­˜: ${item.stock === -1 ? 'æ— é™' : item.stock}</div>
          ${item.description ? `<div class="subtle" style="font-size: 12px;">${item.description}</div>` : ''}
          <div class="card-actions">
            <button class="btn primary" onclick="redeemItem('${item.id}')">ç«‹å³å…‘æ¢</button>
            <button class="btn warn" onclick="deleteMallItem('${item.id}')">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // ==================== éšæœºç‚¹å ====================
    let rcStarAnimation = null;
    let rcIsSpinning = false;
    let rcSpeechSynthesis = null;
    let rcPlanetRotation = { x: -20, y: 0 };
    let rcNameElements = [];
    let rcSpinInterval = null; // ä¿å­˜æ—‹è½¬åŠ¨ç”»çš„intervalå¼•ç”¨
    
    function loadRcRecords() {
      try {
        rcRecords = JSON.parse(localStorage.getItem(RC_RECORDS_KEY) || '[]');
        rcCalledSet = JSON.parse(localStorage.getItem(RC_CALLED_KEY) || '[]');
      } catch {
        rcRecords = [];
        rcCalledSet = [];
      }
    }

    function saveRcRecords() {
      localStorage.setItem(RC_RECORDS_KEY, JSON.stringify(rcRecords));
      localStorage.setItem(RC_CALLED_KEY, JSON.stringify(rcCalledSet));
    }

    // åˆå§‹åŒ–æ˜Ÿç©ºèƒŒæ™¯
    function initRcStars() {
      const canvas = $('#rcStarCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const stars = [];
      const starCount = 200;
      
      function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // åˆ›å»ºæ˜Ÿæ˜Ÿ
      for (let i = 0; i < starCount; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 1.5 + 0.5,
          opacity: Math.random() * 0.8 + 0.2,
          twinkleSpeed: Math.random() * 0.02 + 0.01
        });
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        stars.forEach(star => {
          star.opacity += star.twinkleSpeed;
          if (star.opacity > 1 || star.opacity < 0.2) star.twinkleSpeed *= -1;
          
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
          ctx.fill();
        });
        
        rcStarAnimation = requestAnimationFrame(animate);
      }
      
      animate();
    }

    // åˆ›å»º3Dæ˜Ÿçƒä¸Šçš„åå­—åˆ†å¸ƒ
    function createPlanetNames() {
      const container = $('#rcPlanetNames');
      if (!container) return;
      
      container.innerHTML = '';
      rcNameElements = [];
      
      const students = state.students;
      if (students.length === 0) return;
      
      const radius = 280; // æ˜ŸçƒåŠå¾„
      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#fa709a', '#fee140', '#00f2fe', '#ff6b6b'];
      
      // ä½¿ç”¨æ–æ³¢é‚£å¥‘èºæ—‹åˆ†å¸ƒç®—æ³•ï¼Œç¡®ä¿åå­—å‡åŒ€åˆ†å¸ƒåœ¨çƒé¢ä¸Š
      const goldenAngle = Math.PI * (3 - Math.sqrt(5)); // é»„é‡‘è§’åº¦
      
      students.forEach((student, index) => {
        const y = 1 - (index / (students.length - 1)) * 2; // -1 åˆ° 1
        const radius_at_y = Math.sqrt(1 - y * y);
        const theta = goldenAngle * index;
        
        const x = Math.cos(theta) * radius_at_y;
        const z = Math.sin(theta) * radius_at_y;
        
        const nameEl = document.createElement('div');
        nameEl.className = 'rc-planet-name';
        nameEl.textContent = student.name;
        nameEl.dataset.name = student.name;
        nameEl.style.color = colors[index % colors.length];
        
        // è®¡ç®—3Dä½ç½®
        const translateX = x * radius;
        const translateY = y * radius;
        const translateZ = z * radius;
        
        nameEl.style.transform = `translate3d(${translateX}px, ${translateY}px, ${translateZ}px)`;
        nameEl.style.left = '50%';
        nameEl.style.top = '50%';
        nameEl.style.marginLeft = `-${nameEl.offsetWidth || 30}px`;
        nameEl.style.marginTop = `-${nameEl.offsetHeight || 15}px`;
        
        container.appendChild(nameEl);
        rcNameElements.push({ element: nameEl, name: student.name, x, y, z });
      });
    }

    // è¯­éŸ³æ’­æŠ¥
    function speakName(name) {
      if ('speechSynthesis' in window) {
        // åœæ­¢ä¹‹å‰çš„æ’­æŠ¥
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(name);
        utterance.lang = 'zh-CN';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // å°è¯•ä½¿ç”¨ä¸­æ–‡è¯­éŸ³
        const voices = window.speechSynthesis.getVoices();
        const chineseVoice = voices.find(voice => 
          voice.lang.includes('zh') || voice.lang.includes('CN')
        );
        if (chineseVoice) {
          utterance.voice = chineseVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      }
    }

    // å¼€å§‹æ—‹è½¬åŠ¨ç”»
    function startRcSpinning() {
      const sphere = $('#rcPlanetSphere');
      const nameDisplay = $('#rcNameDisplay');
      const highlight = $('#rcSelectedHighlight');
      
      if (!sphere || rcIsSpinning) return;
      
      // æ¸…é™¤ä¹‹å‰çš„æ—‹è½¬åŠ¨ç”»
      if (rcSpinInterval) {
        clearInterval(rcSpinInterval);
        rcSpinInterval = null;
      }
      
      rcIsSpinning = true;
      sphere.classList.add('rc-fast-rotating');
      highlight.classList.add('active');
      
      // å¿«é€Ÿåˆ‡æ¢æ˜¾ç¤ºå­¦ç”Ÿå§“åå¹¶é«˜äº®
      let spinCount = 0;
      const maxSpins = 50;
      const allNames = state.students.map(s => s.name);
      
      // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
      rcNameElements.forEach(item => {
        item.element.classList.remove('selected');
      });
      
      rcSpinInterval = setInterval(() => {
        spinCount++;
        const randomName = allNames[Math.floor(Math.random() * allNames.length)];
        nameDisplay.innerHTML = `<div class="rc-pulse-text">${randomName}</div>`;
        
        // é«˜äº®å¯¹åº”çš„åå­—
        rcNameElements.forEach(item => {
          item.element.classList.remove('selected');
          if (item.name === randomName) {
            item.element.classList.add('selected');
          }
        });
        
        if (spinCount >= maxSpins) {
          clearInterval(rcSpinInterval);
          rcSpinInterval = null;
        }
      }, 80);
    }

    // åœæ­¢æ—‹è½¬å¹¶æ˜¾ç¤ºç»“æœ
    function stopRcSpinning(picks) {
      const sphere = $('#rcPlanetSphere');
      const nameDisplay = $('#rcNameDisplay');
      const resultList = $('#rcResultList');
      const highlight = $('#rcSelectedHighlight');
      
      if (!sphere || picks.length === 0) return;
      
      // ç«‹å³æ¸…é™¤æ—‹è½¬åŠ¨ç”»çš„intervalï¼Œé˜²æ­¢ç»§ç»­éšæœºåˆ‡æ¢åå­—
      if (rcSpinInterval) {
        clearInterval(rcSpinInterval);
        rcSpinInterval = null;
      }
      
      // ç«‹å³æ›´æ–°ä¸­å¿ƒæ˜¾ç¤ºä¸ºæœ€ç»ˆæŠ½ä¸­çš„ç¬¬ä¸€ä¸ªåå­—
      const displayName = picks[0];
      nameDisplay.innerHTML = `<div class="rc-pulse-text" style="font-size: ${picks.length === 1 ? '52px' : '42px'};">${displayName}</div>`;
      
      setTimeout(() => {
        rcIsSpinning = false;
        sphere.classList.remove('rc-fast-rotating');
        sphere.classList.add('rc-rotating'); // æ…¢é€ŸæŒç»­æ—‹è½¬
        
        // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
        rcNameElements.forEach(item => {
          item.element.classList.remove('selected');
        });
        
        // é«˜äº®æ‰€æœ‰é€‰ä¸­çš„åå­—
        picks.forEach((pickName) => {
          const nameItem = rcNameElements.find(item => item.name === pickName);
          if (nameItem) {
            nameItem.element.classList.add('selected');
          }
        });
        
        // è®¡ç®—æ—‹è½¬è§’åº¦ï¼Œä½¿ç¬¬ä¸€ä¸ªé€‰ä¸­çš„åå­—è½¬åˆ°å‰é¢ï¼ˆä½œä¸ºä¸»è¦æ˜¾ç¤ºï¼‰
        const firstPickItem = rcNameElements.find(item => item.name === picks[0]);
        if (firstPickItem) {
          const angle = Math.atan2(firstPickItem.z, firstPickItem.x) * (180 / Math.PI);
          rcPlanetRotation.y = -angle;
          sphere.style.transform = `rotateX(${rcPlanetRotation.x}deg) rotateY(${rcPlanetRotation.y}deg)`;
        }
        
        // å†æ¬¡ç¡®ä¿ä¸­å¿ƒæ˜¾ç¤ºçš„åå­—æ­£ç¡®ï¼ˆé˜²æ­¢è¢«å…¶ä»–ä»£ç è¦†ç›–ï¼‰
        nameDisplay.innerHTML = `<div class="rc-pulse-text" style="font-size: ${picks.length === 1 ? '52px' : '42px'};">${displayName}</div>`;
        
        // è¯­éŸ³æ’­æŠ¥æ‰€æœ‰é€‰ä¸­çš„åå­—
        if (picks.length === 1) {
          speakName(picks[0]);
        } else {
          picks.forEach((name, index) => {
            setTimeout(() => speakName(name), index * 1000);
          });
        }
        
        // æ˜¾ç¤ºç»“æœåˆ—è¡¨ - ç¡®ä¿ä¸ä¸­å¿ƒæ˜¾ç¤ºçš„åå­—ä¸€è‡´
        resultList.innerHTML = picks.map((name, index) => {
          return `<div class="rc-result-item" style="animation-delay: ${index * 0.2}s;">${name}</div>`;
        }).join('');
        
        // å»¶è¿Ÿåç§»é™¤é«˜äº®
        setTimeout(() => {
          highlight.classList.remove('active');
        }, 2000);
      }, 500);
    }

    function startRandomCall() {
      if (state.students.length === 0) {
        alert('è¯·å…ˆæ·»åŠ å­¦ç”Ÿ');
        return;
      }
      
      if (rcIsSpinning) {
        return; // æ­£åœ¨æŠ½å–ä¸­ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      }
      
      // ç¡®ä¿æ˜Ÿçƒåå­—å·²åˆ›å»º
      if (rcNameElements.length === 0 || rcNameElements.length !== state.students.length) {
        createPlanetNames();
      }
      
      const count = parseInt($('#rcCount').value) || 1;
      const exclude = $('#rcExclude').checked;
      const startBtn = $('#rcStartBtn');
      
      // ç¦ç”¨æŒ‰é’®
      if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = 'æŠ½å–ä¸­...';
      }
      
      let pool = state.students.map(s => s.name);
      
      if (exclude) {
        pool = pool.filter(name => !rcCalledSet.includes(name));
        if (pool.length === 0) {
          if (confirm('æ‰€æœ‰å­¦ç”Ÿéƒ½å·²è¢«æŠ½è¿‡ï¼Œæ˜¯å¦æ¸…é™¤è®°å½•é‡æ–°å¼€å§‹ï¼Ÿ')) {
            clearRcCalled();
            pool = state.students.map(s => s.name);
          } else {
            if (startBtn) {
              startBtn.disabled = false;
              startBtn.textContent = 'ğŸš€ å¼€å§‹æŠ½å–';
            }
            return;
          }
        }
      }
      
      // å¼€å§‹æ—‹è½¬åŠ¨ç”»
      startRcSpinning();
      
      // å»¶è¿ŸåæŠ½å–
      setTimeout(() => {
      const picks = [];
      for (let i = 0; i < Math.min(count, pool.length); i++) {
        const idx = Math.floor(Math.random() * pool.length);
        const name = pool.splice(idx, 1)[0];
        picks.push(name);
        
        if (exclude) {
          rcCalledSet.push(name);
        }
      }
      
      rcRecords.unshift({
        time: now(),
        picks: picks
      });
      
      saveRcRecords();
        stopRcSpinning(picks);
      renderRcHistory();
      
        // æ¢å¤æŒ‰é’®
        if (startBtn) {
          setTimeout(() => {
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸš€ å¼€å§‹æŠ½å–';
          }, 2000);
        }
        
        toast(`å·²æŠ½å–ï¼š${picks.join('ã€')}`);
      }, 3000); // 3ç§’æ—‹è½¬åŠ¨ç”»
    }

    function renderRcHistory() {
      const history = $('#rcHistory');
      
      if (!history) return;
      
      if (rcRecords.length === 0) {
        history.innerHTML = '';
        return;
      }
      
      history.innerHTML = `
        <div class="card" style="padding: 20px;">
          <h3 style="font-size: 18px; margin-bottom: 16px; color: var(--text); font-weight: 600;">ğŸ“‹ æŠ½å–è®°å½•</h3>
          <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
        ${rcRecords.slice(0, 20).map(r => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--soft); border-radius: 8px; border-left: 4px solid var(--primary);">
                <div style="color: var(--muted); font-size: 13px;">${r.time}</div>
                <div style="font-weight: 600; color: var(--text);">${r.picks.join('ã€')}</div>
          </div>
        `).join('')}
          </div>
        </div>
      `;
    }

    function clearRcCalled() {
      rcCalledSet = [];
      saveRcRecords();
      toast('å·²æ¸…é™¤"æ’é™¤å·²æŠ½"è®°å½•');
    }
    
    // åˆå§‹åŒ–è¯­éŸ³åˆæˆï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½ä½¿ç”¨ï¼‰
    function initRcSpeechSynthesis() {
      if ('speechSynthesis' in window) {
        // åŠ è½½è¯­éŸ³åˆ—è¡¨
        if (speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = () => {
            // è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
          };
        }
      }
    }

    // ==================== è®¡æ—¶å™¨åŠŸèƒ½ ====================
    let timerInterval = null;
    let timerTotalSeconds = 0;
    let timerCurrentSeconds = 0;
    let timerIsRunning = false;
    let timerIsPaused = false;

    function timerFormatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function timerUpdateDisplay() {
      const display = $('#timerDisplay');
      if (display) {
        const remaining = timerTotalSeconds - timerCurrentSeconds;
        display.textContent = timerFormatTime(Math.max(0, remaining));
        
        // æ—¶é—´å¿«ç»“æŸæ—¶å˜çº¢è‰²
        if (remaining <= 10 && remaining > 0) {
          display.style.color = '#ef4444';
          display.style.animation = 'pulse 1s ease-in-out infinite';
        } else if (remaining === 0) {
          display.style.color = '#ef4444';
          display.style.animation = 'none';
        } else {
          display.style.color = '#2563eb';
          display.style.animation = 'none';
        }
      }
    }

    function timerStart() {
      if (timerTotalSeconds === 0) {
        alert('è¯·å…ˆè®¾ç½®æ—¶é—´ï¼');
        return;
      }
      
      timerCurrentSeconds = 0;
      timerIsRunning = true;
      timerIsPaused = false;
      
      $('#timerStartBtn').style.display = 'none';
      $('#timerPauseBtn').style.display = 'inline-block';
      $('#timerResumeBtn').style.display = 'none';
      
      timerInterval = setInterval(() => {
        timerCurrentSeconds++;
        timerUpdateDisplay();
        
        if (timerCurrentSeconds >= timerTotalSeconds) {
          timerStop();
          // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
          if ('AudioContext' in window || 'webkitAudioContext' in window) {
            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              
              oscillator.frequency.value = 800;
              oscillator.type = 'sine';
              
              gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
              
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
              console.log('æ— æ³•æ’­æ”¾æç¤ºéŸ³:', e);
            }
          }
          
          openModal('â° æ—¶é—´åˆ°', `
            <div style="text-align: center; padding: 24px 0;">
              <div style="font-size: 32px; font-weight: 800; color: #ef4444;">
                æ—¶é—´åˆ°ï¼
              </div>
            </div>
          `);
        }
      }, 1000);
      
      timerUpdateDisplay();
    }

    function timerPause() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      timerIsRunning = false;
      timerIsPaused = true;
      
      $('#timerPauseBtn').style.display = 'none';
      $('#timerResumeBtn').style.display = 'inline-block';
    }

    function timerResume() {
      if (timerIsPaused) {
        timerIsRunning = true;
        timerIsPaused = false;
        
        $('#timerPauseBtn').style.display = 'inline-block';
        $('#timerResumeBtn').style.display = 'none';
        
        timerInterval = setInterval(() => {
          timerCurrentSeconds++;
          timerUpdateDisplay();
          
          if (timerCurrentSeconds >= timerTotalSeconds) {
            timerStop();
            openModal('â° æ—¶é—´åˆ°', `
              <div style="text-align: center; padding: 24px 0;">
                <div style="font-size: 32px; font-weight: 800; color: #ef4444;">
                  æ—¶é—´åˆ°ï¼
                </div>
              </div>
            `);
          }
        }, 1000);
      }
    }

    function timerReset() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      timerCurrentSeconds = 0;
      timerIsRunning = false;
      timerIsPaused = false;
      
      $('#timerStartBtn').style.display = 'inline-block';
      $('#timerPauseBtn').style.display = 'none';
      $('#timerResumeBtn').style.display = 'none';
      
      timerUpdateDisplay();
    }

    function timerSetTime(seconds) {
      if (timerIsRunning) {
        if (!confirm('è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œï¼Œç¡®å®šè¦é‡æ–°è®¾ç½®æ—¶é—´å—ï¼Ÿ')) {
          return;
        }
        timerReset();
      }
      
      timerTotalSeconds = seconds;
      timerCurrentSeconds = 0;
      timerUpdateDisplay();
    }

    function timerSetCustom() {
      const hour = parseInt($('#timerHour').value) || 0;
      const minute = parseInt($('#timerMinute').value) || 0;
      const second = parseInt($('#timerSecond').value) || 0;
      
      const totalSeconds = hour * 3600 + minute * 60 + second;
      
      if (totalSeconds <= 0) {
        alert('è¯·è®¾ç½®æœ‰æ•ˆçš„æ—¶é—´ï¼');
        return;
      }
      
      timerSetTime(totalSeconds);
    }

    // åˆå§‹åŒ–æ»šè½®é€‰æ‹©æ—¶é—´åŠŸèƒ½
    function initTimerWheelInputs() {
      const inputs = document.querySelectorAll('.timer-wheel-input');
      
      inputs.forEach(input => {
        // é˜»æ­¢é»˜è®¤çš„æ»šè½®è¡Œä¸ºï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨ï¼‰
        input.addEventListener('wheel', (e) => {
          e.preventDefault();
          
          const delta = e.deltaY > 0 ? -1 : 1;
          const currentValue = parseInt(input.value) || 0;
          const min = parseInt(input.min) || 0;
          const max = parseInt(input.max) || 59;
          
          let newValue = currentValue + delta;
          
          // é™åˆ¶åœ¨èŒƒå›´å†…
          if (newValue < min) {
            newValue = max; // å¾ªç¯åˆ°æœ€å¤§å€¼
          } else if (newValue > max) {
            newValue = min; // å¾ªç¯åˆ°æœ€å°å€¼
          }
          
          input.value = newValue;
          
          // å®æ—¶æ›´æ–°æ˜¾ç¤ºï¼ˆå¦‚æœè®¡æ—¶å™¨æœªè¿è¡Œï¼‰
          if (!timerIsRunning) {
            const hour = parseInt($('#timerHour').value) || 0;
            const minute = parseInt($('#timerMinute').value) || 0;
            const second = parseInt($('#timerSecond').value) || 0;
            const totalSeconds = hour * 3600 + minute * 60 + second;
            if (totalSeconds > 0) {
              timerTotalSeconds = totalSeconds;
              timerCurrentSeconds = 0;
              timerUpdateDisplay();
            }
          }
        }, { passive: false });
        
        // æ·»åŠ ç„¦ç‚¹æ—¶çš„è§†è§‰åé¦ˆ
        input.addEventListener('focus', () => {
          input.style.transform = 'scale(1.05)';
        });
        
        input.addEventListener('blur', () => {
          input.style.transform = 'scale(1)';
        });
        
        // è¾“å…¥æ—¶å®æ—¶æ›´æ–°
        input.addEventListener('input', () => {
          if (!timerIsRunning) {
            const hour = parseInt($('#timerHour').value) || 0;
            const minute = parseInt($('#timerMinute').value) || 0;
            const second = parseInt($('#timerSecond').value) || 0;
            const totalSeconds = hour * 3600 + minute * 60 + second;
            if (totalSeconds > 0) {
              timerTotalSeconds = totalSeconds;
              timerCurrentSeconds = 0;
              timerUpdateDisplay();
            }
          }
        });
      });
    }

    function timerStop() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      timerIsRunning = false;
      timerIsPaused = false;
      
      $('#timerStartBtn').style.display = 'inline-block';
      $('#timerPauseBtn').style.display = 'none';
      $('#timerResumeBtn').style.display = 'none';
    }

    // ==================== å¯†ç ä¿æŠ¤ç³»ç»Ÿ ====================
    function checkPassword(showAlert = true, callback = null) {
      const saved = localStorage.getItem(PASSWORD_KEY);
      if (!saved) {
        // æœªè®¾ç½®å¯†ç ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒæˆ–è¿”å› true
        if (callback) {
          callback();
          return;
        }
        return true;
      }
      
      // å¦‚æœæä¾›äº†å›è°ƒå‡½æ•°ï¼Œä½¿ç”¨æ¨¡æ€æ¡†æ–¹å¼
      if (callback) {
        openModal('ğŸ”’ å¯†ç éªŒè¯', `
          <div style="padding: 16px 0;">
            <div class="subtle" style="margin-bottom: 16px;">æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜å¯†ç éªŒè¯</div>
            <div style="position: relative;">
              <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 100%; padding-right: 40px;" autofocus>
              <button 
                type="button" 
                onclick="togglePasswordVisibility()" 
                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px 8px; color: var(--muted);"
                title="æ˜¾ç¤º/éšè—å¯†ç ">
                ğŸ‘ï¸
              </button>
            </div>
          </div>
        `);
        
        $('#modalOk').textContent = 'éªŒè¯';
        $('#modalOk').onclick = () => {
          const input = $('#passwordInput').value;
          if (input === saved) {
            closeModal();
            callback();
          } else {
            alert('âŒ å¯†ç é”™è¯¯ï¼');
            $('#passwordInput').value = '';
            $('#passwordInput').focus();
          }
        };
        
        // æ”¯æŒå›è½¦é”®æäº¤
        setTimeout(() => {
          $('#passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              $('#modalOk').click();
            }
          });
        }, 100);
        
        return;
      }
      
      // å…¼å®¹æ—§çš„åŒæ­¥æ–¹å¼ï¼ˆç”¨äºéœ€è¦ç«‹å³è¿”å› boolean çš„åœºæ™¯ï¼‰
      const input = prompt('ğŸ”’ æ­¤æ“ä½œéœ€è¦å¯†ç éªŒè¯ï¼š');
      if (input === null) return false;
      
      if (input === saved) {
        return true;
      } else {
        if (showAlert) alert('âŒ å¯†ç é”™è¯¯ï¼');
        return false;
      }
    }
    
    function togglePasswordVisibility() {
      const input = $('#passwordInput');
      if (!input) return;
      
      if (input.type === 'password') {
        input.type = 'text';
      } else {
        input.type = 'password';
      }
    }

    function savePassword() {
      const newPwd = $('#newPassword').value;
      const confirmPwd = $('#confirmPassword').value;
      
      if (newPwd !== confirmPwd) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
        return;
      }
      
      if (newPwd === '') {
        // åˆ é™¤å¯†ç ä¿æŠ¤
        if (confirm('ç¡®å®šè¦ç¦ç”¨å¯†ç ä¿æŠ¤å—ï¼Ÿ')) {
          localStorage.removeItem(PASSWORD_KEY);
          toast('å¯†ç ä¿æŠ¤å·²ç¦ç”¨');
          renderSettings();
        }
      } else {
        // è®¾ç½®å¯†ç 
        if (newPwd.length < 4) {
          alert('å¯†ç é•¿åº¦è‡³å°‘4ä½ï¼');
          return;
        }
        localStorage.setItem(PASSWORD_KEY, newPwd);
        toast('å¯†ç å·²è®¾ç½®æˆåŠŸ');
        $('#newPassword').value = '';
        $('#confirmPassword').value = '';
        renderSettings();
      }
    }

    function clearAllPoints() {
      if (!checkPassword()) return;
      
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…ç©ºï¼š\nâ€¢ å¯ç”¨ç§¯åˆ†\nâ€¢ æ’åç§¯åˆ†\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      
      state.students.forEach(s => {
        s.points = 0;
        s.totalEarned = 0;  // åŒæ—¶æ¸…ç©ºæ’åç§¯åˆ†
      });
      
      state.history.unshift({
        id: gid(),
        time: now(),
        title: 'ç³»ç»Ÿæ“ä½œ',
        detail: 'æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿç§¯åˆ†ï¼ˆå¯ç”¨ç§¯åˆ†å’Œæ’åç§¯åˆ†ï¼‰',
        delta: 0
      });
      
      saveState();
      toast('âœ… å·²æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿçš„å¯ç”¨ç§¯åˆ†å’Œæ’åç§¯åˆ†');
      renderAll();
    }
    
    function renameCurrentClass() {
      const currentClass = getClass();
      if (!currentClass) return;
      
      const newName = prompt('è¯·è¾“å…¥æ–°çš„ç­çº§åç§°ï¼š', currentClass.name);
      if (!newName || !newName.trim()) return;
      
      if (newName.trim() === currentClass.name) {
        alert('ç­çº§åç§°æœªæ”¹å˜');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–ç­çº§é‡å
      const exists = classes.find(c => c.id !== currentClass.id && c.name === newName.trim());
      if (exists) {
        alert('è¯¥ç­çº§åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
        return;
      }
      
      const oldName = currentClass.name;
      currentClass.name = newName.trim();
      
      saveClasses();
      refreshClassOptions();
      toast(`âœ… ç­çº§å·²é‡å‘½åï¼š${oldName} â†’ ${newName.trim()}`);
    }
    
    function resetSystemToInitial() {
      if (!checkPassword()) return;
      
      if (!confirm('âš ï¸âš ï¸âš ï¸ å±é™©è­¦å‘Š âš ï¸âš ï¸âš ï¸\n\næ‚¨å³å°†é‡ç½®ç³»ç»Ÿåˆ°åˆå§‹çŠ¶æ€ï¼\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯å’Œå¤´åƒ\nâ€¢ æ‰€æœ‰å°ç»„ä¿¡æ¯\nâ€¢ æ‰€æœ‰ç§¯åˆ†è§„åˆ™\nâ€¢ æ‰€æœ‰å†å²è®°å½•\nâ€¢ æ‰€æœ‰å•†åŸå•†å“\nâ€¢ ç³»ç»Ÿå¯†ç \nâ€¢ è‡ªå®šä¹‰èƒŒæ™¯\nâ€¢ æ‰€æœ‰ç­çº§æ•°æ®\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼âš ï¸\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }
      
      // äºŒæ¬¡ç¡®è®¤
      const confirmText = prompt('è¯·è¾“å…¥"ç¡®è®¤é‡ç½®"æ¥ç¡®è®¤æ­¤æ“ä½œï¼š');
      if (confirmText !== 'ç¡®è®¤é‡ç½®') {
        alert('æ“ä½œå·²å–æ¶ˆ');
        return;
      }
      
      // æ¸…ç©ºlocalStorageä¸­çš„æ‰€æœ‰ç³»ç»Ÿæ•°æ®
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('cpm_')) {
          keysToRemove.push(key);
        }
      }
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // æ¸…ç©ºIndexedDBï¼ˆå¤´åƒæ•°æ®ï¼‰
      if (window.indexedDB) {
        const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
        deleteRequest.onsuccess = () => {
          console.log('IndexedDBå·²æ¸…ç©º');
        };
        deleteRequest.onerror = () => {
          console.error('æ¸…ç©ºIndexedDBå¤±è´¥');
        };
      }
      
      // æ˜¾ç¤ºæç¤ºå¹¶åˆ·æ–°é¡µé¢
      alert('âœ… ç³»ç»Ÿå·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...');
      
      // åˆ·æ–°é¡µé¢
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }
    
    function clearAllHistory() {
      if (!checkPassword()) return;
      
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…ç©ºï¼š\nâ€¢ æ‰€æœ‰ç§¯åˆ†å˜åŠ¨å†å²\nâ€¢ æ‰€æœ‰æ“ä½œè®°å½•\nâ€¢ æ‰€æœ‰æ’è¡Œæ¦œå¿«ç…§\nâ€¢ æ‰€æœ‰æ—¶é—´ç»´åº¦ç§¯åˆ†è®°å½•\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\næ³¨æ„ï¼šä¸ä¼šå½±å“å­¦ç”Ÿå½“å‰ç§¯åˆ†')) {
        return;
      }
      
      // æ¸…ç©ºå†å²è®°å½•
      state.history = [];
      
      // æ¸…ç©ºç§¯åˆ†å†å²è®°å½•ï¼ˆç”¨äºæ—¶é—´ç»´åº¦æ’åï¼‰
      pointHistory = {};
      localStorage.setItem(POINT_HISTORY_KEY, JSON.stringify(pointHistory));
      
      // æ¸…ç©ºæ’è¡Œæ¦œå¿«ç…§
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('cpm_rank_snapshot_')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // æ·»åŠ ä¸€æ¡æ¸…ç©ºæ“ä½œçš„è®°å½•
      state.history.unshift({
        id: gid(),
        time: now(),
        title: 'ç³»ç»Ÿæ“ä½œ',
        detail: 'æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ã€ç§¯åˆ†å†å²å’Œæ’è¡Œæ¦œå¿«ç…§',
        delta: 0
      });
      
      saveState();
      toast('âœ… å·²æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å’Œæ’è¡Œæ¦œæ•°æ®');
      renderAll();
    }

    function renderSettings() {
      const status = $('#passwordStatus');
      if (!status) return;
      
      const hasPassword = !!localStorage.getItem(PASSWORD_KEY);
      status.innerHTML = hasPassword ? 
        'âœ… å·²å¯ç”¨å¯†ç ä¿æŠ¤' : 
        'âš ï¸ æœªè®¾ç½®å¯†ç ä¿æŠ¤';
      status.style.color = hasPassword ? 'var(--success)' : 'var(--muted)';
      
      // æ›´æ–°å¤‡ä»½è®¾ç½®æç¤ºçŠ¶æ€
      updateBackupButtonStatus();
    }

    // ==================== è‡ªå®šä¹‰èƒŒæ™¯ç³»ç»Ÿ ====================
    function loadBackgroundSettings() {
      try {
        const saved = localStorage.getItem(BG_SETTINGS_KEY);
        if (saved) {
          bgSettings = JSON.parse(saved);
          $('#bgBlurRange').value = bgSettings.blur || 0;
          $('#bgOpacityRange').value = bgSettings.opacity || 30;
          $('#blurValue').textContent = bgSettings.blur || 0;
          $('#opacityValue').textContent = bgSettings.opacity || 30;
        }
      } catch (e) {
        console.error('åŠ è½½èƒŒæ™¯è®¾ç½®å¤±è´¥:', e);
      }
      
      // åŠ è½½èƒŒæ™¯å›¾ç‰‡
      const savedImage = localStorage.getItem(BG_IMAGE_KEY);
      if (savedImage) {
        applyBackgroundImage(savedImage, bgSettings);
      }
    }

    function applyBackgroundImage(imageData, settings) {
      const bg = document.createElement('div');
      bg.id = 'customBackground';
      bg.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url(${imageData});
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(${settings.blur}px);
        opacity: ${settings.opacity / 100};
        z-index: -1;
        pointer-events: none;
      `;
      
      // ç§»é™¤æ—§èƒŒæ™¯
      const old = document.getElementById('customBackground');
      if (old) old.remove();
      
      document.body.appendChild(bg);
    }

    function applyBackground() {
      const fileInput = $('#bgImageFile');
      const file = fileInput.files?.[0];
      
      if (!file) {
        alert('è¯·å…ˆé€‰æ‹©èƒŒæ™¯å›¾ç‰‡');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const imageData = e.target.result;
        
        // ä¿å­˜è®¾ç½®
        bgSettings.blur = parseInt($('#bgBlurRange').value);
        bgSettings.opacity = parseInt($('#bgOpacityRange').value);
        
        localStorage.setItem(BG_IMAGE_KEY, imageData);
        localStorage.setItem(BG_SETTINGS_KEY, JSON.stringify(bgSettings));
        
        applyBackgroundImage(imageData, bgSettings);
        toast('èƒŒæ™¯å·²åº”ç”¨');
      };
      
      reader.readAsDataURL(file);
    }

    function removeBackground() {
      if (!confirm('ç¡®å®šè¦ç§»é™¤è‡ªå®šä¹‰èƒŒæ™¯å—ï¼Ÿ')) return;
      
      localStorage.removeItem(BG_IMAGE_KEY);
      localStorage.removeItem(BG_SETTINGS_KEY);
      
      const bg = document.getElementById('customBackground');
      if (bg) bg.remove();
      
      toast('èƒŒæ™¯å·²ç§»é™¤');
    }

    // å®æ—¶æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
    function initBackgroundControls() {
      const blurRange = $('#bgBlurRange');
      const opacityRange = $('#bgOpacityRange');
      const blurValue = $('#blurValue');
      const opacityValue = $('#opacityValue');
      
      if (blurRange) {
        blurRange.addEventListener('input', (e) => {
          blurValue.textContent = e.target.value;
          // å®æ—¶é¢„è§ˆ
          const bg = document.getElementById('customBackground');
          if (bg) {
            bgSettings.blur = parseInt(e.target.value);
            bg.style.filter = `blur(${bgSettings.blur}px)`;
          }
        });
      }
      
      if (opacityRange) {
        opacityRange.addEventListener('input', (e) => {
          opacityValue.textContent = e.target.value;
          // å®æ—¶é¢„è§ˆ
          const bg = document.getElementById('customBackground');
          if (bg) {
            bgSettings.opacity = parseInt(e.target.value);
            bg.style.opacity = bgSettings.opacity / 100;
          }
        });
      }
    }

    // ==================== ä¸»é¢˜ç³»ç»Ÿ ====================
    function applyTheme(themeName) {
      // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
      document.body.classList.remove(
        'theme-dark', 
        'theme-green', 
        'theme-purple',
        'theme-orange',
        'theme-pink',
        'theme-blue',
        'theme-brown'
      );
      
      // åº”ç”¨æ–°ä¸»é¢˜
      if (themeName !== 'default') {
        document.body.classList.add(`theme-${themeName}`);
      }
      
      // ä¿å­˜ä¸»é¢˜
      localStorage.setItem(THEME_KEY, themeName);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY) || 'default';
      $('#themeSel').value = savedTheme;
      applyTheme(savedTheme);
    }

    // ==================== æ•°æ®å¯¼å…¥å¯¼å‡º ====================
    async function exportData() {
      try {
        const avatarBundle = {};
        const processedKeys = new Set();
        
        for (const student of state.students) {
          if (!student?.avatarKey || processedKeys.has(student.avatarKey)) continue;
          const dataUrl = await getAvatarDataUrl(student.avatarKey);
          if (dataUrl) {
            avatarBundle[student.avatarKey] = dataUrl;
            processedKeys.add(student.avatarKey);
          }
        }
        
      const data = {
        version: '1.2',
        exportTime: now(),
        className: getClass().name,
        state: state,
        pointHistory: pointHistory, // ä¸ªäººå†å²ç‹¬ç«‹å­˜å‚¨ï¼Œå¯¼å‡ºä¸€èµ·å¸¦ä¸Š
        mallItems: mallItems,
        avatars: avatarBundle
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${getClass().name}_æ•°æ®å¯¼å‡º_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
        toast('æ•°æ®å·²å¯¼å‡ºï¼ˆå«å¤´åƒï¼‰');
      } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
      }
    }

    function buildStudentSummaryRow(student, history) {
      const totalEarned = student.totalEarned || student.points || 0;
      const rankTier = calculateRankTier(totalEarned);
      const addCount = history.filter(h => h.delta > 0 && (h.type || 'adjust') !== 'exchange').length;
      const subCount = history.filter(h => h.delta < 0 && (h.type || 'adjust') !== 'exchange').length;
      const exchangeCount = history.filter(h => (h.type || 'adjust') === 'exchange').length;
      const lastRecord = history.length > 0 ? history[history.length - 1] : null;
      const lastDesc = lastRecord ? `${formatHistoryTimestamp(lastRecord)} ${lastRecord.reason || ''} (${lastRecord.delta > 0 ? '+' : ''}${lastRecord.delta})` : 'æš‚æ— è®°å½•';
      
      return [
        student.name,
        student.points || 0,
        totalEarned,
        rankTier.displayName,
        addCount,
        subCount,
        exchangeCount,
        lastDesc
      ];
    }

    function buildDetailRows(student, history) {
      if (history.length === 0) {
        return [[student.name, '-', 0, 'æš‚æ— è®°å½•', 'â€”']];
      }
      
      return history.map(entry => {
        const type = (entry.type || 'adjust') === 'exchange'
          ? 'å…‘æ¢'
          : (entry.delta >= 0 ? 'åŠ åˆ†' : 'å‡åˆ†');
        return [
          student.name,
          formatHistoryTimestamp(entry),
          entry.delta > 0 ? `+${entry.delta}` : entry.delta,
          type,
          entry.reason || ''
        ];
      });
    }

    function buildGroupSummaryRow(group, members, groupHistory) {
      const memberCount = members.length;
      const totalPoints = members.reduce((sum, s) => sum + (Number(s.points) || 0), 0);
      const totalEarned = members.reduce((sum, s) => sum + (Number(s.totalEarned || s.points || 0)), 0);
      const avgEarned = memberCount > 0 ? totalEarned / memberCount : 0;
      const rankTier = calculateRankTier(avgEarned);
      const addCount = groupHistory.filter(h => h.delta > 0 && h.type !== 'exchange').length;
      const subCount = groupHistory.filter(h => h.delta < 0 && h.type !== 'exchange').length;
      const exchangeCount = groupHistory.filter(h => h.type === 'exchange').length;
      const lastRecord = groupHistory.length > 0 ? groupHistory[groupHistory.length - 1] : null;
      const lastDesc = lastRecord
        ? `${formatHistoryTimestamp(lastRecord)} ${lastRecord.studentName || ''} ${lastRecord.reason || ''} (${lastRecord.delta > 0 ? '+' : ''}${lastRecord.delta})`
        : 'æš‚æ— è®°å½•';
      
      return [
        group.name,
        memberCount,
        totalPoints,
        totalEarned,
        rankTier.displayName,
        addCount,
        subCount,
        exchangeCount,
        lastDesc
      ];
    }

    function buildGroupDetailRows(group, groupHistory) {
      if (groupHistory.length === 0) {
        return [[group.name, '-', '-', 0, 'æš‚æ— è®°å½•', 'â€”']];
      }
      
      return groupHistory.map(entry => {
        const type = entry.type === 'exchange'
          ? 'å…‘æ¢'
          : (entry.delta >= 0 ? 'åŠ åˆ†' : 'å‡åˆ†');
        return [
          group.name,
          entry.studentName || '',
          formatHistoryTimestamp(entry),
          entry.delta > 0 ? `+${entry.delta}` : entry.delta,
          type,
          entry.reason || ''
        ];
      });
    }

    function exportSingleStudentHistory(studentId) {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      const student = state.students.find(s => s.id === studentId);
      if (!student) {
        alert('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ');
        return;
      }
      
      const history = pointHistory[studentId] || [];
      const rankTier = calculateRankTier(student.totalEarned || student.points || 0);
      const summarySheet = [
        ['å­¦ç”Ÿå§“å', student.name],
        ['å½“å‰ç§¯åˆ†', student.points || 0],
        ['å†å²ç´¯è®¡ç§¯åˆ†', student.totalEarned || student.points || 0],
        ['æ®µä½', rankTier.displayName],
        ['è®°å½•æ•°é‡', history.length]
      ];
      
      const detailSheet = [['æ—¶é—´', 'ç±»å‹', 'ç§¯åˆ†å˜åŠ¨', 'åŸå›  / äº‹ä»¶']];
      if (history.length === 0) {
        detailSheet.push(['â€”', 'â€”', 0, 'æš‚æ— è®°å½•']);
      } else {
        history.forEach(entry => {
          const type = (entry.type || 'adjust') === 'exchange'
            ? 'å…‘æ¢'
            : (entry.delta >= 0 ? 'åŠ åˆ†' : 'å‡åˆ†');
          detailSheet.push([
            formatHistoryTimestamp(entry),
            type,
            entry.delta > 0 ? `+${entry.delta}` : entry.delta,
            entry.reason || ''
          ]);
        });
      }
      
      const wb = XLSX.utils.book_new();
      const summaryWs = XLSX.utils.aoa_to_sheet(summarySheet);
      summaryWs['!cols'] = [{ wch: 12 }, { wch: 20 }];
      XLSX.utils.book_append_sheet(wb, summaryWs, 'å­¦ç”Ÿæ¦‚è§ˆ');
      
      const detailWs = XLSX.utils.aoa_to_sheet(detailSheet);
      detailWs['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, detailWs, 'ç§¯åˆ†æ˜ç»†');
      
      const fileName = `${student.name}_ç§¯åˆ†æ˜ç»†_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      toast(`å·²å¯¼å‡º ${student.name} çš„ç§¯åˆ†æ˜ç»†`);
    }

    function exportDetailedReport() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const summarySheet = [['å­¦ç”Ÿå§“å', 'å½“å‰ç§¯åˆ†', 'å†å²ç´¯è®¡ç§¯åˆ†', 'æ®µä½', 'åŠ åˆ†æ¬¡æ•°', 'å‡åˆ†æ¬¡æ•°', 'å…‘æ¢æ¬¡æ•°', 'æœ€è¿‘ä¸€æ¬¡è®°å½•']];
      const detailSheet = [['å­¦ç”Ÿå§“å', 'æ—¶é—´', 'ç§¯åˆ†å˜åŠ¨', 'ç±»å‹', 'åŸå›  / äº‹ä»¶']];
      const groupSummarySheet = [['å°ç»„åç§°', 'æˆå‘˜æ•°', 'å½“å‰ç§¯åˆ†æ€»å’Œ', 'å†å²ç´¯è®¡æ€»å’Œ', 'æ®µä½', 'åŠ åˆ†æ¬¡æ•°', 'å‡åˆ†æ¬¡æ•°', 'å…‘æ¢æ¬¡æ•°', 'æœ€è¿‘ä¸€æ¬¡è®°å½•']];
      const groupDetailSheet = [['å°ç»„åç§°', 'å­¦ç”Ÿå§“å', 'æ—¶é—´', 'ç§¯åˆ†å˜åŠ¨', 'ç±»å‹', 'åŸå›  / äº‹ä»¶']];
      
      state.students.forEach(student => {
        const history = pointHistory[student.id] || [];
        summarySheet.push(buildStudentSummaryRow(student, history));
        const detailRows = buildDetailRows(student, history);
        detailRows.forEach(row => detailSheet.push(row));
      });
      
      const summaryWs = XLSX.utils.aoa_to_sheet(summarySheet);
      summaryWs['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 16 }, { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, summaryWs, 'å­¦ç”Ÿæ¦‚è§ˆ');
      
      const detailWs = XLSX.utils.aoa_to_sheet(detailSheet);
      detailWs['!cols'] = [{ wch: 12 }, { wch: 20 }, { wch: 12 }, { wch: 10 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, detailWs, 'ç§¯åˆ†æ˜ç»†');
      
      if (state.groups && state.groups.length > 0) {
        state.groups.forEach((group, groupIndex) => {
          const members = (group.members || [])
            .map(id => state.students.find(s => s.id === id))
            .filter(Boolean);
          
          const groupHistory = members.flatMap(student => {
            const history = pointHistory[student.id] || [];
            return history.map(entry => {
              const ts = entry.timestamp || (entry.time ? new Date(entry.time).getTime() : 0);
              return {
                ...entry,
                timestamp: ts,
                studentName: student.name,
                type: entry.type || 'adjust'
              };
            });
          }).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
          
          groupSummarySheet.push(buildGroupSummaryRow(group, members, groupHistory));
          const rows = buildGroupDetailRows(group, groupHistory);
          rows.forEach(row => groupDetailSheet.push(row));
          
          const singleGroupSheet = [['å­¦ç”Ÿå§“å', 'æ—¶é—´', 'ç§¯åˆ†å˜åŠ¨', 'ç±»å‹', 'åŸå›  / äº‹ä»¶']];
          const singleRows = buildGroupDetailRows(group, groupHistory);
          singleRows.forEach(row => singleGroupSheet.push(row));
          const singleWs = XLSX.utils.aoa_to_sheet(singleGroupSheet);
          singleWs['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 40 }];
          const sheetName = `${groupIndex + 1}.${group.name}`.slice(0, 31);
          XLSX.utils.book_append_sheet(wb, singleWs, sheetName);
        });
        
        const groupSummaryWs = XLSX.utils.aoa_to_sheet(groupSummarySheet);
        groupSummaryWs['!cols'] = [{ wch: 14 }, { wch: 10 }, { wch: 14 }, { wch: 16 }, { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, groupSummaryWs, 'å°ç»„æ¦‚è§ˆ');
        
        const groupDetailWs = XLSX.utils.aoa_to_sheet(groupDetailSheet);
        groupDetailWs['!cols'] = [{ wch: 14 }, { wch: 12 }, { wch: 20 }, { wch: 12 }, { wch: 10 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, groupDetailWs, 'å°ç»„æ˜ç»†');
      }
      
      const fileName = `${getClass().name}_ç§¯åˆ†æ˜ç»†_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      toast('ç§¯åˆ†æ˜ç»†å·²å¯¼å‡º');
    }

    function exportExcel() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      // åˆ›å»ºå·¥ä½œç°¿
      const wb = XLSX.utils.book_new();
      
      // 1. å­¦ç”Ÿä¿¡æ¯è¡¨
      const studentsData = [
        ['ç¼–å·', 'å§“å', 'å½“å‰ç§¯åˆ†', 'å†å²ç´¯è®¡ç§¯åˆ†', 'æ®µä½', 'æ‰€å±å°ç»„', 'å…‘æ¢æ¬¡æ•°']
      ];
      
      state.students.forEach((s, idx) => {
        const history = pointHistory[s.id] || [];
        const totalEarned = s.totalEarned || history.reduce((sum, h) => sum + (h.delta > 0 ? h.delta : 0), 0);
        const rankTier = calculateRankTier(totalEarned);
        const redeemCount = history.filter(h => h.reason && h.reason.includes('å…‘æ¢')).length;
        const groupName = state.groups.find(g => (g.members || []).includes(s.id))?.name || 'æœªåˆ†ç»„';
        
        studentsData.push([
          idx + 1,
          s.name,
          s.points || 0,
          totalEarned,
          rankTier.displayName,
          groupName,
          redeemCount
        ]);
      });
      
      const ws1 = XLSX.utils.aoa_to_sheet(studentsData);
      ws1['!cols'] = [
        { wch: 8 },
        { wch: 12 },
        { wch: 12 },
        { wch: 16 },
        { wch: 14 },
        { wch: 12 },
        { wch: 12 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, 'å­¦ç”Ÿä¿¡æ¯');
      
      // 2. ç§¯åˆ†æ’è¡Œæ¦œ
      const rankData = [['æ’å', 'å§“å', 'ç§¯åˆ†']];
      const sortedStudents = state.students.slice().sort((a, b) => (b.points || 0) - (a.points || 0));
      sortedStudents.forEach((s, idx) => {
        rankData.push([idx + 1, s.name, s.points || 0]);
      });
      
      const ws2 = XLSX.utils.aoa_to_sheet(rankData);
      ws2['!cols'] = [{ wch: 8 }, { wch: 12 }, { wch: 12 }];
      XLSX.utils.book_append_sheet(wb, ws2, 'ç§¯åˆ†æ’è¡Œ');
      
      // 3. å°ç»„ä¿¡æ¯è¡¨
      if (state.groups.length > 0) {
        const groupsData = [['å°ç»„åç§°', 'æˆå‘˜æ•°é‡', 'æˆå‘˜åˆ—è¡¨', 'æ€»ç§¯åˆ†', 'æ®µä½']];
        
        state.groups.forEach(g => {
          const members = (g.members || []).map(mid => {
            const s = state.students.find(x => x.id === mid);
            return s ? s.name : '';
          }).filter(Boolean);
          
          const memberObjects = (g.members || []).map(mid => state.students.find(x => x.id === mid)).filter(Boolean);
          const totalPoints = memberObjects.reduce((sum, s) => sum + (s?.points || 0), 0);
          const totalEarned = memberObjects.reduce((sum, s) => sum + (s?.totalEarned || s?.points || 0), 0);
          const avgEarned = memberObjects.length > 0 ? totalEarned / memberObjects.length : 0;
          const rankTier = calculateRankTier(avgEarned);
          
          groupsData.push([
            g.name,
            members.length,
            members.join('ã€'),
            totalPoints,
            rankTier.displayName
          ]);
        });
        
        const ws3 = XLSX.utils.aoa_to_sheet(groupsData);
        ws3['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 30 }, { wch: 12 }, { wch: 14 }];
        XLSX.utils.book_append_sheet(wb, ws3, 'å°ç»„ä¿¡æ¯');
      }
      
      // 4. ç§¯åˆ†å†å²è®°å½•
      if (state.history.length > 0) {
        const historyData = [['æ—¶é—´', 'æ“ä½œç±»å‹', 'è¯¦æƒ…', 'ç§¯åˆ†å˜åŒ–']];
        
        state.history.slice(0, 500).forEach(h => {
          historyData.push([
            h.time,
            h.title,
            h.detail,
            h.delta > 0 ? `+${h.delta}` : h.delta
          ]);
        });
        
        const ws4 = XLSX.utils.aoa_to_sheet(historyData);
        ws4['!cols'] = [{ wch: 18 }, { wch: 12 }, { wch: 30 }, { wch: 12 }];
        XLSX.utils.book_append_sheet(wb, ws4, 'å†å²è®°å½•');
      }
      
      // 5. å•†åŸä¿¡æ¯
      if (mallItems.length > 0) {
        const mallData = [['å•†å“åç§°', 'ä»·æ ¼', 'åº“å­˜', 'æè¿°']];
        
        mallItems.forEach(item => {
          mallData.push([
            item.name,
            item.price,
            item.stock === -1 ? 'æ— é™' : item.stock,
            item.desc || ''
          ]);
        });
        
        const ws5 = XLSX.utils.aoa_to_sheet(mallData);
        ws5['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 30 }];
        XLSX.utils.book_append_sheet(wb, ws5, 'å•†åŸå•†å“');
      }
      
      // 6. ç§¯åˆ†è§„åˆ™
      if (state.rules.length > 0) {
        const rulesData = [['è§„åˆ™åç§°', 'ç§¯åˆ†å€¼', 'æè¿°']];
        
        state.rules.forEach(r => {
          rulesData.push([
            r.name,
            r.delta > 0 ? `+${r.delta}` : r.delta,
            r.desc || ''
          ]);
        });
        
        const ws6 = XLSX.utils.aoa_to_sheet(rulesData);
        ws6['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, ws6, 'ç§¯åˆ†è§„åˆ™');
      }
      
      // å¯¼å‡ºæ–‡ä»¶
      const fileName = `${getClass().name}_ç§¯åˆ†æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      toast('Excelæ–‡ä»¶å·²å¯¼å‡º');
    }

    function exportRules() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      if (state.rules.length === 0) {
        alert('è¿˜æ²¡æœ‰ç§¯åˆ†è§„åˆ™ï¼Œè¯·å…ˆæ·»åŠ è§„åˆ™');
        return;
      }

      const wb = XLSX.utils.book_new();
      const rulesData = [['è§„åˆ™åç§°', 'ç§¯åˆ†å€¼', 'æè¿°']];
      
      state.rules.forEach(r => {
        rulesData.push([
          r.name,
          r.delta > 0 ? `+${r.delta}` : r.delta,
          r.desc || ''
        ]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(rulesData);
      ws['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, ws, 'ç§¯åˆ†è§„åˆ™');
      
      const fileName = `${getClass().name}_ç§¯åˆ†è§„åˆ™_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      toast(`å·²å¯¼å‡º ${state.rules.length} æ¡ç§¯åˆ†è§„åˆ™`);
    }

    // å¯¼å‡ºå°ç»„æ•°æ®
    function exportGroups() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      if (state.groups.length === 0) {
        alert('è¿˜æ²¡æœ‰å°ç»„ï¼Œè¯·å…ˆåˆ›å»ºå°ç»„');
        return;
      }

      const wb = XLSX.utils.book_new();
      const groupsData = [['å°ç»„åç§°', 'æˆå‘˜å§“å']];
      
      state.groups.forEach(g => {
        // è·å–å°ç»„æˆå‘˜çš„å§“ååˆ—è¡¨
        const memberNames = (g.members || [])
          .map(mid => {
            const student = state.students.find(s => s.id === mid);
            return student ? student.name : '';
          })
          .filter(name => name) // è¿‡æ»¤æ‰æ‰¾ä¸åˆ°çš„å­¦ç”Ÿ
          .join(','); // ç”¨é€—å·åˆ†éš”
        
        groupsData.push([
          g.name,
          memberNames || ''
        ]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(groupsData);
      ws['!cols'] = [{ wch: 20 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, ws, 'å°ç»„æ•°æ®');
      
      const fileName = `${getClass().name}_å°ç»„æ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      toast(`å·²å¯¼å‡º ${state.groups.length} ä¸ªå°ç»„`);
    }

    function exportMallItems() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      if (mallItems.length === 0) {
        alert('è¿˜æ²¡æœ‰å•†åŸå•†å“ï¼Œè¯·å…ˆæ·»åŠ å•†å“');
        return;
      }

      const wb = XLSX.utils.book_new();
      const mallData = [['å•†å“åç§°', 'ä»·æ ¼', 'åº“å­˜', 'æè¿°']];
      
      mallItems.forEach(item => {
        mallData.push([
          item.name,
          item.price,
          item.stock === -1 ? 'æ— é™' : item.stock,
          item.description || ''
        ]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(mallData);
      ws['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 40 }];
      XLSX.utils.book_append_sheet(wb, ws, 'å•†åŸå•†å“');
      
      const fileName = `${getClass().name}_ç§¯åˆ†å•†åŸ_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      toast(`å·²å¯¼å‡º ${mallItems.length} ä¸ªå•†åŸå•†å“`);
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json,.json';
      
      input.onchange = e => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async event => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (!data.state) {
              alert('æ— æ•ˆçš„æ•°æ®æ–‡ä»¶');
              return;
            }
            
            if (!confirm(`ç¡®å®šå¯¼å…¥æ•°æ®å—ï¼Ÿ\næ¥æºï¼š${data.className || 'æœªçŸ¥'}\nå¯¼å‡ºæ—¶é—´ï¼š${data.exportTime || 'æœªçŸ¥'}\n\nå½“å‰ç­çº§æ•°æ®å°†è¢«è¦†ç›–ï¼`)) {
              return;
            }
            
            // å¯¼å…¥æ•°æ®
            state = data.state;
            if (data.mallItems) {
              mallItems = data.mallItems;
              saveMallItems();
            }
            if (data.pointHistory) {
              pointHistory = data.pointHistory;
              savePointHistory();
            }
            
            saveState();
            
            if (data.avatars) {
              await restoreAvatarsFromBackup(data.avatars);
            }
            
            renderAll();
            toast('æ•°æ®å¯¼å…¥æˆåŠŸï¼ˆå«å¤´åƒï¼‰');
          } catch (err) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    function renderAll() {
      const view = $('.nav-btn.active')?.dataset.view || 'students';
      
      if (view === 'students') renderStudents();
      if (view === 'groups') renderGroups();
      if (view === 'rules') renderRules();
      if (view === 'history') renderHistory();
      if (view === 'mall') renderMall();
      if (view === 'randomcall') {
        renderRcHistory();
        // åˆå§‹åŒ–æ˜Ÿç©ºå’Œæ˜Ÿçƒ
        setTimeout(() => {
          initRcStars();
          createPlanetNames();
          initRcSpeechSynthesis();
        }, 100);
      } else {
        // åœæ­¢æ˜Ÿç©ºåŠ¨ç”»ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
        if (rcStarAnimation) {
          cancelAnimationFrame(rcStarAnimation);
          rcStarAnimation = null;
        }
      }
      
      renderRank();
    }

    // ==================== å¼¹çª—ç®¡ç† ====================
    function openModal(title, bodyHtml) {
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = bodyHtml;
      $('#modal').classList.add('show');
      
      // é‡ç½®æŒ‰é’®çŠ¶æ€
      $('#modalOk').style.display = '';
      $('#modalOk').textContent = 'ç¡®å®š';
      $('#modalCancel').textContent = 'å–æ¶ˆ';
      
      $('#modalCancel').onclick = closeModal;
      $('#modalOk').onclick = closeModal; // é»˜è®¤è¡Œä¸ºï¼Œä¼šè¢«è¦†ç›–
    }

    function closeModal() {
      $('#modal').classList.remove('show');
      
      // é‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶æŒ‰é’®ä»ç„¶ç¦ç”¨
      const okBtn = $('#modalOk');
      if (okBtn) {
        okBtn.disabled = false;
        okBtn.textContent = 'ç¡®å®š';
      }
    }

    // ==================== å­—æ¯é”®ç›˜ ====================
    function initAlphabetKeyboard() {
      const keyboard = $('#alphabetKeyboard');
      if (!keyboard) return;
      
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      let activeKey = null;
      
      keyboard.innerHTML = letters.map(letter => 
        `<button class="key-btn" data-letter="${letter}">${letter}</button>`
      ).join('') + `<button class="key-btn clear-btn">æ¸…é™¤</button>`;
      
      // ç»‘å®šäº‹ä»¶
      keyboard.querySelectorAll('.key-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const letter = btn.dataset.letter;
          
          if (letter) {
            // ç‚¹å‡»å­—æ¯
            if (activeKey === letter) {
              // å–æ¶ˆé€‰ä¸­
              btn.classList.remove('active');
              activeKey = null;
              $('#studentSearch').value = '';
              renderStudents('');
            } else {
              // é€‰ä¸­æ–°å­—æ¯
              keyboard.querySelectorAll('.key-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              activeKey = letter;
              $('#studentSearch').value = letter;
              renderStudents(letter);
            }
          } else {
            // ç‚¹å‡»æ¸…é™¤
            keyboard.querySelectorAll('.key-btn').forEach(b => b.classList.remove('active'));
            activeKey = null;
            $('#studentSearch').value = '';
            renderStudents('');
          }
        });
      });
    }

    // ==================== å¯¼èˆªåˆ‡æ¢ ====================
    function switchView(view) {
      // éšè—æ‰€æœ‰è§†å›¾
      $('#studentsView').style.display = 'none';
      $('#groupsView').style.display = 'none';
      $('#rulesView').style.display = 'none';
      $('#historyView').style.display = 'none';
      $('#mallView').style.display = 'none';
      $('#randomcallView').style.display = 'none';
      $('#timerView').style.display = 'none';
      $('#settingsView').style.display = 'none';
      
      // æ˜¾ç¤ºç›®æ ‡è§†å›¾
      const viewMap = {
        'students': { id: 'studentsView', title: 'ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç®¡ç†', showAdd: true },
        'groups': { id: 'groupsView', title: 'ğŸ‘¥ å°ç»„ç®¡ç†', showAdd: false },
        'rules': { id: 'rulesView', title: 'ğŸ“ ç§¯åˆ†è§„åˆ™', showAdd: false },
        'history': { id: 'historyView', title: 'ğŸ“Š å†å²è®°å½•', showAdd: false },
        'mall': { id: 'mallView', title: 'ğŸ›’ ç§¯åˆ†å•†åŸ', showAdd: false },
        'randomcall': { id: 'randomcallView', title: 'ğŸ² éšæœºç‚¹å', showAdd: false },
        'timer': { id: 'timerView', title: 'â±ï¸ è®¡æ—¶å™¨', showAdd: false },
        'settings': { id: 'settingsView', title: 'âš™ï¸ ç³»ç»Ÿè®¾ç½®', showAdd: false }
      };
      
      const target = viewMap[view];
      if (target) {
        $(`#${target.id}`).style.display = 'block';
        $('#contentTitle').textContent = target.title;
        
        // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
        $('#addStudentBtn').style.display = target.showAdd ? 'inline-block' : 'none';
        $('#batchAddBtn').style.display = target.showAdd ? 'inline-block' : 'none';
        
        // è®¾ç½®é¡µé¢éœ€è¦æ¸²æŸ“çŠ¶æ€
        if (view === 'settings') {
          setTimeout(() => renderSettings(), 0);
        }
        
        // è®¡æ—¶å™¨é¡µé¢éœ€è¦åˆå§‹åŒ–æ»šè½®è¾“å…¥
        if (view === 'timer') {
          setTimeout(() => initTimerWheelInputs(), 0);
        }
      }
      
      // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
      $$('.nav-btn').forEach(btn => btn.classList.remove('active'));
      $(`.nav-btn[data-view="${view}"]`)?.classList.add('active');
      
      renderAll();
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    function initEventListeners() {
      // ç­çº§ç®¡ç†
      $('#classSel').addEventListener('change', e => {
        switchClass(e.target.value);
      });
      
      $('#addClassBtn').addEventListener('click', addClass);
      $('#deleteClassBtn').addEventListener('click', deleteClass);
      $('#exportDataBtn').addEventListener('click', exportData);
      $('#exportExcelBtn').addEventListener('click', exportExcel);
      $('#exportDetailBtn').addEventListener('click', exportDetailedReport);
      $('#importDataBtn').addEventListener('click', importData);
      $('#backupSettingsBtn').addEventListener('click', selectBackupFolder);
      $('#exportRulesBtn').addEventListener('click', exportRules);
      $('#importGroupsBtn').addEventListener('click', importGroupsExcel);
      $('#exportGroupsBtn').addEventListener('click', exportGroups);
      $('#importMallBtn').addEventListener('click', importMallItemsExcel);
      $('#exportMallBtn').addEventListener('click', exportMallItems);
      $('#themeSel').addEventListener('change', e => {
        applyTheme(e.target.value);
      });
      
      // å­¦ç”Ÿç®¡ç†
      $('#addStudentBtn').addEventListener('click', addStudent);
      $('#batchAddBtn').addEventListener('click', openBatchAdd);
      $('#importStudentsTxt').addEventListener('click', importStudentsTxt);
      $('#importStudentsExcel').addEventListener('click', importStudentsExcel);
      
      // æœç´¢åŠŸèƒ½
      $('#studentSearch').addEventListener('input', e => {
        const value = e.target.value.trim();
        renderStudents(value);
        
        // åŒæ­¥æ¸…é™¤å­—æ¯é”®ç›˜æ¿€æ´»çŠ¶æ€
        if (!value) {
          $$('#alphabetKeyboard .key-btn').forEach(b => b.classList.remove('active'));
        }
      });
      
      // å¿«é€Ÿè°ƒæ•´
      $('#fastPlus1').addEventListener('click', () => {
        const ids = getChecked();
        if (ids.length === 0) {
          alert('è¯·å…ˆå‹¾é€‰å­¦ç”Ÿ');
          return;
        }
        openQuickAdjust(ids, 'add');
      });
      
      $('#fastMinus1').addEventListener('click', () => {
        const ids = getChecked();
        if (ids.length === 0) {
          alert('è¯·å…ˆå‹¾é€‰å­¦ç”Ÿ');
          return;
        }
        openQuickAdjust(ids, 'subtract');
      });
      
      $('#customAdjust').addEventListener('click', openCustomAdjust);
      
      // å…¨ç­åŠ å‡åˆ†
      $('#allClassPlus').addEventListener('click', () => {
        allClassAdjust('add');
      });
      
      $('#allClassMinus').addEventListener('click', () => {
        allClassAdjust('subtract');
      });
      
      // è§„åˆ™å¯¼å…¥
      $('#importRulesTxt').addEventListener('click', importRulesTxt);
      $('#importRulesExcel').addEventListener('click', importRulesExcel);
      
      // å¯¼èˆªåˆ‡æ¢
      $$('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchView(btn.dataset.view);
        });
      });
      
      // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
      $('#modal').addEventListener('click', e => {
        if (e.target === $('#modal')) closeModal();
      });
      
      // ESC å…³é—­å¼¹çª—
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
      });
    }

    // ==================== å¯¼å…¥åŠŸèƒ½ ====================
    
    // å­¦ç”ŸTXTå¯¼å…¥ (æ ¼å¼: å§“å å°ç»„å)
    function importStudentsTxt() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        let count = 0;
        for (const line of lines) {
          const parts = line.trim().split(/\s+/);
          if (parts.length >= 1) {
            const name = parts[0];
            const groupName = parts[1] || '';
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºå°ç»„
            let group = null;
            if (groupName) {
              group = state.groups.find(g => g.name === groupName);
              if (!group) {
                group = { id: gid(), name: groupName, members: [] };
                state.groups.push(group);
              }
              // ç¡®ä¿å·²æœ‰å°ç»„ä¹Ÿæœ‰ members æ•°ç»„ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
              if (!group.members) {
                group.members = [];
              }
            }
            
            // æ·»åŠ å­¦ç”Ÿ
            const studentId = gid();
            state.students.push({
              id: studentId,
              name: name,
              points: 0,
              totalEarned: 0,  // å†å²ç´¯è®¡ç§¯åˆ†ï¼ˆç”¨äºæ’åï¼‰
              groupId: group ? group.id : null
            });
            
            // å°†å­¦ç”Ÿæ·»åŠ åˆ°å°ç»„çš„æˆå‘˜åˆ—è¡¨ä¸­
            if (group) {
              group.members.push(studentId);
            }
            
            count++;
          }
        }
        
        saveState();
        renderAll();
        toast(`âœ… æˆåŠŸå¯¼å…¥ ${count} åå­¦ç”Ÿ`);
      };
      input.click();
    }
    
    // å­¦ç”ŸExcelå¯¼å…¥ (éœ€è¦SheetJSåº“)
    function importStudentsExcel() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        let count = 0;
        // è·³è¿‡æ ‡é¢˜è¡Œ
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row[0]) { // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯å§“å
            const name = String(row[0]).trim();
            const groupName = row[1] ? String(row[1]).trim() : '';
            const points = row[2] ? parseInt(row[2]) : 0;
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºå°ç»„
            let group = null;
            if (groupName) {
              group = state.groups.find(g => g.name === groupName);
              if (!group) {
                group = { id: gid(), name: groupName, members: [] };
                state.groups.push(group);
              }
              // ç¡®ä¿å·²æœ‰å°ç»„ä¹Ÿæœ‰ members æ•°ç»„ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
              if (!group.members) {
                group.members = [];
              }
            }
            
            // æ·»åŠ å­¦ç”Ÿ
            const studentId = gid();
            state.students.push({
              id: studentId,
              name: name,
              points: points,
              totalEarned: points,  // åˆå§‹æ’åç§¯åˆ†ç­‰äºå¯¼å…¥çš„ç§¯åˆ†
              groupId: group ? group.id : null
            });
            
            // å°†å­¦ç”Ÿæ·»åŠ åˆ°å°ç»„çš„æˆå‘˜åˆ—è¡¨ä¸­
            if (group) {
              group.members.push(studentId);
            }
            
            count++;
          }
        }
        
        saveState();
        renderAll();
        toast(`âœ… æˆåŠŸä»Excelå¯¼å…¥ ${count} åå­¦ç”Ÿ`);
      };
      input.click();
    }
    
    // æ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ ¹æ®åç§°å’Œåˆ†å€¼ï¼‰
    function ruleExists(name, delta) {
      return state.rules.some(rule => 
        rule.name.trim() === name.trim() && rule.delta === delta
      );
    }
    
    // è§„åˆ™TXTå¯¼å…¥ (æ ¼å¼: è§„åˆ™åç§° åˆ†å€¼)
    function importRulesTxt() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        let count = 0;
        let skipped = 0;
        for (const line of lines) {
          const parts = line.trim().split(/\s+/);
          if (parts.length >= 2) {
            const name = parts[0];
            const delta = parseInt(parts[1]) || 0;
            
            if (delta !== 0) {
              // æ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨
              if (!ruleExists(name, delta)) {
              state.rules.push({
                id: gid(),
                name: name,
                delta: delta,
                desc: ''
              });
              count++;
              } else {
                skipped++;
              }
            }
          }
        }
        
        saveState();
        renderRules();
        if (count > 0) {
          toast(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡æ–°è§„åˆ™${skipped > 0 ? `ï¼Œè·³è¿‡ ${skipped} æ¡å·²å­˜åœ¨çš„è§„åˆ™` : ''}`);
        } else if (skipped > 0) {
          toast(`â„¹ï¸ æ‰€æœ‰è§„åˆ™éƒ½å·²å­˜åœ¨ï¼Œæœªå¯¼å…¥æ–°è§„åˆ™ï¼ˆå…± ${skipped} æ¡ï¼‰`);
        } else {
          toast(`âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„è§„åˆ™æ•°æ®`);
        }
      };
      input.click();
    }
    
    // è§„åˆ™Excelå¯¼å…¥
    function importRulesExcel() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        let count = 0;
        let skipped = 0;
        // è·³è¿‡æ ‡é¢˜è¡Œ
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row[0] && row[1]) {
            const name = String(row[0]).trim();
            const delta = parseInt(row[1]) || 0;
            const desc = row[2] ? String(row[2]).trim() : '';
            
            if (delta !== 0) {
              // æ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨
              if (!ruleExists(name, delta)) {
              state.rules.push({
                id: gid(),
                name: name,
                delta: delta,
                desc: desc
              });
              count++;
              } else {
                skipped++;
              }
            }
          }
        }
        
        saveState();
        renderRules();
        if (count > 0) {
          toast(`âœ… æˆåŠŸä»Excelå¯¼å…¥ ${count} æ¡æ–°è§„åˆ™${skipped > 0 ? `ï¼Œè·³è¿‡ ${skipped} æ¡å·²å­˜åœ¨çš„è§„åˆ™` : ''}`);
        } else if (skipped > 0) {
          toast(`â„¹ï¸ æ‰€æœ‰è§„åˆ™éƒ½å·²å­˜åœ¨ï¼Œæœªå¯¼å…¥æ–°è§„åˆ™ï¼ˆå…± ${skipped} æ¡ï¼‰`);
        } else {
          toast(`âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„è§„åˆ™æ•°æ®`);
        }
      };
      input.click();
    }

    // å•†åŸå•†å“Excelå¯¼å…¥
    function importMallItemsExcel() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å…¥åŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          let count = 0;
          let skipped = 0;
          // è·³è¿‡æ ‡é¢˜è¡Œ
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row[0] && row[1]) {
              const name = String(row[0]).trim();
              const price = parseInt(row[1]) || 0;
              // å¤„ç†åº“å­˜ï¼šå¦‚æœä¸ºç©ºæˆ–æ— æ•ˆï¼Œé»˜è®¤ä¸º-1ï¼ˆæ— é™ï¼‰
              let stock = -1;
              if (row[2] !== undefined && row[2] !== null && row[2] !== '') {
                const stockValue = String(row[2]).trim();
                if (stockValue === 'æ— é™' || stockValue.toLowerCase() === 'unlimited') {
                  stock = -1;
                } else {
                  stock = parseInt(stockValue) || -1;
                }
              }
              const description = row[3] ? String(row[3]).trim() : '';
              
              if (name && price > 0) {
                mallItems.push({
                  id: gid(),
                  name: name,
                  price: price,
                  stock: stock,
                  description: description
                });
                count++;
              } else {
                skipped++;
              }
            } else {
              skipped++;
            }
          }
          
          if (count > 0) {
            saveMallItems();
            renderMall();
            toast(`âœ… æˆåŠŸä»Excelå¯¼å…¥ ${count} ä¸ªå•†å“${skipped > 0 ? `ï¼Œè·³è¿‡ ${skipped} è¡Œæ— æ•ˆæ•°æ®` : ''}`);
          } else {
            alert('æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½•å•†å“ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®\næ ¼å¼ï¼šå•†å“åç§°|ä»·æ ¼|åº“å­˜|æè¿°ï¼ˆé¦–è¡Œä¸ºæ ‡é¢˜è¡Œï¼‰');
          }
        } catch (error) {
          console.error('å¯¼å…¥å¤±è´¥:', error);
          alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
        }
      };
      input.click();
    }

    // å¯¼å…¥å°ç»„æ•°æ®
    function importGroupsExcel() {
      if (typeof XLSX === 'undefined') {
        alert('Excelå¯¼å…¥åŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥åŠ è½½åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          let created = 0;
          let updated = 0;
          let skipped = 0;
          let notFoundStudents = [];
          
          // è·³è¿‡æ ‡é¢˜è¡Œ
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row[0]) {
              const groupName = String(row[0]).trim();
              const membersStr = row[1] ? String(row[1]).trim() : '';
              
              if (!groupName) {
                skipped++;
                continue;
              }
              
              // æŸ¥æ‰¾æˆ–åˆ›å»ºå°ç»„
              let group = state.groups.find(g => g.name === groupName);
              if (!group) {
                group = {
                  id: gid(),
                  name: groupName,
                  members: []
                };
                state.groups.push(group);
                created++;
              } else {
                updated++;
              }
              
              // å¤„ç†æˆå‘˜
              if (membersStr) {
                const memberNames = membersStr.split(',').map(n => n.trim()).filter(n => n);
                const memberIds = [];
                
                for (const memberName of memberNames) {
                  const student = state.students.find(s => s.name === memberName);
                  if (student) {
                    // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²ç»åœ¨å…¶ä»–å°ç»„
                    let alreadyInGroup = false;
                    for (const g of state.groups) {
                      if (g.id !== group.id && (g.members || []).includes(student.id)) {
                        alreadyInGroup = true;
                        break;
                      }
                    }
                    
                    if (!alreadyInGroup && !memberIds.includes(student.id)) {
                      memberIds.push(student.id);
                    }
                  } else {
                    if (!notFoundStudents.includes(memberName)) {
                      notFoundStudents.push(memberName);
                    }
                  }
                }
                
                // ä»å…¶ä»–å°ç»„ä¸­ç§»é™¤è¿™äº›æˆå‘˜
                state.groups.forEach(g => {
                  if (g.id !== group.id) {
                    g.members = (g.members || []).filter(mid => !memberIds.includes(mid));
                  }
                });
                
                group.members = memberIds;
              } else {
                group.members = [];
              }
            } else {
              skipped++;
            }
          }
          
          saveState();
          renderAll();
          
          let message = '';
          if (created > 0 || updated > 0) {
            message = `âœ… æˆåŠŸå¯¼å…¥å°ç»„æ•°æ®ï¼šåˆ›å»º ${created} ä¸ªæ–°å°ç»„ï¼Œæ›´æ–° ${updated} ä¸ªç°æœ‰å°ç»„`;
            if (skipped > 0) {
              message += `ï¼Œè·³è¿‡ ${skipped} è¡Œæ— æ•ˆæ•°æ®`;
            }
            if (notFoundStudents.length > 0) {
              message += `\nâš ï¸ æœªæ‰¾åˆ°ä»¥ä¸‹å­¦ç”Ÿï¼š${notFoundStudents.join('ã€')}`;
            }
          } else {
            message = `âš ï¸ æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½•å°ç»„æ•°æ®${skipped > 0 ? `ï¼ˆè·³è¿‡ ${skipped} è¡Œæ— æ•ˆæ•°æ®ï¼‰` : ''}`;
          }
          
          toast(message);
        } catch (error) {
          console.error('å¯¼å…¥å¤±è´¥:', error);
          alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
        }
      };
      input.click();
    }

    // ==================== åˆå§‹åŒ– ====================
    async function init() {
      loadClasses();
      
      // è®¾ç½®å½“å‰ç­çº§
      const savedClassId = localStorage.getItem(CURRENT_CLASS_KEY);
      if (savedClassId && classes.find(c => c.id === savedClassId)) {
        currentClassId = savedClassId;
      } else {
        currentClassId = classes[0].id;
        localStorage.setItem(CURRENT_CLASS_KEY, currentClassId);
      }
      
      loadState();
      loadMallItems();
      loadRcRecords();
      loadPointHistory();
      loadTheme();
      loadBackgroundSettings();
      refreshClassOptions();
      
      // åŠ è½½å¤‡ä»½æ–‡ä»¶å¤¹å¥æŸ„
      await loadBackupFolderHandle();
      initAlphabetKeyboard();
      initBackgroundControls();
      initRcSpeechSynthesis();
      
      // æ³¨æ„ï¼šä¸å†è‡ªåŠ¨æ¸…ç†å¤´åƒï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ¸…ç†
      // ç”¨æˆ·å¯ä»¥åœ¨è®¾ç½®é¡µé¢ç‚¹å‡»"æ¸…ç†æœªä½¿ç”¨çš„å¤´åƒ"æŒ‰é’®
      
      initEventListeners();
      renderAll();
      
      console.log('âœ… ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿå·²å¯åŠ¨');
      console.log('ğŸ“Š å½“å‰ç­çº§:', getClass().name);
      console.log('ğŸ‘¨â€ğŸ“ å­¦ç”Ÿæ•°é‡:', state.students.length);
      console.log('ğŸ›’ å•†å“æ•°é‡:', mallItems.length);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

